package com.theyawns.framework.saga.orchestrator;

import ch.qos.logback.classic.Level;
import ch.qos.logback.classic.Logger;
import ch.qos.logback.classic.spi.ILoggingEvent;
import ch.qos.logback.core.read.ListAppender;
import com.theyawns.framework.saga.SagaStatus;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.slf4j.LoggerFactory;

import java.time.Instant;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * Tests for {@link LoggingSagaOrchestratorListener}.
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
@DisplayName("LoggingSagaOrchestratorListener - Lifecycle logging")
class LoggingSagaOrchestratorListenerTest {

    private LoggingSagaOrchestratorListener listener;
    private ListAppender<ILoggingEvent> listAppender;
    private Logger logbackLogger;

    @BeforeEach
    void setUp() {
        listener = new LoggingSagaOrchestratorListener();

        logbackLogger = (Logger) LoggerFactory.getLogger(LoggingSagaOrchestratorListener.class);
        listAppender = new ListAppender<>();
        listAppender.start();
        logbackLogger.addAppender(listAppender);
    }

    @AfterEach
    void tearDown() {
        logbackLogger.detachAppender(listAppender);
    }

    @Test
    @DisplayName("should log saga started at INFO level")
    void shouldLogSagaStarted() {
        SagaDefinition definition = SagaDefinition.builder()
                .name("TestSaga")
                .step("Step1").action(ctx -> null).noCompensation().build()
                .build();

        listener.onSagaStarted("saga-1", definition, SagaContext.create());

        assertThat(listAppender.list).anyMatch(event ->
                event.getLevel() == Level.INFO
                        && event.getFormattedMessage().contains("Saga started")
                        && event.getFormattedMessage().contains("saga-1")
        );
    }

    @Test
    @DisplayName("should log step started at INFO level")
    void shouldLogStepStarted() {
        listener.onStepStarted("saga-1", "ReserveStock", 1);

        assertThat(listAppender.list).anyMatch(event ->
                event.getLevel() == Level.INFO
                        && event.getFormattedMessage().contains("Step started")
                        && event.getFormattedMessage().contains("ReserveStock")
        );
    }

    @Test
    @DisplayName("should log step success at INFO level")
    void shouldLogStepSuccess() {
        listener.onStepCompleted("saga-1", "ReserveStock", SagaStepResult.success());

        assertThat(listAppender.list).anyMatch(event ->
                event.getLevel() == Level.INFO
                        && event.getFormattedMessage().contains("Step completed successfully")
                        && event.getFormattedMessage().contains("ReserveStock")
        );
    }

    @Test
    @DisplayName("should log step failure at INFO level with error message")
    void shouldLogStepFailure() {
        listener.onStepCompleted("saga-1", "ProcessPayment",
                SagaStepResult.failure("Insufficient funds"));

        assertThat(listAppender.list).anyMatch(event ->
                event.getLevel() == Level.INFO
                        && event.getFormattedMessage().contains("FAILURE")
                        && event.getFormattedMessage().contains("Insufficient funds")
        );
    }

    @Test
    @DisplayName("should log compensation started at INFO level")
    void shouldLogCompensationStarted() {
        listener.onCompensationStarted("saga-1", "ProcessPayment", 2);

        assertThat(listAppender.list).anyMatch(event ->
                event.getLevel() == Level.INFO
                        && event.getFormattedMessage().contains("Compensation started")
                        && event.getFormattedMessage().contains("ProcessPayment")
        );
    }

    @Test
    @DisplayName("should log compensation step completed at INFO level")
    void shouldLogCompensationStepCompleted() {
        listener.onCompensationStepCompleted("saga-1", "ReserveStock", SagaStepResult.success());

        assertThat(listAppender.list).anyMatch(event ->
                event.getLevel() == Level.INFO
                        && event.getFormattedMessage().contains("Compensation step completed")
                        && event.getFormattedMessage().contains("ReserveStock")
        );
    }

    @Test
    @DisplayName("should log saga completed at INFO level")
    void shouldLogSagaCompleted() {
        SagaOrchestratorResult result = SagaOrchestratorResult.success(
                "saga-1", "TestSaga", Instant.now(), 3);

        listener.onSagaCompleted("saga-1", result);

        assertThat(listAppender.list).anyMatch(event ->
                event.getLevel() == Level.INFO
                        && event.getFormattedMessage().contains("Saga completed")
                        && event.getFormattedMessage().contains("saga-1")
        );
    }
}
