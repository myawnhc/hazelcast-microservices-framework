package com.theyawns.framework.saga;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;

import java.time.Duration;
import java.time.Instant;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Unit tests for SagaTimedOutEvent and TimeoutDetails.
 *
 * @author Generated by Claude Code
 * @since 2.0
 */
@DisplayName("SagaTimedOutEvent - Timeout notification event")
class SagaTimedOutEventTest {

    private SagaState sagaState;
    private SagaTimedOutEvent event;

    @BeforeEach
    void setUp() {
        // Create a saga state that is past its deadline
        sagaState = SagaState.builder()
                .sagaId("saga-123")
                .sagaType("OrderFulfillment")
                .correlationId("corr-456")
                .status(SagaStatus.IN_PROGRESS)
                .startedAt(Instant.now().minus(Duration.ofMinutes(5)))
                .deadline(Instant.now().minus(Duration.ofSeconds(30))) // Past deadline
                .currentStep(2)
                .totalSteps(4)
                .initiatingService("order-service")
                .initiatingEventId("evt-789")
                .build();

        event = new SagaTimedOutEvent(this, sagaState);
    }

    @Nested
    @DisplayName("Event construction")
    class EventConstruction {

        @Test
        @DisplayName("should create event from saga state")
        void shouldCreateEventFromSagaState() {
            assertNotNull(event);
            assertEquals("saga-123", event.getSagaId());
            assertEquals("OrderFulfillment", event.getSagaType());
            assertEquals("corr-456", event.getCorrelationId());
        }

        @Test
        @DisplayName("should reject null saga state")
        void shouldRejectNullSagaState() {
            assertThrows(NullPointerException.class, () ->
                    new SagaTimedOutEvent(this, (SagaState) null));
        }

        @Test
        @DisplayName("should create event from timeout details")
        void shouldCreateEventFromTimeoutDetails() {
            SagaTimedOutEvent.TimeoutDetails details = SagaTimedOutEvent.TimeoutDetails.from(sagaState);
            SagaTimedOutEvent detailsEvent = new SagaTimedOutEvent(this, details);

            assertNotNull(detailsEvent);
            assertEquals("saga-123", detailsEvent.getSagaId());
        }

        @Test
        @DisplayName("should reject null timeout details")
        void shouldRejectNullTimeoutDetails() {
            assertThrows(NullPointerException.class, () ->
                    new SagaTimedOutEvent(this, (SagaTimedOutEvent.TimeoutDetails) null));
        }
    }

    @Nested
    @DisplayName("Event accessors")
    class EventAccessors {

        @Test
        @DisplayName("getSagaId should return saga ID")
        void getSagaIdShouldReturnSagaId() {
            assertEquals("saga-123", event.getSagaId());
        }

        @Test
        @DisplayName("getSagaType should return saga type")
        void getSagaTypeShouldReturnSagaType() {
            assertEquals("OrderFulfillment", event.getSagaType());
        }

        @Test
        @DisplayName("getCorrelationId should return correlation ID")
        void getCorrelationIdShouldReturnCorrelationId() {
            assertEquals("corr-456", event.getCorrelationId());
        }

        @Test
        @DisplayName("getDuration should return positive duration")
        void getDurationShouldReturnPositiveDuration() {
            Duration duration = event.getDuration();
            assertNotNull(duration);
            assertTrue(duration.toMillis() > 0);
        }

        @Test
        @DisplayName("getCurrentStep should return current step")
        void getCurrentStepShouldReturnCurrentStep() {
            assertEquals(2, event.getCurrentStep());
        }

        @Test
        @DisplayName("getTotalSteps should return total steps")
        void getTotalStepsShouldReturnTotalSteps() {
            assertEquals(4, event.getTotalSteps());
        }

        @Test
        @DisplayName("getDetails should return timeout details")
        void getDetailsShouldReturnTimeoutDetails() {
            SagaTimedOutEvent.TimeoutDetails details = event.getDetails();
            assertNotNull(details);
            assertEquals("saga-123", details.sagaId());
        }
    }

    @Nested
    @DisplayName("TimeoutDetails")
    class TimeoutDetailsTest {

        private SagaTimedOutEvent.TimeoutDetails details;

        @BeforeEach
        void setUp() {
            details = SagaTimedOutEvent.TimeoutDetails.from(sagaState);
        }

        @Test
        @DisplayName("from should capture all saga state fields")
        void fromShouldCaptureAllSagaStateFields() {
            assertEquals("saga-123", details.sagaId());
            assertEquals("OrderFulfillment", details.sagaType());
            assertEquals("corr-456", details.correlationId());
            assertEquals(2, details.currentStep());
            assertEquals(4, details.totalSteps());
            assertEquals(SagaStatus.IN_PROGRESS, details.statusAtTimeout());
            assertEquals("order-service", details.initiatingService());
            assertEquals("evt-789", details.initiatingEventId());
        }

        @Test
        @DisplayName("from should set timedOutAt to now")
        void fromShouldSetTimedOutAtToNow() {
            Instant before = Instant.now().minus(Duration.ofMillis(100));
            SagaTimedOutEvent.TimeoutDetails freshDetails = SagaTimedOutEvent.TimeoutDetails.from(sagaState);
            Instant after = Instant.now().plus(Duration.ofMillis(100));

            assertNotNull(freshDetails.timedOutAt());
            assertTrue(freshDetails.timedOutAt().isAfter(before));
            assertTrue(freshDetails.timedOutAt().isBefore(after));
        }

        @Test
        @DisplayName("getProgressPercentage should calculate percentage correctly")
        void getProgressPercentageShouldCalculateCorrectly() {
            // currentStep=2, totalSteps=4 -> 50%
            assertEquals(50, details.getProgressPercentage());
        }

        @Test
        @DisplayName("getProgressPercentage should return 0 for zero total steps")
        void getProgressPercentageShouldReturnZeroForZeroTotalSteps() {
            SagaState zeroStepsSaga = SagaState.builder()
                    .sagaId("saga-zero")
                    .sagaType("Test")
                    .totalSteps(0)
                    .currentStep(0)
                    .build();

            SagaTimedOutEvent.TimeoutDetails zeroDetails = SagaTimedOutEvent.TimeoutDetails.from(zeroStepsSaga);
            assertEquals(0, zeroDetails.getProgressPercentage());
        }

        @Test
        @DisplayName("getOverdueBy should return positive duration when past deadline")
        void getOverdueByShouldReturnPositiveDuration() {
            Duration overdue = details.getOverdueBy();
            assertNotNull(overdue);
            assertTrue(overdue.toMillis() >= 0);
        }

        @Test
        @DisplayName("getOverdueBy should return zero when deadline is null")
        void getOverdueByShouldReturnZeroWhenDeadlineIsNull() {
            SagaState noDeadlineSaga = SagaState.builder()
                    .sagaId("saga-no-deadline")
                    .sagaType("Test")
                    .deadline(null)
                    .build();

            SagaTimedOutEvent.TimeoutDetails noDeadlineDetails =
                    SagaTimedOutEvent.TimeoutDetails.from(noDeadlineSaga);
            assertEquals(Duration.ZERO, noDeadlineDetails.getOverdueBy());
        }

        @Test
        @DisplayName("toString should contain key information")
        void toStringShouldContainKeyInformation() {
            String str = details.toString();

            assertTrue(str.contains("saga-123"));
            assertTrue(str.contains("OrderFulfillment"));
            assertTrue(str.contains("progress="));
            assertTrue(str.contains("duration="));
        }
    }

    @Nested
    @DisplayName("toString")
    class ToStringTest {

        @Test
        @DisplayName("event toString should include details")
        void eventToStringShouldIncludeDetails() {
            String str = event.toString();

            assertTrue(str.contains("SagaTimedOutEvent"));
            assertTrue(str.contains("saga-123"));
        }
    }

    @Nested
    @DisplayName("Topic constant")
    class TopicConstant {

        @Test
        @DisplayName("TIMEOUT_TOPIC should be defined")
        void timeoutTopicShouldBeDefined() {
            assertEquals("saga-timeouts", SagaTimedOutEvent.TIMEOUT_TOPIC);
        }
    }
}
