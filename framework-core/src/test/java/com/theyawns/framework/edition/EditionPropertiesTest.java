package com.theyawns.framework.edition;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

/**
 * Tests for {@link EditionProperties}.
 *
 * <p>Validates default values, setters, and nested configuration classes.
 *
 * @author Generated by Claude Code
 * @since 2.0
 */
@DisplayName("EditionProperties - Configuration property defaults and binding")
class EditionPropertiesTest {

    @Nested
    @DisplayName("Default values")
    class DefaultValues {

        @Test
        @DisplayName("should have auto mode by default")
        void shouldHaveAutoModeByDefault() {
            final EditionProperties props = new EditionProperties();
            assertThat(props.getMode()).isEqualTo("auto");
        }

        @Test
        @DisplayName("should have HZ_LICENSEKEY as default env var")
        void shouldHaveDefaultLicenseEnvVar() {
            final EditionProperties props = new EditionProperties();
            assertThat(props.getLicense().getEnvVar()).isEqualTo("HZ_LICENSEKEY");
        }

        @Test
        @DisplayName("should have warn as default missing behavior")
        void shouldHaveWarnAsDefaultMissingBehavior() {
            final EditionProperties props = new EditionProperties();
            assertThat(props.getLicense().getMissingBehavior()).isEqualTo("warn");
        }

        @Test
        @DisplayName("should have log edition status enabled by default")
        void shouldHaveLogEditionStatusEnabled() {
            final EditionProperties props = new EditionProperties();
            assertThat(props.getObservability().isLogEditionStatus()).isTrue();
        }

        @Test
        @DisplayName("should have log feature status enabled by default")
        void shouldHaveLogFeatureStatusEnabled() {
            final EditionProperties props = new EditionProperties();
            assertThat(props.getObservability().isLogFeatureStatus()).isTrue();
        }

        @Test
        @DisplayName("should have expose in actuator enabled by default")
        void shouldHaveExposeInActuatorEnabled() {
            final EditionProperties props = new EditionProperties();
            assertThat(props.getObservability().isExposeInActuator()).isTrue();
        }

        @Test
        @DisplayName("should have auto as default feature enabled value")
        void shouldHaveAutoAsDefaultFeatureEnabled() {
            final EditionProperties props = new EditionProperties();
            assertThat(props.getFeatures().getVectorStore().getEnabled()).isEqualTo("auto");
            assertThat(props.getFeatures().getCpSubsystem().getEnabled()).isEqualTo("auto");
            assertThat(props.getFeatures().getHotRestart().getEnabled()).isEqualTo("auto");
            assertThat(props.getFeatures().getTls().getEnabled()).isEqualTo("auto");
            assertThat(props.getFeatures().getHdMemory().getEnabled()).isEqualTo("auto");
            assertThat(props.getFeatures().getWanReplication().getEnabled()).isEqualTo("auto");
            assertThat(props.getFeatures().getTpc().getEnabled()).isEqualTo("auto");
        }
    }

    @Nested
    @DisplayName("Feature-specific defaults")
    class FeatureSpecificDefaults {

        @Test
        @DisplayName("should have empty-results as vector store fallback")
        void shouldHaveEmptyResultsFallbackForVectorStore() {
            final EditionProperties props = new EditionProperties();
            assertThat(props.getFeatures().getVectorStore().getFallbackBehavior())
                    .isEqualTo("empty-results");
        }

        @Test
        @DisplayName("should have optimistic as cp subsystem fallback")
        void shouldHaveOptimisticFallbackForCpSubsystem() {
            final EditionProperties props = new EditionProperties();
            assertThat(props.getFeatures().getCpSubsystem().getFallbackBehavior())
                    .isEqualTo("optimistic");
        }

        @Test
        @DisplayName("should have mapstore as hot restart fallback")
        void shouldHaveMapstoreFallbackForHotRestart() {
            final EditionProperties props = new EditionProperties();
            assertThat(props.getFeatures().getHotRestart().getFallbackBehavior())
                    .isEqualTo("mapstore");
        }

        @Test
        @DisplayName("should have correct HD Memory extended defaults")
        void shouldHaveCorrectHdMemoryExtendedDefaults() {
            final EditionProperties props = new EditionProperties();
            final EditionProperties.HdMemoryFeatureConfig hdConfig = props.getFeatures().getHdMemory();
            assertThat(hdConfig.getCapacityMb()).isEqualTo(512);
            assertThat(hdConfig.getAllocatorType()).isEqualTo("POOLED");
            assertThat(hdConfig.getFallbackBehavior()).isEqualTo("on-heap");
        }

        @Test
        @DisplayName("should have correct TPC defaults")
        void shouldHaveCorrectTpcDefaults() {
            final EditionProperties props = new EditionProperties();
            final EditionProperties.TpcFeatureConfig tpcConfig = props.getFeatures().getTpc();
            assertThat(tpcConfig.getEventloopCount()).isZero();
            assertThat(tpcConfig.isClientEnabled()).isTrue();
            assertThat(tpcConfig.getFallbackBehavior()).isEqualTo("standard-threading");
        }
    }

    @Nested
    @DisplayName("Setters and validation")
    class SettersAndValidation {

        @Test
        @DisplayName("should update edition mode")
        void shouldUpdateEditionMode() {
            final EditionProperties props = new EditionProperties();
            props.getEdition().setMode("enterprise");
            assertThat(props.getMode()).isEqualTo("enterprise");
        }

        @Test
        @DisplayName("should reject null mode")
        void shouldRejectNullMode() {
            final EditionProperties.EditionConfig config = new EditionProperties.EditionConfig();
            assertThatThrownBy(() -> config.setMode(null))
                    .isInstanceOf(NullPointerException.class)
                    .hasMessageContaining("mode cannot be null");
        }

        @Test
        @DisplayName("should reject null envVar")
        void shouldRejectNullEnvVar() {
            final EditionProperties.LicenseConfig config = new EditionProperties.LicenseConfig();
            assertThatThrownBy(() -> config.setEnvVar(null))
                    .isInstanceOf(NullPointerException.class)
                    .hasMessageContaining("envVar cannot be null");
        }

        @Test
        @DisplayName("should reject null feature enabled value")
        void shouldRejectNullFeatureEnabled() {
            final EditionProperties.FeatureConfig config = new EditionProperties.FeatureConfig();
            assertThatThrownBy(() -> config.setEnabled(null))
                    .isInstanceOf(NullPointerException.class)
                    .hasMessageContaining("enabled cannot be null");
        }

        @Test
        @DisplayName("should handle null edition gracefully")
        void shouldHandleNullEditionGracefully() {
            final EditionProperties props = new EditionProperties();
            props.setEdition(null);
            assertThat(props.getEdition()).isNotNull();
            assertThat(props.getMode()).isEqualTo("auto");
        }

        @Test
        @DisplayName("should handle null features gracefully")
        void shouldHandleNullFeaturesGracefully() {
            final EditionProperties props = new EditionProperties();
            props.setFeatures(null);
            assertThat(props.getFeatures()).isNotNull();
        }

        @Test
        @DisplayName("should handle null observability gracefully")
        void shouldHandleNullObservabilityGracefully() {
            final EditionProperties props = new EditionProperties();
            props.setObservability(null);
            assertThat(props.getObservability()).isNotNull();
        }
    }

    @Nested
    @DisplayName("FeaturesConfig.getConfigFor")
    class GetConfigFor {

        @Test
        @DisplayName("should return correct config for each feature")
        void shouldReturnCorrectConfigForEachFeature() {
            final EditionProperties props = new EditionProperties();
            final EditionProperties.FeaturesConfig features = props.getFeatures();

            assertThat(features.getConfigFor(EditionDetector.EnterpriseFeature.VECTOR_STORE))
                    .isSameAs(features.getVectorStore());
            assertThat(features.getConfigFor(EditionDetector.EnterpriseFeature.CP_SUBSYSTEM))
                    .isSameAs(features.getCpSubsystem());
            assertThat(features.getConfigFor(EditionDetector.EnterpriseFeature.HOT_RESTART))
                    .isSameAs(features.getHotRestart());
            assertThat(features.getConfigFor(EditionDetector.EnterpriseFeature.TLS))
                    .isSameAs(features.getTls());
            assertThat(features.getConfigFor(EditionDetector.EnterpriseFeature.HD_MEMORY))
                    .isSameAs(features.getHdMemory());
            assertThat(features.getConfigFor(EditionDetector.EnterpriseFeature.THREAD_PER_CORE))
                    .isSameAs(features.getTpc());
            assertThat(features.getConfigFor(EditionDetector.EnterpriseFeature.WAN_REPLICATION))
                    .isSameAs(features.getWanReplication());
        }
    }

    @Nested
    @DisplayName("toString")
    class ToStringTests {

        @Test
        @DisplayName("should include mode and env var in toString")
        void shouldIncludeModeAndEnvVarInToString() {
            final EditionProperties props = new EditionProperties();
            final String result = props.toString();
            assertThat(result).contains("mode='auto'");
            assertThat(result).contains("licenseEnvVar='HZ_LICENSEKEY'");
        }

        @Test
        @DisplayName("FeatureConfig toString should include enabled and fallback")
        void featureConfigToStringShouldIncludeEnabledAndFallback() {
            final EditionProperties.FeatureConfig config =
                    new EditionProperties.FeatureConfig("true", "empty-results");
            final String result = config.toString();
            assertThat(result).contains("enabled='true'");
            assertThat(result).contains("fallbackBehavior='empty-results'");
        }
    }
}
