package com.theyawns.framework.persistence.mapstore;

import com.hazelcast.nio.serialization.genericrecord.GenericRecord;
import com.hazelcast.nio.serialization.genericrecord.GenericRecordBuilder;
import com.theyawns.framework.persistence.PersistableView;
import com.theyawns.framework.persistence.ViewStorePersistence;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Properties;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

/**
 * Unit tests for {@link ViewStoreMapStore}.
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
@DisplayName("ViewStoreMapStore - MapStore adapter for view persistence")
@ExtendWith(MockitoExtension.class)
class ViewStoreMapStoreTest {

    @Mock
    private ViewStorePersistence persistence;

    private ViewStoreMapStore mapStore;

    @BeforeEach
    void setUp() {
        mapStore = new ViewStoreMapStore(persistence);
    }

    @Test
    @DisplayName("should store a single view entry via persistence provider")
    void shouldStoreSingleView() {
        // Arrange
        GenericRecord record = GenericRecordBuilder.compact("CustomerView")
                .setString("name", "John Doe")
                .setString("email", "john@example.com")
                .build();

        // Act
        mapStore.store("cust-001", record);

        // Assert
        ArgumentCaptor<PersistableView> captor = ArgumentCaptor.forClass(PersistableView.class);
        verify(persistence).persist(isNull(), captor.capture());

        PersistableView view = captor.getValue();
        assertEquals("cust-001", view.viewKey());
        assertNotNull(view.viewData());
        assertTrue(view.lastUpdatedMillis() > 0);
    }

    @Test
    @DisplayName("should batch store multiple view entries")
    void shouldBatchStoreViews() {
        // Arrange
        Map<String, GenericRecord> entries = new HashMap<>();
        entries.put("cust-001", GenericRecordBuilder.compact("View").setString("name", "A").build());
        entries.put("cust-002", GenericRecordBuilder.compact("View").setString("name", "B").build());

        // Act
        mapStore.storeAll(entries);

        // Assert
        @SuppressWarnings("unchecked")
        ArgumentCaptor<List<PersistableView>> captor = ArgumentCaptor.forClass(List.class);
        verify(persistence).persistBatch(isNull(), captor.capture());
        assertEquals(2, captor.getValue().size());
    }

    @Test
    @DisplayName("should not persist empty batch")
    void shouldNotPersistEmptyBatch() {
        // Act
        mapStore.storeAll(Map.of());

        // Assert
        verifyNoInteractions(persistence);
    }

    @Test
    @DisplayName("should load view from persistence and convert from JSON")
    void shouldLoadView() {
        // Arrange
        GenericRecord original = GenericRecordBuilder.compact("CustomerView")
                .setString("name", "Test")
                .setInt32("age", 30)
                .build();
        String json = GenericRecordJsonConverter.toJson(original);

        PersistableView pv = new PersistableView("cust-001", json, System.currentTimeMillis());
        when(persistence.loadView(isNull(), eq("cust-001")))
                .thenReturn(Optional.of(pv));

        // Act
        GenericRecord loaded = mapStore.load("cust-001");

        // Assert
        assertNotNull(loaded);
        assertEquals("Test", loaded.getString("name"));
        assertEquals(30, loaded.getInt32("age"));
    }

    @Test
    @DisplayName("should return null when view not found")
    void shouldReturnNullWhenNotFound() {
        // Arrange
        when(persistence.loadView(isNull(), anyString())).thenReturn(Optional.empty());

        // Act
        GenericRecord result = mapStore.load("nonexistent");

        // Assert
        assertNull(result);
    }

    @Test
    @DisplayName("should delegate loadAllKeys to persistence")
    void shouldDelegateLoadAllKeys() {
        // Arrange
        when(persistence.loadAllKeys(isNull())).thenReturn(List.of("k1", "k2", "k3"));

        // Act
        Iterable<String> keys = mapStore.loadAllKeys();

        // Assert
        List<String> keyList = new java.util.ArrayList<>();
        keys.forEach(keyList::add);
        assertEquals(3, keyList.size());
        assertTrue(keyList.contains("k1"));
    }

    @Test
    @DisplayName("should load all views for given keys")
    void shouldLoadAllViews() {
        // Arrange
        GenericRecord rec1 = GenericRecordBuilder.compact("V").setString("v", "1").build();
        GenericRecord rec2 = GenericRecordBuilder.compact("V").setString("v", "2").build();

        when(persistence.loadView(isNull(), eq("k1")))
                .thenReturn(Optional.of(new PersistableView("k1",
                        GenericRecordJsonConverter.toJson(rec1), 100L)));
        when(persistence.loadView(isNull(), eq("k2")))
                .thenReturn(Optional.of(new PersistableView("k2",
                        GenericRecordJsonConverter.toJson(rec2), 200L)));

        // Act
        Map<String, GenericRecord> result = mapStore.loadAll(List.of("k1", "k2"));

        // Assert
        assertEquals(2, result.size());
        assertEquals("1", result.get("k1").getString("v"));
        assertEquals("2", result.get("k2").getString("v"));
    }

    @Test
    @DisplayName("should skip missing entries in loadAll")
    void shouldSkipMissingInLoadAll() {
        // Arrange
        GenericRecord rec1 = GenericRecordBuilder.compact("V").setString("v", "1").build();
        when(persistence.loadView(isNull(), eq("k1")))
                .thenReturn(Optional.of(new PersistableView("k1",
                        GenericRecordJsonConverter.toJson(rec1), 100L)));
        when(persistence.loadView(isNull(), eq("k2")))
                .thenReturn(Optional.empty());

        // Act
        Map<String, GenericRecord> result = mapStore.loadAll(List.of("k1", "k2"));

        // Assert
        assertEquals(1, result.size());
        assertTrue(result.containsKey("k1"));
        assertFalse(result.containsKey("k2"));
    }

    @Test
    @DisplayName("should delete view via persistence provider")
    void shouldDeleteView() {
        // Act
        mapStore.delete("cust-001");

        // Assert
        verify(persistence).delete(isNull(), eq("cust-001"));
    }

    @Test
    @DisplayName("should delete all views via persistence provider")
    void shouldDeleteAllViews() {
        // Act
        mapStore.deleteAll(List.of("k1", "k2", "k3"));

        // Assert
        verify(persistence).delete(isNull(), eq("k1"));
        verify(persistence).delete(isNull(), eq("k2"));
        verify(persistence).delete(isNull(), eq("k3"));
    }

    @Test
    @DisplayName("should reject null persistence provider")
    void shouldRejectNullPersistence() {
        assertThrows(IllegalArgumentException.class, () -> new ViewStoreMapStore(null));
    }

    @Test
    @DisplayName("should set mapName on init")
    void shouldSetMapNameOnInit() {
        // Act
        mapStore.init(null, new Properties(), "Customer_VIEW");

        // Now store â€” verify mapName is passed through
        GenericRecord record = GenericRecordBuilder.compact("V").setString("v", "x").build();
        mapStore.store("k1", record);

        // Assert
        ArgumentCaptor<PersistableView> captor = ArgumentCaptor.forClass(PersistableView.class);
        verify(persistence).persist(eq("Customer_VIEW"), captor.capture());
        assertEquals("k1", captor.getValue().viewKey());
    }
}
