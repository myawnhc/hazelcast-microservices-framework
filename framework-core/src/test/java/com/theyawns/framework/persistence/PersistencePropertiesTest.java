package com.theyawns.framework.persistence;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Unit tests for {@link PersistenceProperties}.
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
@DisplayName("PersistenceProperties - Configuration binding and validation")
class PersistencePropertiesTest {

    @Test
    @DisplayName("should have correct default values")
    void shouldHaveCorrectDefaultValues() {
        PersistenceProperties props = new PersistenceProperties();

        assertFalse(props.isEnabled());
        assertEquals(5, props.getWriteDelaySeconds());
        assertEquals(100, props.getWriteBatchSize());
        assertFalse(props.isWriteCoalescing());
        assertEquals(PersistenceProperties.InitialLoadMode.LAZY, props.getInitialLoadMode());
    }

    @Test
    @DisplayName("should allow setting all properties")
    void shouldAllowSettingAllProperties() {
        PersistenceProperties props = new PersistenceProperties();

        props.setEnabled(true);
        props.setWriteDelaySeconds(10);
        props.setWriteBatchSize(200);
        props.setWriteCoalescing(true);
        props.setInitialLoadMode(PersistenceProperties.InitialLoadMode.EAGER);

        assertTrue(props.isEnabled());
        assertEquals(10, props.getWriteDelaySeconds());
        assertEquals(200, props.getWriteBatchSize());
        assertTrue(props.isWriteCoalescing());
        assertEquals(PersistenceProperties.InitialLoadMode.EAGER, props.getInitialLoadMode());
    }

    @Test
    @DisplayName("should reject negative writeDelaySeconds")
    void shouldRejectNegativeWriteDelaySeconds() {
        PersistenceProperties props = new PersistenceProperties();

        assertThrows(IllegalArgumentException.class, () -> props.setWriteDelaySeconds(-1));
    }

    @Test
    @DisplayName("should allow zero writeDelaySeconds for write-through mode")
    void shouldAllowZeroWriteDelaySeconds() {
        PersistenceProperties props = new PersistenceProperties();

        props.setWriteDelaySeconds(0);
        assertEquals(0, props.getWriteDelaySeconds());
    }

    @Test
    @DisplayName("should reject zero writeBatchSize")
    void shouldRejectZeroWriteBatchSize() {
        PersistenceProperties props = new PersistenceProperties();

        assertThrows(IllegalArgumentException.class, () -> props.setWriteBatchSize(0));
    }

    @Test
    @DisplayName("should reject null initialLoadMode")
    void shouldRejectNullInitialLoadMode() {
        PersistenceProperties props = new PersistenceProperties();

        assertThrows(IllegalArgumentException.class, () -> props.setInitialLoadMode(null));
    }

    @Test
    @DisplayName("should produce meaningful toString")
    void shouldProduceMeaningfulToString() {
        PersistenceProperties props = new PersistenceProperties();
        String str = props.toString();

        assertTrue(str.contains("enabled=false"));
        assertTrue(str.contains("writeDelaySeconds=5"));
        assertTrue(str.contains("writeBatchSize=100"));
        assertTrue(str.contains("writeCoalescing=false"));
        assertTrue(str.contains("LAZY"));
        assertTrue(str.contains("eventStoreEviction="));
        assertTrue(str.contains("viewStoreEviction="));
    }

    // ========================================================================
    // Eviction config tests
    // ========================================================================

    @Test
    @DisplayName("should have correct default eviction values for event store")
    void shouldHaveCorrectEventStoreEvictionDefaults() {
        PersistenceProperties props = new PersistenceProperties();
        PersistenceProperties.EvictionConfig eviction = props.getEventStoreEviction();

        assertTrue(eviction.isEnabled());
        assertEquals(10000, eviction.getMaxSize());
        assertEquals("PER_NODE", eviction.getMaxSizePolicy());
        assertEquals("LRU", eviction.getEvictionPolicy());
        assertEquals(0, eviction.getMaxIdleSeconds());
    }

    @Test
    @DisplayName("should have maxIdleSeconds=3600 for view store eviction by default")
    void shouldHaveViewStoreMaxIdleDefault() {
        PersistenceProperties props = new PersistenceProperties();
        PersistenceProperties.EvictionConfig eviction = props.getViewStoreEviction();

        assertTrue(eviction.isEnabled());
        assertEquals(3600, eviction.getMaxIdleSeconds());
    }

    @Test
    @DisplayName("should allow setting eviction config properties")
    void shouldAllowSettingEvictionProperties() {
        PersistenceProperties.EvictionConfig eviction = new PersistenceProperties.EvictionConfig();

        eviction.setEnabled(false);
        eviction.setMaxSize(5000);
        eviction.setMaxSizePolicy("USED_HEAP_PERCENTAGE");
        eviction.setEvictionPolicy("LFU");
        eviction.setMaxIdleSeconds(1800);

        assertFalse(eviction.isEnabled());
        assertEquals(5000, eviction.getMaxSize());
        assertEquals("USED_HEAP_PERCENTAGE", eviction.getMaxSizePolicy());
        assertEquals("LFU", eviction.getEvictionPolicy());
        assertEquals(1800, eviction.getMaxIdleSeconds());
    }

    @Test
    @DisplayName("should allow replacing eviction config on properties")
    void shouldAllowReplacingEvictionConfig() {
        PersistenceProperties props = new PersistenceProperties();
        PersistenceProperties.EvictionConfig custom = new PersistenceProperties.EvictionConfig(7200);
        custom.setMaxSize(20000);

        props.setEventStoreEviction(custom);

        assertEquals(20000, props.getEventStoreEviction().getMaxSize());
        assertEquals(7200, props.getEventStoreEviction().getMaxIdleSeconds());
    }

    @Test
    @DisplayName("should produce meaningful eviction toString")
    void shouldProduceEvictionToString() {
        PersistenceProperties.EvictionConfig eviction = new PersistenceProperties.EvictionConfig();
        String str = eviction.toString();

        assertTrue(str.contains("enabled=true"));
        assertTrue(str.contains("maxSize=10000"));
        assertTrue(str.contains("PER_NODE"));
        assertTrue(str.contains("LRU"));
    }
}
