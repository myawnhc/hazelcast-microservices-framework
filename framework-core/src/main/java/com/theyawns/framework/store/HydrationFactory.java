package com.theyawns.framework.store;

import com.hazelcast.nio.serialization.genericrecord.GenericRecord;
import com.theyawns.framework.domain.DomainObject;
import com.theyawns.framework.event.DomainEvent;

import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.concurrent.ConcurrentHashMap;
import java.util.function.Function;

/**
 * Factory for hydrating (deserializing) events and domain objects from GenericRecords.
 * Provides a registry-based approach where each event type registers its hydration function.
 *
 * <p>Key responsibilities:
 * <ul>
 *   <li>Register hydration functions for event types</li>
 *   <li>Register hydration functions for domain object types</li>
 *   <li>Hydrate GenericRecords back to typed objects</li>
 *   <li>Support schema evolution through GenericRecord flexibility</li>
 * </ul>
 *
 * <p>Example usage:
 * <pre>{@code
 * // Create factory and register event hydrators
 * HydrationFactory<Customer, String> factory = new HydrationFactory<>();
 * factory.registerEventHydrator("CustomerCreated", CustomerCreatedEvent::fromGenericRecord);
 * factory.registerEventHydrator("CustomerUpdated", CustomerUpdatedEvent::fromGenericRecord);
 *
 * // Register domain object hydrator
 * factory.registerDomainObjectHydrator(Customer::fromGenericRecord);
 *
 * // Hydrate an event from GenericRecord
 * GenericRecord record = eventStore.get(key);
 * DomainEvent<Customer, String> event = factory.hydrateEvent(record);
 * }</pre>
 *
 * @param <D> The domain object type
 * @param <K> The domain object key type
 * @author Generated by Claude Code
 * @since 1.0
 */
public class HydrationFactory<D extends DomainObject<K>, K> {

    /**
     * Registry of event hydrators keyed by event type.
     */
    private final Map<String, Function<GenericRecord, ? extends DomainEvent<D, K>>> eventHydrators;

    /**
     * Hydrator function for the domain object.
     */
    private Function<GenericRecord, D> domainObjectHydrator;

    /**
     * Creates a new HydrationFactory with empty registries.
     */
    public HydrationFactory() {
        this.eventHydrators = new ConcurrentHashMap<>();
    }

    /**
     * Registers a hydration function for a specific event type.
     *
     * @param eventType the event type identifier (e.g., "CustomerCreated")
     * @param hydrator the function to convert GenericRecord to the event
     * @param <E> the specific event type
     * @return this factory for fluent chaining
     */
    public <E extends DomainEvent<D, K>> HydrationFactory<D, K> registerEventHydrator(
            String eventType,
            Function<GenericRecord, E> hydrator) {
        Objects.requireNonNull(eventType, "eventType cannot be null");
        Objects.requireNonNull(hydrator, "hydrator cannot be null");
        eventHydrators.put(eventType, hydrator);
        return this;
    }

    /**
     * Registers the hydration function for the domain object.
     *
     * @param hydrator the function to convert GenericRecord to the domain object
     * @return this factory for fluent chaining
     */
    public HydrationFactory<D, K> registerDomainObjectHydrator(Function<GenericRecord, D> hydrator) {
        Objects.requireNonNull(hydrator, "hydrator cannot be null");
        this.domainObjectHydrator = hydrator;
        return this;
    }

    /**
     * Hydrates a GenericRecord to a typed DomainEvent.
     * The event type is determined from the "eventType" field in the record.
     *
     * @param record the GenericRecord to hydrate
     * @return the hydrated event
     * @throws IllegalArgumentException if no hydrator is registered for the event type
     * @throws IllegalStateException if the record has no eventType field
     */
    public DomainEvent<D, K> hydrateEvent(GenericRecord record) {
        Objects.requireNonNull(record, "record cannot be null");

        String eventType;
        try {
            eventType = record.getString("eventType");
        } catch (Exception e) {
            throw new IllegalStateException("GenericRecord has no 'eventType' field", e);
        }

        if (eventType == null) {
            throw new IllegalStateException("GenericRecord has no 'eventType' field");
        }

        Function<GenericRecord, ? extends DomainEvent<D, K>> hydrator = eventHydrators.get(eventType);
        if (hydrator == null) {
            throw new IllegalArgumentException("No hydrator registered for event type: " + eventType);
        }

        return hydrator.apply(record);
    }

    /**
     * Attempts to hydrate a GenericRecord to a typed DomainEvent.
     * Returns empty if the event type is not registered.
     *
     * @param record the GenericRecord to hydrate
     * @return Optional containing the hydrated event, or empty if type not registered
     */
    public Optional<DomainEvent<D, K>> tryHydrateEvent(GenericRecord record) {
        Objects.requireNonNull(record, "record cannot be null");

        String eventType;
        try {
            eventType = record.getString("eventType");
        } catch (Exception e) {
            return Optional.empty();
        }

        if (eventType == null) {
            return Optional.empty();
        }

        Function<GenericRecord, ? extends DomainEvent<D, K>> hydrator = eventHydrators.get(eventType);
        if (hydrator == null) {
            return Optional.empty();
        }

        return Optional.of(hydrator.apply(record));
    }

    /**
     * Hydrates a GenericRecord to a typed DomainObject.
     *
     * @param record the GenericRecord to hydrate
     * @return the hydrated domain object
     * @throws IllegalStateException if no domain object hydrator is registered
     */
    public D hydrateDomainObject(GenericRecord record) {
        Objects.requireNonNull(record, "record cannot be null");

        if (domainObjectHydrator == null) {
            throw new IllegalStateException("No domain object hydrator registered");
        }

        return domainObjectHydrator.apply(record);
    }

    /**
     * Attempts to hydrate a GenericRecord to a typed DomainObject.
     * Returns empty if no hydrator is registered.
     *
     * @param record the GenericRecord to hydrate
     * @return Optional containing the hydrated domain object, or empty if no hydrator
     */
    public Optional<D> tryHydrateDomainObject(GenericRecord record) {
        Objects.requireNonNull(record, "record cannot be null");

        if (domainObjectHydrator == null) {
            return Optional.empty();
        }

        return Optional.of(domainObjectHydrator.apply(record));
    }

    /**
     * Checks if a hydrator is registered for the given event type.
     *
     * @param eventType the event type to check
     * @return true if a hydrator is registered
     */
    public boolean hasEventHydrator(String eventType) {
        return eventHydrators.containsKey(eventType);
    }

    /**
     * Checks if a domain object hydrator is registered.
     *
     * @return true if a domain object hydrator is registered
     */
    public boolean hasDomainObjectHydrator() {
        return domainObjectHydrator != null;
    }

    /**
     * Returns the set of registered event types.
     *
     * @return unmodifiable set of event type names
     */
    public java.util.Set<String> getRegisteredEventTypes() {
        return java.util.Collections.unmodifiableSet(eventHydrators.keySet());
    }

    /**
     * Clears all registered hydrators.
     */
    public void clear() {
        eventHydrators.clear();
        domainObjectHydrator = null;
    }
}
