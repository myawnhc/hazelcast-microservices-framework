package com.theyawns.framework.resilience;

import io.github.resilience4j.retry.RetryRegistry;
import io.github.resilience4j.retry.event.RetryOnErrorEvent;
import io.github.resilience4j.retry.event.RetryOnIgnoredErrorEvent;
import io.github.resilience4j.retry.event.RetryOnRetryEvent;
import io.github.resilience4j.retry.event.RetryOnSuccessEvent;
import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Observability listener that hooks into the {@link RetryRegistry} to log retry events
 * and publish custom Micrometer metrics.
 *
 * <p>Registers with {@link RetryRegistry#getEventPublisher()} to auto-hook every
 * retry instance that is created. For each retry instance, listens to four event types:
 * <ul>
 *   <li>{@code onRetry} — WARN log for each retry attempt</li>
 *   <li>{@code onSuccess} — INFO log when the operation eventually succeeds</li>
 *   <li>{@code onError} — ERROR log when all retry attempts are exhausted</li>
 *   <li>{@code onIgnoredError} — INFO log for non-retryable exceptions that skip retry</li>
 * </ul>
 *
 * <p>Publishes a {@code framework.resilience.retry.ignored} counter (tagged by retry name)
 * for non-retryable exceptions. This complements {@code TaggedRetryMetrics} which does not
 * track ignored errors.
 *
 * @author Generated by Claude Code
 * @since 3.0
 * @see NonRetryableException
 * @see ResilienceAutoConfiguration
 */
public class RetryEventListener {

    private static final Logger logger = LoggerFactory.getLogger(RetryEventListener.class);

    /**
     * Micrometer registry for publishing custom counters.
     */
    private final MeterRegistry meterRegistry;

    /**
     * Creates a new RetryEventListener and registers it with the retry registry.
     *
     * @param retryRegistry the retry registry to observe
     * @param meterRegistry the Micrometer meter registry for custom metrics
     */
    public RetryEventListener(final RetryRegistry retryRegistry, final MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;

        // Hook into all existing retry instances
        retryRegistry.getAllRetries().forEach(this::registerListeners);

        // Hook into future retry instances as they are created
        retryRegistry.getEventPublisher().onEntryAdded(
                event -> registerListeners(event.getAddedEntry()));

        logger.info("RetryEventListener registered with RetryRegistry");
    }

    /**
     * Registers event listeners on a single retry instance.
     *
     * @param retry the retry instance to observe
     */
    private void registerListeners(final io.github.resilience4j.retry.Retry retry) {
        final var eventPublisher = retry.getEventPublisher();

        eventPublisher.onRetry(this::onRetry);
        eventPublisher.onSuccess(this::onSuccess);
        eventPublisher.onError(this::onError);
        eventPublisher.onIgnoredError(this::onIgnoredError);

        logger.debug("Registered retry event listeners for '{}'", retry.getName());
    }

    /**
     * Handles a retry attempt event.
     *
     * @param event the retry event
     */
    private void onRetry(final RetryOnRetryEvent event) {
        logger.warn("Retry attempt #{} for '{}': {}",
                event.getNumberOfRetryAttempts(),
                event.getName(),
                event.getLastThrowable().getMessage());
    }

    /**
     * Handles a successful outcome event.
     *
     * @param event the success event
     */
    private void onSuccess(final RetryOnSuccessEvent event) {
        logger.info("'{}' succeeded after {} attempt(s)",
                event.getName(),
                event.getNumberOfRetryAttempts());
    }

    /**
     * Handles a final error event (all retries exhausted).
     *
     * @param event the error event
     */
    private void onError(final RetryOnErrorEvent event) {
        logger.error("'{}' failed after all retry attempts: {}",
                event.getName(),
                event.getLastThrowable().getMessage());
    }

    /**
     * Handles an ignored error event (non-retryable exception).
     *
     * <p>Increments the {@code framework.resilience.retry.ignored} counter tagged
     * with the retry instance name.
     *
     * @param event the ignored error event
     */
    private void onIgnoredError(final RetryOnIgnoredErrorEvent event) {
        logger.info("Non-retryable exception for '{}', skipping retry: {}",
                event.getName(),
                event.getLastThrowable().getMessage());

        Counter.builder("framework.resilience.retry.ignored")
                .description("Count of non-retryable exceptions that skipped retry")
                .tag("name", event.getName())
                .register(meterRegistry)
                .increment();
    }
}
