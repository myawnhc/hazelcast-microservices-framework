package com.theyawns.framework.saga;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.context.properties.bind.DefaultValue;

import java.time.Duration;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

/**
 * Configuration properties for saga timeout detection.
 *
 * <p>Provides configurable settings for:
 * <ul>
 *   <li>Check interval - how often to scan for timed-out sagas</li>
 *   <li>Default deadline - fallback timeout for sagas without specific configuration</li>
 *   <li>Saga-type specific timeouts - per-saga-type override settings</li>
 *   <li>Enabled flag - whether timeout detection is active</li>
 * </ul>
 *
 * <p>Example configuration in application.yml:
 * <pre>{@code
 * saga:
 *   timeout:
 *     enabled: true
 *     check-interval: 5s
 *     default-deadline: 30s
 *     saga-types:
 *       OrderFulfillment: 60s
 *       PaymentProcessing: 45s
 * }</pre>
 *
 * @author Generated by Claude Code
 * @since 2.0
 * @see SagaTimeoutDetector
 */
@ConfigurationProperties(prefix = "saga.timeout")
public class SagaTimeoutConfig {

    /**
     * Whether saga timeout detection is enabled.
     * Default: true
     */
    private boolean enabled = true;

    /**
     * How often to check for timed-out sagas.
     * Default: 5 seconds
     */
    private Duration checkInterval = Duration.ofSeconds(5);

    /**
     * Default timeout duration for sagas without specific configuration.
     * Default: 30 seconds
     */
    private Duration defaultDeadline = Duration.ofSeconds(30);

    /**
     * Saga-type specific timeout configurations.
     * Key: saga type name (e.g., "OrderFulfillment")
     * Value: timeout duration for that saga type
     */
    private Map<String, Duration> sagaTypes = new HashMap<>();

    /**
     * Maximum number of sagas to process in a single timeout check cycle.
     * Prevents overwhelming the system when many sagas time out simultaneously.
     * Default: 100
     */
    private int maxBatchSize = 100;

    /**
     * Whether to automatically trigger compensation for timed-out sagas.
     * If false, sagas are marked as timed out but compensation must be triggered manually.
     * Default: true
     */
    private boolean autoCompensate = true;

    /**
     * Whether periodic purging of completed sagas is enabled.
     * When enabled, terminal sagas older than {@link #purgeOlderThan} are removed
     * from the saga state store to prevent unbounded memory growth.
     * Default: true
     */
    private boolean purgeEnabled = true;

    /**
     * Minimum age of terminal sagas before they are eligible for purging.
     * Only sagas in terminal states (COMPLETED, COMPENSATED, FAILED, TIMED_OUT)
     * older than this duration will be removed.
     * Default: 10 minutes
     */
    private Duration purgeOlderThan = Duration.ofMinutes(10);

    /**
     * Number of timeout check cycles between purge runs.
     * Purge runs every {@code purgeIntervalChecks * checkInterval}.
     * Default: 60 (with 5s check interval = purge every 5 minutes)
     */
    private int purgeIntervalChecks = 60;

    /**
     * Creates a new SagaTimeoutConfig with default values.
     */
    public SagaTimeoutConfig() {
        // Default constructor
    }

    /**
     * Creates a new SagaTimeoutConfig with specified values.
     *
     * @param enabled whether timeout detection is enabled
     * @param checkInterval how often to check for timeouts
     * @param defaultDeadline default timeout duration
     */
    public SagaTimeoutConfig(
            @DefaultValue("true") boolean enabled,
            @DefaultValue("5s") Duration checkInterval,
            @DefaultValue("30s") Duration defaultDeadline) {
        this.enabled = enabled;
        this.checkInterval = checkInterval;
        this.defaultDeadline = defaultDeadline;
    }

    /**
     * Returns whether timeout detection is enabled.
     *
     * @return true if enabled
     */
    public boolean isEnabled() {
        return enabled;
    }

    /**
     * Sets whether timeout detection is enabled.
     *
     * @param enabled true to enable timeout detection
     */
    public void setEnabled(boolean enabled) {
        this.enabled = enabled;
    }

    /**
     * Returns the check interval duration.
     *
     * @return check interval
     */
    public Duration getCheckInterval() {
        return checkInterval;
    }

    /**
     * Sets the check interval duration.
     *
     * @param checkInterval how often to check for timed-out sagas
     */
    public void setCheckInterval(Duration checkInterval) {
        this.checkInterval = Objects.requireNonNull(checkInterval, "checkInterval cannot be null");
    }

    /**
     * Returns the check interval in milliseconds for use with @Scheduled.
     *
     * @return check interval in milliseconds
     */
    public long getCheckIntervalMillis() {
        return checkInterval.toMillis();
    }

    /**
     * Returns the default deadline duration.
     *
     * @return default deadline
     */
    public Duration getDefaultDeadline() {
        return defaultDeadline;
    }

    /**
     * Sets the default deadline duration.
     *
     * @param defaultDeadline the default timeout for sagas
     */
    public void setDefaultDeadline(Duration defaultDeadline) {
        this.defaultDeadline = Objects.requireNonNull(defaultDeadline, "defaultDeadline cannot be null");
    }

    /**
     * Returns the saga-type specific timeout configurations.
     *
     * @return map of saga type to timeout duration
     */
    public Map<String, Duration> getSagaTypes() {
        return sagaTypes;
    }

    /**
     * Sets the saga-type specific timeout configurations.
     *
     * @param sagaTypes map of saga type to timeout duration
     */
    public void setSagaTypes(Map<String, Duration> sagaTypes) {
        this.sagaTypes = sagaTypes != null ? sagaTypes : new HashMap<>();
    }

    /**
     * Returns the timeout for a specific saga type, falling back to default if not configured.
     *
     * @param sagaType the saga type
     * @return the timeout duration for the saga type
     */
    public Duration getTimeoutForSagaType(String sagaType) {
        return sagaTypes.getOrDefault(sagaType, defaultDeadline);
    }

    /**
     * Returns the maximum batch size for timeout processing.
     *
     * @return max batch size
     */
    public int getMaxBatchSize() {
        return maxBatchSize;
    }

    /**
     * Sets the maximum batch size for timeout processing.
     *
     * @param maxBatchSize max number of sagas to process per cycle
     */
    public void setMaxBatchSize(int maxBatchSize) {
        if (maxBatchSize < 1) {
            throw new IllegalArgumentException("maxBatchSize must be at least 1");
        }
        this.maxBatchSize = maxBatchSize;
    }

    /**
     * Returns whether auto-compensation is enabled.
     *
     * @return true if compensation is automatic
     */
    public boolean isAutoCompensate() {
        return autoCompensate;
    }

    /**
     * Sets whether auto-compensation is enabled.
     *
     * @param autoCompensate true to automatically compensate timed-out sagas
     */
    public void setAutoCompensate(boolean autoCompensate) {
        this.autoCompensate = autoCompensate;
    }

    /**
     * Returns whether periodic purging of completed sagas is enabled.
     *
     * @return true if purge is enabled
     */
    public boolean isPurgeEnabled() {
        return purgeEnabled;
    }

    /**
     * Sets whether periodic purging of completed sagas is enabled.
     *
     * @param purgeEnabled true to enable periodic purging
     */
    public void setPurgeEnabled(boolean purgeEnabled) {
        this.purgeEnabled = purgeEnabled;
    }

    /**
     * Returns the minimum age for purging terminal sagas.
     *
     * @return the purge age threshold
     */
    public Duration getPurgeOlderThan() {
        return purgeOlderThan;
    }

    /**
     * Sets the minimum age for purging terminal sagas.
     *
     * @param purgeOlderThan minimum age before purging
     */
    public void setPurgeOlderThan(Duration purgeOlderThan) {
        this.purgeOlderThan = Objects.requireNonNull(purgeOlderThan, "purgeOlderThan cannot be null");
    }

    /**
     * Returns the number of check cycles between purge runs.
     *
     * @return purge interval in check cycles
     */
    public int getPurgeIntervalChecks() {
        return purgeIntervalChecks;
    }

    /**
     * Sets the number of check cycles between purge runs.
     *
     * @param purgeIntervalChecks number of check cycles between purges (must be at least 1)
     */
    public void setPurgeIntervalChecks(int purgeIntervalChecks) {
        if (purgeIntervalChecks < 1) {
            throw new IllegalArgumentException("purgeIntervalChecks must be at least 1");
        }
        this.purgeIntervalChecks = purgeIntervalChecks;
    }

    @Override
    public String toString() {
        return "SagaTimeoutConfig{" +
                "enabled=" + enabled +
                ", checkInterval=" + checkInterval +
                ", defaultDeadline=" + defaultDeadline +
                ", sagaTypes=" + sagaTypes.size() +
                ", maxBatchSize=" + maxBatchSize +
                ", autoCompensate=" + autoCompensate +
                ", purgeEnabled=" + purgeEnabled +
                ", purgeOlderThan=" + purgeOlderThan +
                ", purgeIntervalChecks=" + purgeIntervalChecks +
                '}';
    }
}
