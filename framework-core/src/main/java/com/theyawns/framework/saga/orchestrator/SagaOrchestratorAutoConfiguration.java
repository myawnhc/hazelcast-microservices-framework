package com.theyawns.framework.saga.orchestrator;

import com.theyawns.framework.saga.SagaMetrics;
import com.theyawns.framework.saga.SagaStateStore;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.AutoConfiguration;
import org.springframework.boot.autoconfigure.condition.ConditionalOnBean;
import org.springframework.context.annotation.Bean;

import java.util.List;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;

/**
 * Auto-configuration for the saga orchestrator infrastructure.
 *
 * <p>Creates:
 * <ul>
 *   <li>{@link LoggingSagaOrchestratorListener} for lifecycle logging</li>
 *   <li>{@link ScheduledExecutorService} for timeouts and retry delays</li>
 *   <li>{@link HazelcastSagaOrchestrator} wired with the state store, listeners, and scheduler</li>
 * </ul>
 *
 * <p>Only activates when a {@link SagaStateStore} bean is present in the context.
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
@AutoConfiguration
@ConditionalOnBean(SagaStateStore.class)
public class SagaOrchestratorAutoConfiguration {

    /**
     * Creates the logging listener for saga orchestration events.
     *
     * @return a logging listener
     */
    @Bean
    public LoggingSagaOrchestratorListener loggingSagaOrchestratorListener() {
        return new LoggingSagaOrchestratorListener();
    }

    /**
     * Creates the scheduler used by the orchestrator for timeouts and retry delays.
     *
     * @return a scheduled executor service
     */
    @Bean(destroyMethod = "shutdown")
    public ScheduledExecutorService sagaOrchestratorScheduler() {
        return Executors.newScheduledThreadPool(2);
    }

    /**
     * Creates the saga orchestrator.
     *
     * @param stateStore the saga state store
     * @param listeners all registered saga orchestrator listeners
     * @param scheduler the scheduler for timeouts
     * @param sagaMetrics optional metrics collector (null if no MeterRegistry is available)
     * @return the saga orchestrator
     */
    @Bean
    public HazelcastSagaOrchestrator sagaOrchestrator(
            final SagaStateStore stateStore,
            final List<SagaOrchestratorListener> listeners,
            final ScheduledExecutorService sagaOrchestratorScheduler,
            @Autowired(required = false) final SagaMetrics sagaMetrics) {
        return new HazelcastSagaOrchestrator(stateStore, listeners, sagaOrchestratorScheduler, sagaMetrics);
    }
}
