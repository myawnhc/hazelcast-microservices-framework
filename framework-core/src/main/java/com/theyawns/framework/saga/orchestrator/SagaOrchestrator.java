package com.theyawns.framework.saga.orchestrator;

import java.util.Optional;
import java.util.concurrent.CompletableFuture;

/**
 * Core interface for orchestrated saga execution.
 *
 * <p>An orchestrator centrally coordinates the execution of saga steps as defined
 * by a {@link SagaDefinition}. Unlike choreographed sagas where services react
 * independently to events, the orchestrator explicitly directs each step and manages
 * compensation on failure.
 *
 * <p>Typical usage:
 * <pre>{@code
 * SagaOrchestrator orchestrator = ...; // e.g., HazelcastSagaOrchestrator
 *
 * SagaDefinition definition = SagaDefinition.builder()
 *     .name("OrderFulfillment")
 *     .step("ReserveStock").action(...).compensation(...).build()
 *     .step("ProcessPayment").action(...).compensation(...).build()
 *     .build();
 *
 * SagaContext context = SagaContext.of(Map.of("orderId", orderId));
 *
 * CompletableFuture<SagaOrchestratorResult> future =
 *     orchestrator.start("saga-123", definition, context);
 *
 * future.thenAccept(result -> {
 *     if (result.isSuccessful()) {
 *         log.info("Saga completed successfully");
 *     } else {
 *         log.warn("Saga failed: {}", result.getFailureReason());
 *     }
 * });
 * }</pre>
 *
 * @author Generated by Claude Code
 * @since 3.0
 * @see SagaDefinition
 * @see SagaContext
 * @see SagaOrchestratorResult
 */
public interface SagaOrchestrator {

    /**
     * Starts executing a saga.
     *
     * <p>Steps are executed sequentially in the order defined by the
     * {@link SagaDefinition}. If a step fails, compensation is triggered
     * in reverse order for all previously completed steps.
     *
     * @param sagaId a unique identifier for this saga instance
     * @param definition the saga definition describing steps to execute
     * @param context the initial context with input data for the saga
     * @return a future that completes with the saga result
     * @throws NullPointerException if any argument is null
     */
    CompletableFuture<SagaOrchestratorResult> start(String sagaId, SagaDefinition definition, SagaContext context);

    /**
     * Reports the result of a step execution back to the orchestrator.
     *
     * <p>This is used in async step execution models where step completion
     * is reported externally (e.g., via a message listener).
     *
     * @param sagaId the saga instance ID
     * @param stepName the name of the completed step
     * @param result the step result
     * @throws NullPointerException if any argument is null
     * @throws IllegalArgumentException if the saga or step is not found
     */
    void handleStepResult(String sagaId, String stepName, SagaStepResult result);

    /**
     * Returns the current status of a saga.
     *
     * @param sagaId the saga instance ID
     * @return optional containing the result if the saga exists, or empty
     * @throws NullPointerException if sagaId is null
     */
    Optional<SagaOrchestratorResult> getStatus(String sagaId);

    /**
     * Cancels a running saga, triggering compensation for completed steps.
     *
     * @param sagaId the saga instance ID
     * @param reason the cancellation reason
     * @return a future that completes with the final result after compensation
     * @throws NullPointerException if any argument is null
     * @throws IllegalArgumentException if the saga is not found
     */
    CompletableFuture<SagaOrchestratorResult> cancel(String sagaId, String reason);
}
