package com.theyawns.framework.saga;

import java.time.Duration;
import java.util.List;
import java.util.Optional;

/**
 * Interface for storing and tracking saga state across distributed services.
 *
 * <p>This interface provides the foundation for both choreographed and
 * orchestrated saga patterns:
 *
 * <ul>
 *   <li><strong>Choreography (Phase 2)</strong>: Services update saga state
 *       independently as events flow through the system</li>
 *   <li><strong>Orchestration (Future)</strong>: A central coordinator uses
 *       this store to track and drive saga execution</li>
 * </ul>
 *
 * <p>Key capabilities:
 * <ul>
 *   <li>Track saga instances from start to completion</li>
 *   <li>Record individual step completions and failures</li>
 *   <li>Support compensation (rollback) tracking</li>
 *   <li>Detect timed-out sagas for intervention</li>
 *   <li>Query sagas by status, correlation ID, or type</li>
 * </ul>
 *
 * <p>Example usage:
 * <pre>{@code
 * // Start a new saga
 * sagaStateStore.startSaga("saga-123", "OrderFulfillment", "corr-456", 4, Duration.ofSeconds(30));
 *
 * // Record step completion
 * sagaStateStore.recordStepCompleted("saga-123", 0, "OrderCreated", "order-service", "evt-1");
 * sagaStateStore.recordStepCompleted("saga-123", 1, "StockReserved", "inventory-service", "evt-2");
 *
 * // Handle failure
 * sagaStateStore.recordStepFailed("saga-123", 2, "PaymentFailed", "payment-service", "Insufficient funds");
 *
 * // Track compensation
 * sagaStateStore.recordCompensationStarted("saga-123");
 * sagaStateStore.recordCompensationStep("saga-123", 1, "StockReleased", "inventory-service");
 *
 * // Complete saga
 * sagaStateStore.completeSaga("saga-123", SagaStatus.COMPENSATED);
 * }</pre>
 *
 * @author Generated by Claude Code
 * @since 2.0
 * @see SagaState
 * @see HazelcastSagaStateStore
 */
public interface SagaStateStore {

    // ========== Saga Lifecycle ==========

    /**
     * Starts a new saga instance.
     *
     * @param sagaId unique identifier for the saga
     * @param sagaType type of saga (e.g., "OrderFulfillment")
     * @param correlationId correlation ID linking related events
     * @param totalSteps total number of steps in the saga
     * @param timeout maximum duration before the saga times out
     * @return the created saga state
     */
    SagaState startSaga(String sagaId, String sagaType, String correlationId,
                        int totalSteps, Duration timeout);

    /**
     * Starts a new saga instance without correlation ID.
     *
     * @param sagaId unique identifier for the saga
     * @param sagaType type of saga
     * @param totalSteps total number of steps
     * @param timeout maximum duration before timeout
     * @return the created saga state
     */
    default SagaState startSaga(String sagaId, String sagaType, int totalSteps, Duration timeout) {
        return startSaga(sagaId, sagaType, null, totalSteps, timeout);
    }

    /**
     * Marks a saga as completed with the given outcome.
     *
     * @param sagaId the saga identifier
     * @param outcome the final status (COMPLETED, COMPENSATED, FAILED, TIMED_OUT)
     * @return the updated saga state
     * @throws IllegalArgumentException if saga not found or outcome is not terminal
     */
    SagaState completeSaga(String sagaId, SagaStatus outcome);

    // ========== Step Tracking ==========

    /**
     * Records that a saga step has completed successfully.
     *
     * @param sagaId the saga identifier
     * @param stepNumber the step number (0-indexed)
     * @param eventType the event type that completed the step
     * @param service the service that completed the step
     * @param eventId the ID of the completing event
     * @return the updated saga state
     */
    SagaState recordStepCompleted(String sagaId, int stepNumber, String eventType,
                                   String service, String eventId);

    /**
     * Records that a saga step has failed.
     *
     * @param sagaId the saga identifier
     * @param stepNumber the step number that failed
     * @param eventType the event type
     * @param service the service where failure occurred
     * @param reason the failure reason
     * @return the updated saga state (now in COMPENSATING status)
     */
    SagaState recordStepFailed(String sagaId, int stepNumber, String eventType,
                                String service, String reason);

    // ========== Compensation ==========

    /**
     * Marks that compensation (rollback) has started for a saga.
     *
     * @param sagaId the saga identifier
     * @return the updated saga state
     */
    SagaState recordCompensationStarted(String sagaId);

    /**
     * Records that a compensation step has completed.
     *
     * @param sagaId the saga identifier
     * @param stepNumber the step being compensated (original step number)
     * @param eventType the compensation event type
     * @param service the service performing compensation
     * @return the updated saga state
     */
    SagaState recordCompensationStep(String sagaId, int stepNumber,
                                      String eventType, String service);

    // ========== Queries ==========

    /**
     * Gets the current state of a saga.
     *
     * @param sagaId the saga identifier
     * @return the saga state, or empty if not found
     */
    Optional<SagaState> getSagaState(String sagaId);

    /**
     * Checks if a saga exists.
     *
     * @param sagaId the saga identifier
     * @return true if the saga exists
     */
    default boolean exists(String sagaId) {
        return getSagaState(sagaId).isPresent();
    }

    /**
     * Finds sagas that have exceeded their timeout deadline.
     * These sagas should be compensated or marked as timed out.
     *
     * @return list of timed-out sagas
     */
    List<SagaState> findTimedOutSagas();

    /**
     * Finds sagas by their current status.
     *
     * @param status the status to filter by
     * @return list of sagas with the given status
     */
    List<SagaState> findSagasByStatus(SagaStatus status);

    /**
     * Finds sagas by correlation ID.
     * Useful for finding all sagas related to a single transaction.
     *
     * @param correlationId the correlation ID
     * @return list of sagas with the given correlation ID
     */
    List<SagaState> findSagasByCorrelationId(String correlationId);

    /**
     * Finds sagas by type.
     *
     * @param sagaType the saga type (e.g., "OrderFulfillment")
     * @return list of sagas of the given type
     */
    List<SagaState> findSagasByType(String sagaType);

    /**
     * Finds active (non-terminal) sagas.
     *
     * @return list of active sagas
     */
    default List<SagaState> findActiveSagas() {
        return findSagasByStatus(SagaStatus.IN_PROGRESS);
    }

    // ========== Metrics ==========

    /**
     * Returns the count of sagas by status.
     *
     * @param status the status to count
     * @return count of sagas with the given status
     */
    long countByStatus(SagaStatus status);

    /**
     * Returns the total number of sagas in the store.
     *
     * @return total saga count
     */
    long count();

    // ========== Maintenance ==========

    /**
     * Removes completed sagas older than the specified age.
     * Used for cleanup of historical saga data.
     *
     * @param olderThan only remove sagas completed before this duration ago
     * @return number of sagas removed
     */
    int purgeCompletedSagas(Duration olderThan);
}
