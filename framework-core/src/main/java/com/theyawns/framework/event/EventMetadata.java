package com.theyawns.framework.event;

import java.io.Serializable;
import java.time.Instant;
import java.util.Objects;

/**
 * Metadata associated with domain events for tracing and saga support.
 * This class encapsulates cross-cutting concerns that apply to all events.
 *
 * <p>Key responsibilities:
 * <ul>
 *   <li>Correlation ID for tracing related events across services</li>
 *   <li>Saga metadata for distributed transaction support</li>
 *   <li>Compensating event tracking for rollback scenarios</li>
 * </ul>
 *
 * @author Generated by Claude Code
 * @since 1.0
 */
public class EventMetadata implements Serializable {

    private static final long serialVersionUID = 1L;

    private final String correlationId;
    private final String sagaId;
    private final String sagaType;
    private final Integer stepNumber;
    private final boolean isCompensating;
    private final Instant createdAt;

    private EventMetadata(Builder builder) {
        this.correlationId = builder.correlationId;
        this.sagaId = builder.sagaId;
        this.sagaType = builder.sagaType;
        this.stepNumber = builder.stepNumber;
        this.isCompensating = builder.isCompensating;
        this.createdAt = builder.createdAt != null ? builder.createdAt : Instant.now();
    }

    /**
     * Creates a new builder for EventMetadata.
     *
     * @param correlationId the correlation ID (required)
     * @return a new Builder instance
     */
    public static Builder builder(String correlationId) {
        return new Builder(correlationId);
    }

    /**
     * Creates metadata for a simple event (not part of a saga).
     *
     * @param correlationId the correlation ID
     * @return EventMetadata with just the correlation ID
     */
    public static EventMetadata simple(String correlationId) {
        return builder(correlationId).build();
    }

    public String getCorrelationId() {
        return correlationId;
    }

    public String getSagaId() {
        return sagaId;
    }

    public String getSagaType() {
        return sagaType;
    }

    public Integer getStepNumber() {
        return stepNumber;
    }

    public boolean isCompensating() {
        return isCompensating;
    }

    public Instant getCreatedAt() {
        return createdAt;
    }

    /**
     * Returns true if this metadata represents a saga step.
     *
     * @return true if part of a saga
     */
    public boolean isSagaEvent() {
        return sagaId != null;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        EventMetadata that = (EventMetadata) o;
        return isCompensating == that.isCompensating &&
                Objects.equals(correlationId, that.correlationId) &&
                Objects.equals(sagaId, that.sagaId) &&
                Objects.equals(sagaType, that.sagaType) &&
                Objects.equals(stepNumber, that.stepNumber);
    }

    @Override
    public int hashCode() {
        return Objects.hash(correlationId, sagaId, sagaType, stepNumber, isCompensating);
    }

    @Override
    public String toString() {
        return "EventMetadata{" +
                "correlationId='" + correlationId + '\'' +
                ", sagaId='" + sagaId + '\'' +
                ", sagaType='" + sagaType + '\'' +
                ", stepNumber=" + stepNumber +
                ", isCompensating=" + isCompensating +
                '}';
    }

    /**
     * Builder for EventMetadata.
     */
    public static class Builder {
        private final String correlationId;
        private String sagaId;
        private String sagaType;
        private Integer stepNumber;
        private boolean isCompensating = false;
        private Instant createdAt;

        private Builder(String correlationId) {
            this.correlationId = Objects.requireNonNull(correlationId, "correlationId is required");
        }

        /**
         * Sets the saga ID for this event.
         *
         * @param sagaId the saga instance ID
         * @return this builder
         */
        public Builder sagaId(String sagaId) {
            this.sagaId = sagaId;
            return this;
        }

        /**
         * Sets the saga type for this event.
         *
         * @param sagaType the type of saga (e.g., "OrderFulfillment")
         * @return this builder
         */
        public Builder sagaType(String sagaType) {
            this.sagaType = sagaType;
            return this;
        }

        /**
         * Sets the step number in the saga sequence.
         *
         * @param stepNumber the position in the saga sequence
         * @return this builder
         */
        public Builder stepNumber(Integer stepNumber) {
            this.stepNumber = stepNumber;
            return this;
        }

        /**
         * Marks this event as a compensating (rollback) action.
         *
         * @param isCompensating true if this is a compensating event
         * @return this builder
         */
        public Builder compensating(boolean isCompensating) {
            this.isCompensating = isCompensating;
            return this;
        }

        /**
         * Sets the creation timestamp (defaults to now if not set).
         *
         * @param createdAt the creation timestamp
         * @return this builder
         */
        public Builder createdAt(Instant createdAt) {
            this.createdAt = createdAt;
            return this;
        }

        /**
         * Builds the EventMetadata instance.
         *
         * @return a new EventMetadata instance
         */
        public EventMetadata build() {
            return new EventMetadata(this);
        }
    }
}