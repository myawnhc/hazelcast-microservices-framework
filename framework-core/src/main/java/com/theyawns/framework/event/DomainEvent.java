package com.theyawns.framework.event;

import com.hazelcast.nio.serialization.genericrecord.GenericRecord;
import com.theyawns.framework.domain.DomainObject;

import java.io.Serializable;
import java.time.Instant;
import java.util.UUID;
import java.util.function.UnaryOperator;

/**
 * Base class for all domain events in the event sourcing framework.
 * Events represent state changes to domain objects and are the source of truth.
 *
 * <p>All events are:
 * <ul>
 *   <li>Immutable after creation</li>
 *   <li>Serialized as GenericRecord for flexibility</li>
 *   <li>Applied to domain objects via the apply() method</li>
 *   <li>Published to subscribers automatically</li>
 * </ul>
 *
 * @param <D> The domain object type this event affects
 * @param <K> The key type of the domain object
 * @author Generated by Claude Code
 * @since 1.0
 */
public abstract class DomainEvent<D extends DomainObject<K>, K>
        implements UnaryOperator<GenericRecord>, Serializable {

    private static final long serialVersionUID = 1L;

    // Event identification
    protected String eventId;
    protected String eventType;
    protected String eventVersion;

    // Event source
    protected String source;        // Service that created the event
    protected Instant timestamp;    // When event was created

    // Domain object reference
    protected K key;               // Key of affected domain object

    // Traceability
    protected String correlationId; // Links related events across services

    // Saga support (optional, null if not part of saga)
    protected String sagaId;        // Saga instance identifier
    protected String sagaType;      // Type of saga (e.g., "OrderFulfillment")
    protected Integer stepNumber;   // Position in saga sequence
    protected Boolean isCompensating; // Is this a rollback event?

    // Performance tracking
    protected Instant submittedAt;       // When handleEvent() was called
    protected Instant pipelineEntryTime; // When entered Jet pipeline

    /**
     * Default constructor initializes base metadata.
     */
    protected DomainEvent() {
        this.eventId = UUID.randomUUID().toString();
        this.eventVersion = getDefaultVersion();
        this.timestamp = Instant.now();
        this.isCompensating = false;
    }

    /**
     * Constructor with key.
     *
     * @param key the key of the domain object this event affects
     */
    protected DomainEvent(K key) {
        this();
        this.key = key;
    }

    /**
     * Returns the default version for this event type.
     * Subclasses can override to change versioning.
     *
     * @return the default event version
     */
    protected String getDefaultVersion() {
        return "1.0";
    }

    /**
     * Serializes this event to a GenericRecord for storage.
     * Subclasses must implement to include their specific fields.
     *
     * @return GenericRecord representation of this event
     */
    public abstract GenericRecord toGenericRecord();

    /**
     * Applies this event to a domain object's GenericRecord representation.
     * This is how events modify domain object state.
     *
     * @param domainObjectRecord The current state of the domain object (may be null for creation events)
     * @return The updated state after applying this event
     */
    @Override
    public abstract GenericRecord apply(GenericRecord domainObjectRecord);

    /**
     * Returns the schema name used for GenericRecord serialization.
     *
     * @return the schema name for this event type
     */
    public abstract String getSchemaName();

    // Getters
    public String getEventId() {
        return eventId;
    }

    public String getEventType() {
        return eventType;
    }

    public String getEventVersion() {
        return eventVersion;
    }

    public String getSource() {
        return source;
    }

    public Instant getTimestamp() {
        return timestamp;
    }

    public K getKey() {
        return key;
    }

    public String getCorrelationId() {
        return correlationId;
    }

    public String getSagaId() {
        return sagaId;
    }

    public String getSagaType() {
        return sagaType;
    }

    public Integer getStepNumber() {
        return stepNumber;
    }

    public Boolean getIsCompensating() {
        return isCompensating;
    }

    public Instant getSubmittedAt() {
        return submittedAt;
    }

    public Instant getPipelineEntryTime() {
        return pipelineEntryTime;
    }

    // Setters for metadata that gets populated during event handling
    public void setEventId(String eventId) {
        this.eventId = eventId;
    }

    public void setEventType(String eventType) {
        this.eventType = eventType;
    }

    public void setEventVersion(String eventVersion) {
        this.eventVersion = eventVersion;
    }

    public void setSource(String source) {
        this.source = source;
    }

    public void setTimestamp(Instant timestamp) {
        this.timestamp = timestamp;
    }

    public void setKey(K key) {
        this.key = key;
    }

    public void setCorrelationId(String correlationId) {
        this.correlationId = correlationId;
    }

    public void setSagaId(String sagaId) {
        this.sagaId = sagaId;
    }

    public void setSagaType(String sagaType) {
        this.sagaType = sagaType;
    }

    public void setStepNumber(Integer stepNumber) {
        this.stepNumber = stepNumber;
    }

    public void setIsCompensating(Boolean compensating) {
        this.isCompensating = compensating;
    }

    public void setSubmittedAt(Instant submittedAt) {
        this.submittedAt = submittedAt;
    }

    public void setPipelineEntryTime(Instant pipelineEntryTime) {
        this.pipelineEntryTime = pipelineEntryTime;
    }

    @Override
    public String toString() {
        return getClass().getSimpleName() + "{" +
                "eventId='" + eventId + '\'' +
                ", eventType='" + eventType + '\'' +
                ", key=" + key +
                ", correlationId='" + correlationId + '\'' +
                ", timestamp=" + timestamp +
                '}';
    }
}