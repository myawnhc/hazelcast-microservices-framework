package com.theyawns.framework.dlq;

import com.hazelcast.nio.serialization.genericrecord.GenericRecord;

import java.time.Instant;
import java.util.Objects;
import java.util.UUID;

/**
 * Represents an entry in the dead letter queue.
 *
 * <p>Dead letter entries capture events that failed processing after
 * resilience mechanisms (circuit breaker, retry) were exhausted. They
 * preserve the full event context for later replay or manual investigation.
 *
 * <p>Stored in Hazelcast IMap as Compact-serialized GenericRecords via
 * {@link HazelcastDeadLetterQueue}, which handles the conversion between
 * this POJO and the GenericRecord representation.
 *
 * <p>Use the {@link Builder} for clean construction:
 * <pre>{@code
 * DeadLetterEntry entry = DeadLetterEntry.builder()
 *     .originalEventId(eventId)
 *     .eventType("OrderCreated")
 *     .topicName("OrderCreated")
 *     .eventRecord(record)
 *     .failureReason("Connection refused")
 *     .sourceService("inventory-service")
 *     .sagaId(sagaId)
 *     .correlationId(correlationId)
 *     .build();
 * }</pre>
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
public class DeadLetterEntry {

    /**
     * Unique identifier for this DLQ entry.
     */
    private String dlqEntryId;

    /**
     * The original event's identifier.
     */
    private String originalEventId;

    /**
     * The event type (e.g., "OrderCreated").
     */
    private String eventType;

    /**
     * The ITopic name where the event was originally published.
     */
    private String topicName;

    /**
     * The serialized event record for replay.
     */
    private GenericRecord eventRecord;

    /**
     * The reason processing failed.
     */
    private String failureReason;

    /**
     * When the failure occurred.
     */
    private Instant failureTimestamp;

    /**
     * The service that failed to process the event.
     */
    private String sourceService;

    /**
     * The saga identifier, if this event was part of a saga.
     */
    private String sagaId;

    /**
     * The correlation identifier for tracing.
     */
    private String correlationId;

    /**
     * Number of times this entry has been replayed.
     */
    private int replayCount;

    /**
     * Current DLQ status.
     */
    private Status status;

    /**
     * No-arg constructor used by {@link #reconstitute} for deserialization.
     */
    public DeadLetterEntry() {
    }

    private DeadLetterEntry(final Builder builder) {
        this.dlqEntryId = UUID.randomUUID().toString();
        this.originalEventId = builder.originalEventId;
        this.eventType = builder.eventType;
        this.topicName = builder.topicName;
        this.eventRecord = builder.eventRecord;
        this.failureReason = builder.failureReason;
        this.failureTimestamp = Instant.now();
        this.sourceService = builder.sourceService;
        this.sagaId = builder.sagaId;
        this.correlationId = builder.correlationId;
        this.replayCount = 0;
        this.status = Status.PENDING;
    }

    /**
     * Reconstitutes a DeadLetterEntry from stored field values.
     *
     * <p>Package-private â€” used by {@link HazelcastDeadLetterQueue} when
     * reading entries from the IMap's Compact-serialized GenericRecords.
     *
     * @param dlqEntryId the DLQ entry identifier
     * @param originalEventId the original event identifier
     * @param eventType the event type
     * @param topicName the ITopic name
     * @param eventRecord the serialized event record (nullable)
     * @param failureReason the failure reason
     * @param failureTimestamp the failure timestamp
     * @param sourceService the source service name
     * @param sagaId the saga identifier (nullable)
     * @param correlationId the correlation identifier (nullable)
     * @param replayCount the replay count
     * @param status the current status
     * @return a reconstituted dead letter entry
     */
    static DeadLetterEntry reconstitute(final String dlqEntryId, final String originalEventId,
            final String eventType, final String topicName, final GenericRecord eventRecord,
            final String failureReason, final Instant failureTimestamp, final String sourceService,
            final String sagaId, final String correlationId, final int replayCount,
            final Status status) {
        final DeadLetterEntry entry = new DeadLetterEntry();
        entry.dlqEntryId = dlqEntryId;
        entry.originalEventId = originalEventId;
        entry.eventType = eventType;
        entry.topicName = topicName;
        entry.eventRecord = eventRecord;
        entry.failureReason = failureReason;
        entry.failureTimestamp = failureTimestamp;
        entry.sourceService = sourceService;
        entry.sagaId = sagaId;
        entry.correlationId = correlationId;
        entry.replayCount = replayCount;
        entry.status = status;
        return entry;
    }

    /**
     * Creates a new builder for DeadLetterEntry.
     *
     * @return a new builder
     */
    public static Builder builder() {
        return new Builder();
    }

    /**
     * Returns the DLQ entry identifier.
     *
     * @return the DLQ entry ID
     */
    public String getDlqEntryId() {
        return dlqEntryId;
    }

    /**
     * Returns the original event identifier.
     *
     * @return the original event ID
     */
    public String getOriginalEventId() {
        return originalEventId;
    }

    /**
     * Returns the event type.
     *
     * @return the event type
     */
    public String getEventType() {
        return eventType;
    }

    /**
     * Returns the ITopic name.
     *
     * @return the topic name
     */
    public String getTopicName() {
        return topicName;
    }

    /**
     * Returns the serialized event record.
     *
     * @return the event record
     */
    public GenericRecord getEventRecord() {
        return eventRecord;
    }

    /**
     * Returns the failure reason.
     *
     * @return the failure reason
     */
    public String getFailureReason() {
        return failureReason;
    }

    /**
     * Returns when the failure occurred.
     *
     * @return failure timestamp
     */
    public Instant getFailureTimestamp() {
        return failureTimestamp;
    }

    /**
     * Returns the source service name.
     *
     * @return the source service
     */
    public String getSourceService() {
        return sourceService;
    }

    /**
     * Returns the saga identifier.
     *
     * @return the saga ID, or null if not part of a saga
     */
    public String getSagaId() {
        return sagaId;
    }

    /**
     * Returns the correlation identifier.
     *
     * @return the correlation ID
     */
    public String getCorrelationId() {
        return correlationId;
    }

    /**
     * Returns the number of replay attempts.
     *
     * @return the replay count
     */
    public int getReplayCount() {
        return replayCount;
    }

    /**
     * Sets the replay count.
     *
     * @param replayCount the new replay count
     */
    public void setReplayCount(final int replayCount) {
        this.replayCount = replayCount;
    }

    /**
     * Returns the current DLQ status.
     *
     * @return the status
     */
    public Status getStatus() {
        return status;
    }

    /**
     * Sets the DLQ status.
     *
     * @param status the new status
     */
    public void setStatus(final Status status) {
        this.status = Objects.requireNonNull(status, "status cannot be null");
    }

    @Override
    public String toString() {
        return "DeadLetterEntry{" +
                "dlqEntryId='" + dlqEntryId + '\'' +
                ", originalEventId='" + originalEventId + '\'' +
                ", eventType='" + eventType + '\'' +
                ", topicName='" + topicName + '\'' +
                ", failureReason='" + failureReason + '\'' +
                ", sourceService='" + sourceService + '\'' +
                ", sagaId='" + sagaId + '\'' +
                ", status=" + status +
                ", replayCount=" + replayCount +
                '}';
    }

    /**
     * DLQ entry status.
     */
    public enum Status {
        /** Awaiting review or replay. */
        PENDING,
        /** Successfully replayed to original topic. */
        REPLAYED,
        /** Manually discarded by an administrator. */
        DISCARDED
    }

    /**
     * Builder for DeadLetterEntry.
     *
     * @author Generated by Claude Code
     * @since 3.0
     */
    public static class Builder {

        private String originalEventId;
        private String eventType;
        private String topicName;
        private GenericRecord eventRecord;
        private String failureReason;
        private String sourceService;
        private String sagaId;
        private String correlationId;

        /**
         * Sets the original event identifier.
         *
         * @param originalEventId the event ID
         * @return this builder
         */
        public Builder originalEventId(final String originalEventId) {
            this.originalEventId = originalEventId;
            return this;
        }

        /**
         * Sets the event type.
         *
         * @param eventType the event type
         * @return this builder
         */
        public Builder eventType(final String eventType) {
            this.eventType = eventType;
            return this;
        }

        /**
         * Sets the topic name.
         *
         * @param topicName the ITopic name
         * @return this builder
         */
        public Builder topicName(final String topicName) {
            this.topicName = topicName;
            return this;
        }

        /**
         * Sets the event record.
         *
         * @param eventRecord the serialized event record
         * @return this builder
         */
        public Builder eventRecord(final GenericRecord eventRecord) {
            this.eventRecord = eventRecord;
            return this;
        }

        /**
         * Sets the failure reason.
         *
         * @param failureReason the reason processing failed
         * @return this builder
         */
        public Builder failureReason(final String failureReason) {
            this.failureReason = failureReason;
            return this;
        }

        /**
         * Sets the source service name.
         *
         * @param sourceService the service that failed
         * @return this builder
         */
        public Builder sourceService(final String sourceService) {
            this.sourceService = sourceService;
            return this;
        }

        /**
         * Sets the saga identifier.
         *
         * @param sagaId the saga ID
         * @return this builder
         */
        public Builder sagaId(final String sagaId) {
            this.sagaId = sagaId;
            return this;
        }

        /**
         * Sets the correlation identifier.
         *
         * @param correlationId the correlation ID
         * @return this builder
         */
        public Builder correlationId(final String correlationId) {
            this.correlationId = correlationId;
            return this;
        }

        /**
         * Builds the DeadLetterEntry.
         *
         * @return the dead letter entry
         * @throws NullPointerException if required fields are missing
         */
        public DeadLetterEntry build() {
            Objects.requireNonNull(originalEventId, "originalEventId is required");
            Objects.requireNonNull(eventType, "eventType is required");
            Objects.requireNonNull(topicName, "topicName is required");
            Objects.requireNonNull(failureReason, "failureReason is required");
            return new DeadLetterEntry(this);
        }
    }
}
