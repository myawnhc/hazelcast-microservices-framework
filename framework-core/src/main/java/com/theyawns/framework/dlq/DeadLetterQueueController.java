package com.theyawns.framework.dlq;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;
import java.util.Map;

/**
 * REST admin controller for dead letter queue management.
 *
 * <p>Provides endpoints to list, inspect, replay, and discard DLQ entries.
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
@RestController
@RequestMapping("/api/admin/dlq")
@Tag(name = "Dead Letter Queue")
public class DeadLetterQueueController {

    private final DeadLetterQueueOperations deadLetterQueue;

    /**
     * Creates a new DeadLetterQueueController.
     *
     * @param deadLetterQueue the DLQ operations
     */
    public DeadLetterQueueController(final DeadLetterQueueOperations deadLetterQueue) {
        this.deadLetterQueue = deadLetterQueue;
    }

    /**
     * Lists DLQ entries, most recent first.
     *
     * @param limit the maximum number of entries to return (default 20)
     * @return list of DLQ entries
     */
    @GetMapping
    @Operation(summary = "List DLQ entries")
    public ResponseEntity<List<DeadLetterEntry>> list(
            @RequestParam(defaultValue = "20") final int limit) {
        return ResponseEntity.ok(deadLetterQueue.list(limit));
    }

    /**
     * Returns the count of PENDING DLQ entries.
     *
     * @return the count
     */
    @GetMapping("/count")
    @Operation(summary = "Count pending DLQ entries")
    public ResponseEntity<Map<String, Long>> count() {
        return ResponseEntity.ok(Map.of("count", deadLetterQueue.count()));
    }

    /**
     * Retrieves a single DLQ entry by its identifier.
     *
     * @param id the DLQ entry identifier
     * @return the entry, or 404 if not found
     */
    @GetMapping("/{id}")
    @Operation(summary = "Get DLQ entry details")
    public ResponseEntity<DeadLetterEntry> getEntry(@PathVariable final String id) {
        DeadLetterEntry entry = deadLetterQueue.getEntry(id);
        if (entry == null) {
            return ResponseEntity.notFound().build();
        }
        return ResponseEntity.ok(entry);
    }

    /**
     * Replays a DLQ entry by re-publishing its event to the original topic.
     *
     * @param id the DLQ entry identifier
     * @return 200 on success, 404 if not found, 400 if entry cannot be replayed
     */
    @PostMapping("/{id}/replay")
    @Operation(summary = "Replay a DLQ entry")
    public ResponseEntity<Map<String, String>> replay(@PathVariable final String id) {
        DeadLetterEntry entry = deadLetterQueue.getEntry(id);
        if (entry == null) {
            return ResponseEntity.notFound().build();
        }
        try {
            deadLetterQueue.replay(id);
            return ResponseEntity.ok(Map.of("status", "replayed", "dlqEntryId", id));
        } catch (IllegalStateException e) {
            return ResponseEntity.badRequest().body(Map.of("error", e.getMessage()));
        }
    }

    /**
     * Discards a DLQ entry.
     *
     * @param id the DLQ entry identifier
     * @return 200 on success, 404 if not found, 400 if entry cannot be discarded
     */
    @DeleteMapping("/{id}")
    @Operation(summary = "Discard a DLQ entry")
    public ResponseEntity<Map<String, String>> discard(@PathVariable final String id) {
        DeadLetterEntry entry = deadLetterQueue.getEntry(id);
        if (entry == null) {
            return ResponseEntity.notFound().build();
        }
        try {
            deadLetterQueue.discard(id);
            return ResponseEntity.ok(Map.of("status", "discarded", "dlqEntryId", id));
        } catch (IllegalStateException e) {
            return ResponseEntity.badRequest().body(Map.of("error", e.getMessage()));
        }
    }
}
