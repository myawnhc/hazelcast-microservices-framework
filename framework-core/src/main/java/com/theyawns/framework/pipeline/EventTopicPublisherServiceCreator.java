package com.theyawns.framework.pipeline;

import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.function.FunctionEx;
import com.hazelcast.jet.core.ProcessorSupplier;
import com.hazelcast.nio.serialization.genericrecord.GenericRecord;
import com.hazelcast.topic.ITopic;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.Serializable;

/**
 * Serializable function for creating topic publisher instances within Jet pipelines.
 *
 * <p>This class solves the lambda serialization problem in distributed Jet pipelines.
 * It provides access to the HazelcastInstance within pipeline stages so that events
 * can be published to event-type-specific ITopic instances after view updates.
 *
 * <p>Saga listeners subscribe to topics named by event type (e.g., "OrderCreated",
 * "StockReserved"), so the publisher must publish to the correct topic based on
 * the event type extracted from the GenericRecord.
 *
 * @author Generated by Claude Code
 * @since 2.0
 */
public class EventTopicPublisherServiceCreator
        implements FunctionEx<ProcessorSupplier.Context, EventTopicPublisherServiceCreator.TopicPublisher>, Serializable {

    private static final long serialVersionUID = 1L;

    @Override
    public TopicPublisher applyEx(ProcessorSupplier.Context ctx) throws Exception {
        return new TopicPublisher(ctx.hazelcastInstance());
    }

    /**
     * Service that publishes GenericRecord events to Hazelcast ITopic instances.
     * Created per pipeline processor and reused for all events processed by that processor.
     */
    public static class TopicPublisher {

        private static final Logger logger = LoggerFactory.getLogger(TopicPublisher.class);

        private final HazelcastInstance hazelcast;

        TopicPublisher(HazelcastInstance hazelcast) {
            this.hazelcast = hazelcast;
        }

        /**
         * Publishes a GenericRecord event to the ITopic with the given name.
         *
         * @param topicName the topic name (typically the event type, e.g., "OrderCreated")
         * @param record the event GenericRecord to publish
         */
        public void publish(String topicName, GenericRecord record) {
            ITopic<GenericRecord> topic = hazelcast.getTopic(topicName);
            topic.publish(record);
            logger.debug("Published event to topic: {}", topicName);
        }
    }
}
