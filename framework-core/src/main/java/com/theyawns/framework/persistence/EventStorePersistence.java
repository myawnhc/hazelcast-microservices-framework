package com.theyawns.framework.persistence;

import java.util.List;
import java.util.Optional;

/**
 * Provider-agnostic interface for persisting domain events to durable storage.
 *
 * <p>Implementations of this interface are responsible for storing and loading
 * {@link PersistableEvent} records. The framework's MapStore adapters delegate
 * to this interface, keeping Hazelcast concerns separate from database concerns.
 *
 * <p>Implementations must be thread-safe â€” Hazelcast's write-behind mechanism
 * may call {@link #persistBatch(String, List)} from multiple threads concurrently.
 *
 * <p>Example implementations:
 * <ul>
 *   <li>PostgreSQL (provided in {@code framework-postgres})</li>
 *   <li>MySQL, CockroachDB, or other JDBC-compatible databases (user-supplied)</li>
 * </ul>
 *
 * <p>Example configuration in application.yml:
 * <pre>{@code
 * framework:
 *   persistence:
 *     enabled: true
 *     write-delay-seconds: 5
 *     write-batch-size: 100
 * }</pre>
 *
 * @author Generated by Claude Code
 * @since 3.0
 * @see PersistableEvent
 * @see com.theyawns.framework.persistence.mapstore.EventStoreMapStore
 */
public interface EventStorePersistence {

    /**
     * Persists a single event to durable storage.
     *
     * @param mapName the Hazelcast map name (e.g., "Customer_ES")
     * @param event the event to persist
     */
    void persist(String mapName, PersistableEvent event);

    /**
     * Persists a batch of events to durable storage.
     *
     * <p>Implementations should use batch insert semantics for efficiency.
     * All events in the batch belong to the same map.
     *
     * @param mapName the Hazelcast map name (e.g., "Customer_ES")
     * @param events the events to persist
     */
    void persistBatch(String mapName, List<PersistableEvent> events);

    /**
     * Loads a single event from durable storage by its map key.
     *
     * @param mapName the Hazelcast map name
     * @param mapKey the serialized PartitionedSequenceKey
     * @return the event if found, or empty
     */
    Optional<PersistableEvent> loadEvent(String mapName, String mapKey);

    /**
     * Loads all event map keys for a given map, used by MapLoader for initial load.
     *
     * <p>For event stores, this is typically not used (events are append-only and
     * loaded on-demand), but the interface provides it for completeness.
     *
     * @param mapName the Hazelcast map name
     * @return all map keys in the store
     */
    Iterable<String> loadAllKeys(String mapName);

    /**
     * Deletes a single event from durable storage.
     *
     * <p>In an event-sourcing system, events are typically never deleted. This method
     * exists to satisfy the MapStore contract but implementations may choose to no-op.
     *
     * @param mapName the Hazelcast map name
     * @param mapKey the serialized PartitionedSequenceKey
     */
    void delete(String mapName, String mapKey);

    /**
     * Checks whether the persistence backend is available and healthy.
     *
     * @return true if the backend is reachable and ready
     */
    boolean isAvailable();
}
