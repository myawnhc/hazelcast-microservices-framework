package com.theyawns.ecommerce.payment.controller;

import com.theyawns.ecommerce.common.dto.OrchestratedStepResponse;
import com.theyawns.ecommerce.payment.service.PaymentOperations;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.Map;
import java.util.concurrent.CompletableFuture;

/**
 * REST controller for orchestrated saga payment endpoints.
 *
 * <p>These endpoints are called by the saga orchestrator in order-service
 * via HTTP. They perform payment operations without saga metadata,
 * returning standardized {@link OrchestratedStepResponse} results.
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
@RestController
@RequestMapping("/api/saga/payment")
@Tag(name = "Orchestrated Payment Operations")
public class OrchestratedPaymentController {

    private static final Logger logger = LoggerFactory.getLogger(OrchestratedPaymentController.class);

    private final PaymentOperations paymentService;

    /**
     * Creates a new OrchestratedPaymentController.
     *
     * @param paymentService the payment operations service
     */
    public OrchestratedPaymentController(final PaymentOperations paymentService) {
        this.paymentService = paymentService;
    }

    /**
     * Processes a payment for an order.
     *
     * @param request the process payment request
     * @return the step response
     */
    @PostMapping("/process")
    @Operation(summary = "Process payment (orchestrated saga)")
    public CompletableFuture<ResponseEntity<OrchestratedStepResponse>> processPayment(
            @RequestBody Map<String, Object> request) {

        String orderId = (String) request.get("orderId");
        String customerId = (String) request.get("customerId");
        String amount = (String) request.get("amount");
        String currency = (String) request.get("currency");
        String method = (String) request.get("method");

        logger.info("Orchestrated process-payment: orderId={}, amount={}", orderId, amount);

        try {
            return paymentService.processPaymentOrchestrated(orderId, customerId, amount, currency, method)
                    .thenApply(payment -> {
                        boolean succeeded = payment.getStatus() == com.theyawns.ecommerce.common.domain.Payment.PaymentStatus.CAPTURED;
                        if (succeeded) {
                            return ResponseEntity.ok(OrchestratedStepResponse.success(Map.of(
                                    "paymentId", payment.getPaymentId(),
                                    "transactionId", payment.getTransactionId() != null
                                            ? payment.getTransactionId() : ""
                            )));
                        } else {
                            return ResponseEntity.ok(OrchestratedStepResponse.failure(
                                    payment.getFailureReason() != null
                                            ? payment.getFailureReason()
                                            : "Payment declined"));
                        }
                    })
                    .exceptionally(ex -> {
                        String msg = ex.getCause() != null ? ex.getCause().getMessage() : ex.getMessage();
                        logger.error("Process payment failed: {}", msg);
                        return ResponseEntity.ok(OrchestratedStepResponse.failure(msg));
                    });
        } catch (Exception e) {
            logger.error("Process payment failed: {}", e.getMessage());
            return CompletableFuture.completedFuture(
                    ResponseEntity.ok(OrchestratedStepResponse.failure(e.getMessage())));
        }
    }

    /**
     * Refunds a previously processed payment (compensation).
     *
     * @param request the refund request
     * @return the step response
     */
    @PostMapping("/refund")
    @Operation(summary = "Refund payment (orchestrated saga compensation)")
    public CompletableFuture<ResponseEntity<OrchestratedStepResponse>> refundPayment(
            @RequestBody Map<String, Object> request) {

        String paymentId = (String) request.get("paymentId");
        String reason = (String) request.get("reason");

        logger.info("Orchestrated refund-payment: paymentId={}, reason={}", paymentId, reason);

        try {
            return paymentService.refundPaymentOrchestrated(paymentId, reason)
                    .thenApply(payment -> ResponseEntity.ok(OrchestratedStepResponse.success(Map.of(
                            "paymentId", payment.getPaymentId()
                    ))))
                    .exceptionally(ex -> {
                        String msg = ex.getCause() != null ? ex.getCause().getMessage() : ex.getMessage();
                        logger.error("Refund payment failed: {}", msg);
                        return ResponseEntity.ok(OrchestratedStepResponse.failure(msg));
                    });
        } catch (Exception e) {
            logger.error("Refund payment failed: {}", e.getMessage());
            return CompletableFuture.completedFuture(
                    ResponseEntity.ok(OrchestratedStepResponse.failure(e.getMessage())));
        }
    }
}
