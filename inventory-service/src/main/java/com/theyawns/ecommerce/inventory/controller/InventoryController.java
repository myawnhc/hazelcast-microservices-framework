package com.theyawns.ecommerce.inventory.controller;

import com.theyawns.ecommerce.common.dto.ProductDTO;
import com.theyawns.ecommerce.inventory.service.ProductService;
import jakarta.validation.Valid;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.concurrent.CompletableFuture;

/**
 * REST controller for product inventory management.
 *
 * <p>Endpoints:
 * <ul>
 *   <li>POST /api/products - Create a new product</li>
 *   <li>GET /api/products/{id} - Get product by ID</li>
 *   <li>POST /api/products/{id}/stock/reserve - Reserve stock for an order</li>
 *   <li>POST /api/products/{id}/stock/release - Release reserved stock</li>
 * </ul>
 *
 * @author Generated by Claude Code
 * @since 1.0
 */
@RestController
@RequestMapping("/api/products")
public class InventoryController {

    private static final Logger logger = LoggerFactory.getLogger(InventoryController.class);

    private final ProductService productService;

    /**
     * Creates a new InventoryController.
     *
     * @param productService the product service
     */
    public InventoryController(ProductService productService) {
        this.productService = productService;
    }

    /**
     * Creates a new product.
     *
     * @param dto the product data
     * @return the created product
     */
    @PostMapping
    public CompletableFuture<ResponseEntity<ProductDTO>> createProduct(@Valid @RequestBody ProductDTO dto) {
        logger.info("REST: Creating product with SKU: {}", dto.getSku());

        return productService.createProduct(dto)
                .thenApply(product -> {
                    ProductDTO response = product.toDTO();
                    logger.info("REST: Product created with ID: {}", response.getProductId());
                    return ResponseEntity.status(HttpStatus.CREATED).body(response);
                });
    }

    /**
     * Retrieves a product by ID.
     *
     * @param productId the product ID
     * @return the product, or 404 if not found
     */
    @GetMapping("/{productId}")
    public ResponseEntity<ProductDTO> getProduct(@PathVariable String productId) {
        logger.debug("REST: Getting product: {}", productId);

        return productService.getProduct(productId)
                .map(product -> {
                    ProductDTO dto = product.toDTO();
                    return ResponseEntity.ok(dto);
                })
                .orElse(ResponseEntity.notFound().build());
    }

    /**
     * Reserves stock for an order.
     *
     * @param productId the product ID
     * @param request the reservation request
     * @return the updated product
     */
    @PostMapping("/{productId}/stock/reserve")
    public CompletableFuture<ResponseEntity<ProductDTO>> reserveStock(
            @PathVariable String productId,
            @Valid @RequestBody StockReservationRequest request) {
        logger.info("REST: Reserving {} units of product {} for order {}",
                request.quantity(), productId, request.orderId());

        return productService.reserveStock(productId, request.quantity(), request.orderId())
                .thenApply(product -> {
                    ProductDTO response = product.toDTO();
                    logger.info("REST: Stock reserved for product {}, available: {}",
                            productId, response.getAvailableQuantity());
                    return ResponseEntity.ok(response);
                });
    }

    /**
     * Releases previously reserved stock.
     *
     * @param productId the product ID
     * @param request the release request
     * @return the updated product
     */
    @PostMapping("/{productId}/stock/release")
    public CompletableFuture<ResponseEntity<ProductDTO>> releaseStock(
            @PathVariable String productId,
            @Valid @RequestBody StockReleaseRequest request) {
        logger.info("REST: Releasing {} units of product {} for order {} (reason: {})",
                request.quantity(), productId, request.orderId(), request.reason());

        return productService.releaseStock(productId, request.quantity(), request.orderId(), request.reason())
                .thenApply(product -> {
                    ProductDTO response = product.toDTO();
                    logger.info("REST: Stock released for product {}, available: {}",
                            productId, response.getAvailableQuantity());
                    return ResponseEntity.ok(response);
                });
    }

    /**
     * Request body for stock reservation.
     *
     * @param quantity the quantity to reserve
     * @param orderId the order ID requesting the reservation
     */
    public record StockReservationRequest(
            @Min(value = 1, message = "Quantity must be at least 1")
            int quantity,

            @NotBlank(message = "Order ID is required")
            String orderId
    ) {
    }

    /**
     * Request body for stock release.
     *
     * @param quantity the quantity to release
     * @param orderId the order ID releasing the stock
     * @param reason the reason for releasing
     */
    public record StockReleaseRequest(
            @Min(value = 1, message = "Quantity must be at least 1")
            int quantity,

            @NotBlank(message = "Order ID is required")
            String orderId,

            @NotBlank(message = "Reason is required")
            String reason
    ) {
    }
}
