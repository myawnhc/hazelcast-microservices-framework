package com.theyawns.ecommerce.inventory.controller;

import com.theyawns.ecommerce.common.dto.OrchestratedStepResponse;
import com.theyawns.ecommerce.inventory.service.InventoryService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.Map;
import java.util.concurrent.CompletableFuture;

/**
 * REST controller for orchestrated saga inventory endpoints.
 *
 * <p>These endpoints are called by the saga orchestrator in order-service
 * via HTTP. They perform inventory operations without saga metadata,
 * returning standardized {@link OrchestratedStepResponse} results.
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
@RestController
@RequestMapping("/api/saga/inventory")
@Tag(name = "Orchestrated Inventory Operations")
public class OrchestratedInventoryController {

    private static final Logger logger = LoggerFactory.getLogger(OrchestratedInventoryController.class);

    private final InventoryService inventoryService;

    /**
     * Creates a new OrchestratedInventoryController.
     *
     * @param inventoryService the inventory service
     */
    public OrchestratedInventoryController(final InventoryService inventoryService) {
        this.inventoryService = inventoryService;
    }

    /**
     * Reserves stock for an order.
     *
     * @param request the reserve stock request
     * @return the step response
     */
    @PostMapping("/reserve-stock")
    @Operation(summary = "Reserve stock (orchestrated saga)")
    public CompletableFuture<ResponseEntity<OrchestratedStepResponse>> reserveStock(
            @RequestBody Map<String, Object> request) {

        String productId = (String) request.get("productId");
        int quantity = request.get("quantity") instanceof Integer
                ? (Integer) request.get("quantity")
                : Integer.parseInt(request.get("quantity").toString());
        String orderId = (String) request.get("orderId");

        logger.info("Orchestrated reserve-stock: productId={}, quantity={}, orderId={}",
                productId, quantity, orderId);

        try {
            return inventoryService.reserveStockOrchestrated(productId, quantity, orderId)
                    .thenApply(product -> ResponseEntity.ok(
                            OrchestratedStepResponse.success(Map.of(
                                    "productId", product.getProductId(),
                                    "availableQuantity", product.getAvailableQuantity()
                            ))
                    ))
                    .exceptionally(ex -> {
                        String msg = ex.getCause() != null ? ex.getCause().getMessage() : ex.getMessage();
                        logger.error("Reserve stock failed: {}", msg);
                        return ResponseEntity.ok(OrchestratedStepResponse.failure(msg));
                    });
        } catch (Exception e) {
            logger.error("Reserve stock failed: {}", e.getMessage());
            return CompletableFuture.completedFuture(
                    ResponseEntity.ok(OrchestratedStepResponse.failure(e.getMessage())));
        }
    }

    /**
     * Releases previously reserved stock (compensation).
     *
     * @param request the release stock request
     * @return the step response
     */
    @PostMapping("/release-stock")
    @Operation(summary = "Release stock (orchestrated saga compensation)")
    public CompletableFuture<ResponseEntity<OrchestratedStepResponse>> releaseStock(
            @RequestBody Map<String, Object> request) {

        String orderId = (String) request.get("orderId");
        String reason = (String) request.get("reason");

        logger.info("Orchestrated release-stock: orderId={}, reason={}", orderId, reason);

        return inventoryService.releaseStockOrchestrated(orderId, reason)
                .thenApply(product -> ResponseEntity.ok(OrchestratedStepResponse.success(Map.of())))
                .exceptionally(ex -> {
                    String msg = ex.getCause() != null ? ex.getCause().getMessage() : ex.getMessage();
                    logger.error("Release stock failed: {}", msg);
                    return ResponseEntity.ok(OrchestratedStepResponse.failure(msg));
                });
    }
}
