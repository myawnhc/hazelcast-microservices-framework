package com.theyawns.ecommerce.order.saga.orchestrated;

import com.theyawns.ecommerce.common.domain.Order;
import com.theyawns.ecommerce.common.dto.OrderDTO;
import com.theyawns.ecommerce.common.dto.OrderLineItemDTO;
import com.theyawns.ecommerce.order.service.OrderOperations;
import com.theyawns.framework.saga.orchestrator.SagaContext;
import com.theyawns.framework.saga.orchestrator.SagaOrchestrator;
import com.theyawns.framework.saga.orchestrator.SagaOrchestratorResult;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.ArrayList;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.CompletableFuture;

/**
 * REST controller for orchestrated order fulfillment.
 *
 * <p>Accepts an order request and executes the Order Fulfillment saga
 * via the {@link SagaOrchestrator}, returning the result once the saga
 * completes (or compensates).
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
@RestController
@RequestMapping("/api/orders/orchestrated")
@Tag(name = "Orchestrated Order Fulfillment")
public class OrchestratedOrderController {

    private static final Logger logger = LoggerFactory.getLogger(OrchestratedOrderController.class);

    private final SagaOrchestrator orchestrator;
    private final OrderFulfillmentSagaFactory sagaFactory;
    private final OrderOperations orderOps;

    /**
     * Creates a new OrchestratedOrderController.
     *
     * @param orchestrator the saga orchestrator
     * @param sagaFactory the saga definition factory
     * @param orderOps the order operations service
     */
    public OrchestratedOrderController(final SagaOrchestrator orchestrator,
                                        final OrderFulfillmentSagaFactory sagaFactory,
                                        final OrderOperations orderOps) {
        this.orchestrator = orchestrator;
        this.sagaFactory = sagaFactory;
        this.orderOps = orderOps;
    }

    /**
     * Creates a new order via orchestrated saga.
     *
     * @param dto the order data
     * @return the created order (201) or error details (409)
     */
    @PostMapping
    @Operation(summary = "Create order via orchestrated saga")
    public CompletableFuture<ResponseEntity<OrderDTO>> createOrder(@Valid @RequestBody OrderDTO dto) {
        String sagaId = UUID.randomUUID().toString();
        logger.info("Starting orchestrated order fulfillment: sagaId={}", sagaId);

        SagaContext context = buildContext(dto);

        return orchestrator.start(sagaId, sagaFactory.create(), context)
                .thenApply(result -> mapResult(result, context));
    }

    /**
     * Builds a SagaContext from the order DTO.
     */
    private SagaContext buildContext(final OrderDTO dto) {
        SagaContext context = SagaContext.create();

        context.put("customerId", dto.getCustomerId());
        if (dto.getCustomerName() != null) {
            context.put("customerName", dto.getCustomerName());
        }
        if (dto.getCustomerEmail() != null) {
            context.put("customerEmail", dto.getCustomerEmail());
        }
        if (dto.getShippingAddress() != null) {
            context.put("shippingAddress", dto.getShippingAddress());
        }

        // Store line items for CreateOrder step
        context.put("lineItems", dto.getLineItems() != null ? dto.getLineItems() : new ArrayList<>());

        // Extract first line item details for ReserveStock step
        if (dto.getLineItems() != null && !dto.getLineItems().isEmpty()) {
            OrderLineItemDTO firstItem = dto.getLineItems().get(0);
            context.put("productId", firstItem.getProductId());
            context.put("quantity", firstItem.getQuantity());
        }

        // Payment details
        if (dto.getTotal() != null) {
            context.put("amount", dto.getTotal().toPlainString());
        } else if (dto.getSubtotal() != null) {
            context.put("amount", dto.getSubtotal().toPlainString());
        }
        context.put("currency", "USD");
        context.put("paymentMethod", "CREDIT_CARD");

        return context;
    }

    /**
     * Maps the saga result to an HTTP response.
     */
    private ResponseEntity<OrderDTO> mapResult(final SagaOrchestratorResult result,
                                                 final SagaContext context) {
        if (result.isSuccessful()) {
            String orderId = context.get("orderId", String.class);
            if (orderId != null) {
                return orderOps.getOrder(orderId)
                        .map(order -> ResponseEntity.status(HttpStatus.CREATED).body(order.toDTO()))
                        .orElse(ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build());
            }
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
        }

        // Saga failed or was compensated
        OrderDTO errorDto = new OrderDTO();
        errorDto.setStatus("FAILED");
        result.getFailureReason().ifPresent(reason -> {
            // Use a field the client can inspect
            errorDto.setCustomerName("Saga " + result.getStatus() + ": " + reason);
        });

        return ResponseEntity.status(HttpStatus.CONFLICT).body(errorDto);
    }
}
