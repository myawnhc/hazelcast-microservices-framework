package com.theyawns.ecommerce.order.cache;

import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.nio.serialization.genericrecord.GenericRecord;
import com.hazelcast.topic.ITopic;
import com.hazelcast.topic.Message;
import com.hazelcast.topic.MessageListener;
import com.theyawns.ecommerce.common.events.CustomerCreatedEvent;
import com.theyawns.ecommerce.common.events.CustomerStatusChangedEvent;
import com.theyawns.ecommerce.common.events.CustomerUpdatedEvent;
import com.theyawns.ecommerce.order.domain.CustomerCacheViewUpdater;
import jakarta.annotation.PostConstruct;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;

/**
 * Listens for customer-related events on the shared cluster and updates
 * the local customer cache.
 *
 * <p>This enables the order service to have an up-to-date view of customer
 * information for order enrichment, without making synchronous calls to
 * the account service.
 *
 * @author Generated by Claude Code
 * @since 2.0
 */
@Component
public class CustomerCacheListener {

    private static final Logger logger = LoggerFactory.getLogger(CustomerCacheListener.class);

    private final HazelcastInstance hazelcast;
    private final CustomerCacheViewUpdater viewUpdater;

    /**
     * Creates a new CustomerCacheListener.
     *
     * @param hazelcast the shared Hazelcast client
     * @param viewUpdater the view updater for applying events
     */
    public CustomerCacheListener(
            @Qualifier("hazelcastClient") HazelcastInstance hazelcast,
            CustomerCacheViewUpdater viewUpdater) {
        this.hazelcast = hazelcast;
        this.viewUpdater = viewUpdater;
    }

    /**
     * Registers listeners for customer-related topics on startup.
     */
    @PostConstruct
    public void registerListeners() {
        if (hazelcast == null) {
            logger.warn("Shared Hazelcast client not available - customer cache will not sync");
            return;
        }

        logger.info("Registering customer cache event listeners");

        ITopic<GenericRecord> customerCreatedTopic = hazelcast.getTopic(CustomerCreatedEvent.EVENT_TYPE);
        customerCreatedTopic.addMessageListener(new CustomerEventListener());

        ITopic<GenericRecord> customerUpdatedTopic = hazelcast.getTopic(CustomerUpdatedEvent.EVENT_TYPE);
        customerUpdatedTopic.addMessageListener(new CustomerEventListener());

        ITopic<GenericRecord> customerStatusChangedTopic = hazelcast.getTopic(CustomerStatusChangedEvent.EVENT_TYPE);
        customerStatusChangedTopic.addMessageListener(new CustomerEventListener());

        logger.info("Customer cache listeners registered successfully");
    }

    /**
     * Generic listener that applies customer-related events to the cache.
     */
    class CustomerEventListener implements MessageListener<GenericRecord> {

        @Override
        public void onMessage(Message<GenericRecord> message) {
            GenericRecord record = message.getMessageObject();
            String eventType = record.getString("eventType");

            logger.debug("Received {} event for customer cache update", eventType);

            try {
                viewUpdater.updateDirect(record);
                logger.debug("Customer cache updated for event: {}", eventType);
            } catch (Exception e) {
                logger.error("Failed to update customer cache for event: {}", eventType, e);
            }
        }
    }
}
