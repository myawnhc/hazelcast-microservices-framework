package com.theyawns.ecommerce.order.domain;

import com.hazelcast.config.Config;
import com.hazelcast.core.Hazelcast;
import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.nio.serialization.genericrecord.GenericRecord;
import com.theyawns.ecommerce.common.domain.Order;
import com.theyawns.ecommerce.common.domain.OrderLineItem;
import com.theyawns.ecommerce.common.events.CustomerCreatedEvent;
import com.theyawns.ecommerce.common.events.OrderCancelledEvent;
import com.theyawns.ecommerce.common.events.OrderConfirmedEvent;
import com.theyawns.ecommerce.common.events.OrderCreatedEvent;
import com.theyawns.ecommerce.common.events.ProductCreatedEvent;
import com.theyawns.framework.view.HazelcastViewStore;
import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestInstance;

import java.math.BigDecimal;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;

/**
 * Unit tests for EnrichedOrderViewUpdater.
 *
 * @author Generated by Claude Code
 * @since 1.0
 */
@DisplayName("EnrichedOrderViewUpdater")
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
class EnrichedOrderViewUpdaterTest {

    private static final String ENRICHED_ORDER_NAME = "EnrichedOrderTest";
    private static final String CUSTOMER_CACHE_NAME = "CustomerCacheTest";
    private static final String PRODUCT_AVAILABILITY_NAME = "ProductAvailabilityTest";

    private HazelcastInstance hazelcast;
    private HazelcastViewStore<String> enrichedOrderViewStore;
    private HazelcastViewStore<String> customerCacheViewStore;
    private HazelcastViewStore<String> productAvailabilityViewStore;

    private EnrichedOrderViewUpdater viewUpdater;
    private CustomerCacheViewUpdater customerCacheUpdater;
    private ProductAvailabilityViewUpdater productAvailabilityUpdater;

    @BeforeAll
    void setUpHazelcast() {
        Config config = new Config();
        config.setClusterName("enriched-order-test-" + System.currentTimeMillis());
        hazelcast = Hazelcast.newHazelcastInstance(config);

        enrichedOrderViewStore = new HazelcastViewStore<>(hazelcast, ENRICHED_ORDER_NAME);
        customerCacheViewStore = new HazelcastViewStore<>(hazelcast, CUSTOMER_CACHE_NAME);
        productAvailabilityViewStore = new HazelcastViewStore<>(hazelcast, PRODUCT_AVAILABILITY_NAME);

        viewUpdater = new EnrichedOrderViewUpdater(
                enrichedOrderViewStore,
                customerCacheViewStore,
                productAvailabilityViewStore
        );
        customerCacheUpdater = new CustomerCacheViewUpdater(customerCacheViewStore);
        productAvailabilityUpdater = new ProductAvailabilityViewUpdater(productAvailabilityViewStore);
    }

    @AfterAll
    void tearDownHazelcast() {
        if (hazelcast != null) {
            hazelcast.shutdown();
        }
    }

    @BeforeEach
    void clearViews() {
        enrichedOrderViewStore.clear();
        customerCacheViewStore.clear();
        productAvailabilityViewStore.clear();
    }

    @Nested
    @DisplayName("OrderCreatedEvent handling")
    class OrderCreatedEventTests {

        @Test
        @DisplayName("should create enriched order with all fields")
        void shouldCreateEnrichedOrderWithAllFields() {
            String customerId = createCustomer("John Doe", "john@example.com");
            String productId = createProduct("Widget", 100);
            String orderId = UUID.randomUUID().toString();

            List<OrderLineItem> lineItems = Arrays.asList(
                    new OrderLineItem(productId, "Widget", "SKU-001", 2, new BigDecimal("10.00"))
            );

            OrderCreatedEvent event = new OrderCreatedEvent(
                    orderId, customerId, lineItems, "123 Main St"
            );
            event.setCustomerName("John Doe");
            event.setCustomerEmail("john@example.com");

            GenericRecord result = viewUpdater.update(event.toGenericRecord());

            assertNotNull(result);
            assertEquals(orderId, result.getString("orderId"));
            assertEquals(customerId, result.getString("customerId"));
            assertEquals("John Doe", result.getString("customerName"));
            assertEquals("john@example.com", result.getString("customerEmail"));
            assertEquals("ACTIVE", result.getString("customerStatus"));
            assertEquals(Order.Status.PENDING.name(), result.getString("status"));
            assertEquals("123 Main St", result.getString("shippingAddress"));
            assertTrue(result.getInt64("createdAt") > 0);
        }

        @Test
        @DisplayName("should enrich line items with product availability")
        void shouldEnrichLineItemsWithProductAvailability() {
            String customerId = createCustomer("Jane Doe", "jane@example.com");
            String productId = createProduct("Gadget", 50);
            String orderId = UUID.randomUUID().toString();

            List<OrderLineItem> lineItems = Arrays.asList(
                    new OrderLineItem(productId, "Gadget", "SKU-GAD", 3, new BigDecimal("25.00"))
            );

            OrderCreatedEvent event = new OrderCreatedEvent(
                    orderId, customerId, lineItems, "456 Oak Ave"
            );

            GenericRecord result = viewUpdater.update(event.toGenericRecord());

            GenericRecord[] enrichedItems = result.getArrayOfGenericRecord("lineItems");
            assertNotNull(enrichedItems);
            assertEquals(1, enrichedItems.length);
            assertEquals(productId, enrichedItems[0].getString("productId"));
            assertEquals(50, enrichedItems[0].getInt32("availableQuantity"));
            assertEquals("ACTIVE", enrichedItems[0].getString("productStatus"));
        }

        @Test
        @DisplayName("should use cached customer data when event data is missing")
        void shouldUseCachedCustomerDataWhenEventDataIsMissing() {
            String customerId = createCustomer("Cached Name", "cached@example.com");
            String orderId = UUID.randomUUID().toString();

            List<OrderLineItem> lineItems = Arrays.asList(
                    new OrderLineItem("prod-1", "Item", "SKU-1", 1, new BigDecimal("5.00"))
            );

            OrderCreatedEvent event = new OrderCreatedEvent(
                    orderId, customerId, lineItems, "789 Pine St"
            );
            // Don't set customer name/email in event

            GenericRecord result = viewUpdater.update(event.toGenericRecord());

            assertEquals("Cached Name", result.getString("customerName"));
            assertEquals("cached@example.com", result.getString("customerEmail"));
        }

        @Test
        @DisplayName("should handle order without cached customer data")
        void shouldHandleOrderWithoutCachedCustomerData() {
            String customerId = UUID.randomUUID().toString(); // Non-existent customer
            String orderId = UUID.randomUUID().toString();

            List<OrderLineItem> lineItems = Arrays.asList(
                    new OrderLineItem("prod-1", "Item", "SKU-1", 1, new BigDecimal("5.00"))
            );

            OrderCreatedEvent event = new OrderCreatedEvent(
                    orderId, customerId, lineItems, "No Cache St"
            );
            event.setCustomerName("Event Name");
            event.setCustomerEmail("event@example.com");

            GenericRecord result = viewUpdater.update(event.toGenericRecord());

            assertNotNull(result);
            assertEquals("Event Name", result.getString("customerName"));
            assertEquals("event@example.com", result.getString("customerEmail"));
            assertEquals("UNKNOWN", result.getString("customerStatus"));
        }

        @Test
        @DisplayName("should store enriched order in view store")
        void shouldStoreEnrichedOrderInViewStore() {
            String customerId = createCustomer("Store Test", "store@example.com");
            String orderId = UUID.randomUUID().toString();

            List<OrderLineItem> lineItems = Arrays.asList(
                    new OrderLineItem("prod-1", "Item", "SKU-1", 1, new BigDecimal("5.00"))
            );

            OrderCreatedEvent event = new OrderCreatedEvent(
                    orderId, customerId, lineItems, "Store Address"
            );

            viewUpdater.update(event.toGenericRecord());

            Optional<GenericRecord> stored = enrichedOrderViewStore.get(orderId);
            assertTrue(stored.isPresent());
            assertEquals(customerId, stored.get().getString("customerId"));
        }
    }

    @Nested
    @DisplayName("OrderConfirmedEvent handling")
    class OrderConfirmedEventTests {

        @Test
        @DisplayName("should update status to CONFIRMED")
        void shouldUpdateStatusToConfirmed() {
            String orderId = createOrder();

            OrderConfirmedEvent event = new OrderConfirmedEvent(orderId, "CONF-12345");
            GenericRecord result = viewUpdater.update(event.toGenericRecord());

            assertNotNull(result);
            assertEquals(Order.Status.CONFIRMED.name(), result.getString("status"));
            assertEquals("CONF-12345", result.getString("confirmationNumber"));
        }

        @Test
        @DisplayName("should preserve order data on confirmation")
        void shouldPreserveOrderDataOnConfirmation() {
            String orderId = createOrder();

            Optional<GenericRecord> before = enrichedOrderViewStore.get(orderId);
            String customerId = before.get().getString("customerId");
            String shippingAddress = before.get().getString("shippingAddress");

            OrderConfirmedEvent event = new OrderConfirmedEvent(orderId, "CONF-12345");
            GenericRecord result = viewUpdater.update(event.toGenericRecord());

            assertEquals(customerId, result.getString("customerId"));
            assertEquals(shippingAddress, result.getString("shippingAddress"));
        }

        @Test
        @DisplayName("should return null for non-existent order")
        void shouldReturnNullForNonExistentOrder() {
            OrderConfirmedEvent event = new OrderConfirmedEvent("non-existent", "CONF-12345");
            GenericRecord result = viewUpdater.update(event.toGenericRecord());

            assertFalse(enrichedOrderViewStore.containsKey("non-existent"));
        }
    }

    @Nested
    @DisplayName("OrderCancelledEvent handling")
    class OrderCancelledEventTests {

        @Test
        @DisplayName("should update status to CANCELLED")
        void shouldUpdateStatusToCancelled() {
            String orderId = createOrder();

            OrderCancelledEvent event = new OrderCancelledEvent(orderId, "Customer request", "customer");
            GenericRecord result = viewUpdater.update(event.toGenericRecord());

            assertNotNull(result);
            assertEquals(Order.Status.CANCELLED.name(), result.getString("status"));
            assertEquals("Customer request", result.getString("cancellationReason"));
            assertEquals("customer", result.getString("cancelledBy"));
        }

        @Test
        @DisplayName("should return null for non-existent order")
        void shouldReturnNullForNonExistentOrder() {
            OrderCancelledEvent event = new OrderCancelledEvent("non-existent", "Test", "test");
            GenericRecord result = viewUpdater.update(event.toGenericRecord());

            assertFalse(enrichedOrderViewStore.containsKey("non-existent"));
        }
    }

    /**
     * Helper method to create a customer and return its ID.
     */
    private String createCustomer(String name, String email) {
        String customerId = UUID.randomUUID().toString();

        CustomerCreatedEvent event = new CustomerCreatedEvent(
                customerId, email, name, "Test Address"
        );

        customerCacheUpdater.update(event.toGenericRecord());
        return customerId;
    }

    /**
     * Helper method to create a product and return its ID.
     */
    private String createProduct(String name, int quantity) {
        String productId = UUID.randomUUID().toString();

        ProductCreatedEvent event = new ProductCreatedEvent(
                productId, "SKU-" + productId.substring(0, 8), name,
                new BigDecimal("9.99"), quantity
        );

        productAvailabilityUpdater.update(event.toGenericRecord());
        return productId;
    }

    /**
     * Helper method to create an order and return its ID.
     */
    private String createOrder() {
        String customerId = createCustomer("Test Customer", "test@example.com");
        String productId = createProduct("Test Product", 100);
        String orderId = UUID.randomUUID().toString();

        List<OrderLineItem> lineItems = Arrays.asList(
                new OrderLineItem(productId, "Test Product", "SKU-001", 1, new BigDecimal("29.99"))
        );

        OrderCreatedEvent event = new OrderCreatedEvent(
                orderId, customerId, lineItems, "Test Address"
        );
        event.setCustomerName("Test Customer");

        viewUpdater.update(event.toGenericRecord());
        return orderId;
    }
}
