package com.theyawns.ecommerce.order.saga;

import com.hazelcast.config.Config;
import com.hazelcast.core.Hazelcast;
import com.hazelcast.core.HazelcastInstance;
import com.theyawns.framework.saga.HazelcastSagaStateStore;
import com.theyawns.framework.saga.SagaCompensationConfig;
import com.theyawns.framework.saga.SagaState;
import com.theyawns.framework.saga.SagaStateStore;
import com.theyawns.framework.saga.SagaStatus;
import io.micrometer.core.instrument.simple.SimpleMeterRegistry;
import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.MethodOrderer;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestInstance;
import org.junit.jupiter.api.TestMethodOrder;

import java.time.Duration;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;

/**
 * Integration test for the Order Fulfillment Saga when stock is unavailable.
 *
 * <p>Validates the compensation flow when stock reservation fails at step 1:
 * <ol>
 *   <li>OrderCreated (step 0) - Order service creates order and starts saga</li>
 *   <li>InsufficientStock (step 1 FAILED) - Inventory cannot reserve stock</li>
 *   <li>OrderCancelled (compensate step 0) - Order service cancels order</li>
 *   <li>Saga finalized as COMPENSATED</li>
 * </ol>
 *
 * <p>Key difference from payment failure: no stock release is needed because
 * stock was never reserved.
 *
 * @author Generated by Claude Code
 * @since 2.0
 */
@DisplayName("Order Fulfillment Saga - Stock Unavailable Path Integration")
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
@TestMethodOrder(MethodOrderer.OrderAnnotation.class)
class OrderFulfillmentSagaStockFailureTest {

    private HazelcastInstance hazelcast;
    private SagaStateStore sagaStateStore;

    // Test data
    private final String sagaId = UUID.randomUUID().toString();
    private final String correlationId = UUID.randomUUID().toString();

    @BeforeAll
    void setUp() {
        Config config = new Config();
        config.setClusterName("saga-stock-failure-test-" + System.currentTimeMillis());
        hazelcast = Hazelcast.newHazelcastInstance(config);

        sagaStateStore = new HazelcastSagaStateStore(hazelcast, new SimpleMeterRegistry());
    }

    @AfterAll
    void tearDown() {
        if (hazelcast != null) {
            hazelcast.shutdown();
        }
    }

    @Test
    @DisplayName("should start saga and complete step 0 (OrderCreated)")
    @org.junit.jupiter.api.Order(1)
    void shouldStartSagaAndCompleteStep0() {
        // Start saga
        SagaState state = sagaStateStore.startSaga(
                sagaId,
                SagaCompensationConfig.ORDER_FULFILLMENT_SAGA,
                correlationId,
                4,
                Duration.ofSeconds(60)
        );

        assertNotNull(state);
        assertEquals(SagaStatus.STARTED, state.getStatus());

        // Record step 0 completed (OrderCreated published)
        state = sagaStateStore.recordStepCompleted(
                sagaId,
                SagaCompensationConfig.STEP_ORDER_CREATED,
                SagaCompensationConfig.ORDER_CREATED,
                SagaCompensationConfig.ORDER_SERVICE,
                "evt-order-created"
        );

        assertEquals(SagaStatus.IN_PROGRESS, state.getStatus());
        assertEquals(1, state.getCurrentStep());
    }

    @Test
    @DisplayName("should transition to COMPENSATING when stock reservation fails")
    @org.junit.jupiter.api.Order(2)
    void shouldTransitionToCompensatingWhenStockFails() {
        // Step 1 FAILS - Insufficient stock
        SagaState state = sagaStateStore.recordStepFailed(
                sagaId,
                SagaCompensationConfig.STEP_STOCK_RESERVED,
                "InsufficientStock",
                SagaCompensationConfig.INVENTORY_SERVICE,
                "Product SKU-001 out of stock"
        );

        assertEquals(SagaStatus.COMPENSATING, state.getStatus());
        assertEquals("Product SKU-001 out of stock", state.getFailureReason());
        assertEquals(SagaCompensationConfig.STEP_STOCK_RESERVED, state.getFailedAtStep());
    }

    @Test
    @DisplayName("should compensate step 0 with OrderCancelled")
    @org.junit.jupiter.api.Order(3)
    void shouldCompensateStep0WithOrderCancelled() {
        // Only step 0 needs compensation (stock was never reserved)
        SagaState state = sagaStateStore.recordCompensationStep(
                sagaId,
                SagaCompensationConfig.STEP_ORDER_CREATED,
                SagaCompensationConfig.ORDER_CANCELLED,
                SagaCompensationConfig.ORDER_SERVICE
        );

        assertEquals(SagaStatus.COMPENSATING, state.getStatus());
    }

    @Test
    @DisplayName("should complete saga as COMPENSATED")
    @org.junit.jupiter.api.Order(4)
    void shouldCompleteSagaAsCompensated() {
        SagaState state = sagaStateStore.completeSaga(sagaId, SagaStatus.COMPENSATED);

        assertEquals(SagaStatus.COMPENSATED, state.getStatus());
        assertTrue(state.getStatus().isTerminal());
        assertTrue(state.getStatus().isFailure());
        assertNotNull(state.getCompletedAt());
    }

    @Test
    @DisplayName("should track failure reason in final state")
    @org.junit.jupiter.api.Order(5)
    void shouldTrackFailureReasonInFinalState() {
        Optional<SagaState> sagaOpt = sagaStateStore.getSagaState(sagaId);
        assertTrue(sagaOpt.isPresent());

        SagaState finalState = sagaOpt.get();
        assertEquals(SagaStatus.COMPENSATED, finalState.getStatus());
        assertEquals("Product SKU-001 out of stock", finalState.getFailureReason());
        assertEquals(SagaCompensationConfig.STEP_STOCK_RESERVED, finalState.getFailedAtStep());
    }

    @Test
    @DisplayName("should verify no stock release was needed")
    @org.junit.jupiter.api.Order(6)
    void shouldVerifyNoStockReleaseNeeded() {
        // Since stock was never reserved, only step 0 (OrderCreated) needed compensation.
        // Verify that the saga's steps needing compensation from the failed state
        // would only include step 0 (the only completed step before failure).
        Optional<SagaState> sagaOpt = sagaStateStore.getSagaState(sagaId);
        assertTrue(sagaOpt.isPresent());

        SagaState finalState = sagaOpt.get();
        // The failed step was step 1 (StockReserved), so only step 0 needed compensation
        assertEquals(SagaCompensationConfig.STEP_STOCK_RESERVED, finalState.getFailedAtStep());

        // Verify this saga is not active
        List<SagaState> activeSagas = sagaStateStore.findActiveSagas();
        assertTrue(activeSagas.stream().noneMatch(s -> s.getSagaId().equals(sagaId)));
    }

    @Test
    @DisplayName("should find stock failure saga by status and type")
    @org.junit.jupiter.api.Order(7)
    void shouldFindStockFailureSagaByStatusAndType() {
        List<SagaState> compensatedSagas = sagaStateStore.findSagasByStatus(SagaStatus.COMPENSATED);
        assertTrue(compensatedSagas.stream().anyMatch(s -> s.getSagaId().equals(sagaId)));

        List<SagaState> orderSagas = sagaStateStore.findSagasByType(
                SagaCompensationConfig.ORDER_FULFILLMENT_SAGA);
        assertTrue(orderSagas.stream().anyMatch(s -> s.getSagaId().equals(sagaId)));
    }
}
