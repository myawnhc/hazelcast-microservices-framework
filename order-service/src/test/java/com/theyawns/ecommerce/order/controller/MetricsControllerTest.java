package com.theyawns.ecommerce.order.controller;

import com.theyawns.framework.saga.SagaStateStore;
import com.theyawns.framework.saga.SagaStatus;
import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.Gauge;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.search.RequiredSearch;
import io.micrometer.core.instrument.simple.SimpleMeterRegistry;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.ResponseEntity;

import java.util.Map;
import java.util.concurrent.atomic.AtomicLong;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.mockito.Mockito.when;

/**
 * Tests for {@link MetricsController}.
 *
 * @author Generated by Claude Code
 * @since 2.0
 */
@DisplayName("MetricsController")
@ExtendWith(MockitoExtension.class)
class MetricsControllerTest {

    @Mock
    private SagaStateStore sagaStateStore;

    private MeterRegistry meterRegistry;
    private MetricsController metricsController;

    @BeforeEach
    void setUp() {
        meterRegistry = new SimpleMeterRegistry();
        metricsController = new MetricsController(sagaStateStore, meterRegistry);
    }

    @Test
    @DisplayName("should return saga counts by status")
    void shouldReturnSagaCounts() {
        when(sagaStateStore.count()).thenReturn(15L);
        when(sagaStateStore.countByStatus(SagaStatus.STARTED)).thenReturn(1L);
        when(sagaStateStore.countByStatus(SagaStatus.IN_PROGRESS)).thenReturn(2L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPLETED)).thenReturn(8L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPENSATING)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPENSATED)).thenReturn(1L);
        when(sagaStateStore.countByStatus(SagaStatus.FAILED)).thenReturn(2L);
        when(sagaStateStore.countByStatus(SagaStatus.TIMED_OUT)).thenReturn(1L);

        ResponseEntity<Map<String, Object>> response = metricsController.getMetricsSummary();

        assertEquals(200, response.getStatusCode().value());
        Map<String, Object> body = response.getBody();
        assertNotNull(body);

        @SuppressWarnings("unchecked")
        Map<String, Object> sagas = (Map<String, Object>) body.get("sagas");
        assertNotNull(sagas);
        assertEquals(15L, sagas.get("total"));
        assertEquals(8L, sagas.get("completed"));
        assertEquals(2L, sagas.get("failed"));
        assertEquals(1L, sagas.get("timedOut"));
    }

    @Test
    @DisplayName("should return event metrics from meter registry")
    void shouldReturnEventMetrics() {
        // Register some counters
        Counter submitted = meterRegistry.counter("events.submitted");
        submitted.increment(50);
        Counter processed = meterRegistry.counter("events.processed");
        processed.increment(48);
        Counter failed = meterRegistry.counter("events.failed");
        failed.increment(2);

        when(sagaStateStore.count()).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.STARTED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.IN_PROGRESS)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPLETED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPENSATING)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPENSATED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.FAILED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.TIMED_OUT)).thenReturn(0L);

        ResponseEntity<Map<String, Object>> response = metricsController.getMetricsSummary();

        Map<String, Object> body = response.getBody();
        assertNotNull(body);

        @SuppressWarnings("unchecked")
        Map<String, Object> events = (Map<String, Object>) body.get("events");
        assertNotNull(events);
        assertEquals(50.0, events.get("eventsSubmitted"));
        assertEquals(48.0, events.get("eventsProcessed"));
        assertEquals(2.0, events.get("eventsFailed"));
    }

    @Test
    @DisplayName("should return gauge values")
    void shouldReturnGaugeValues() {
        // Register gauges
        AtomicLong activeCount = new AtomicLong(3);
        AtomicLong compensatingCount = new AtomicLong(1);
        meterRegistry.gauge("sagas.active.count", activeCount);
        meterRegistry.gauge("sagas.compensating.count", compensatingCount);

        when(sagaStateStore.count()).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.STARTED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.IN_PROGRESS)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPLETED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPENSATING)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPENSATED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.FAILED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.TIMED_OUT)).thenReturn(0L);

        ResponseEntity<Map<String, Object>> response = metricsController.getMetricsSummary();

        Map<String, Object> body = response.getBody();
        assertNotNull(body);

        @SuppressWarnings("unchecked")
        Map<String, Object> gauges = (Map<String, Object>) body.get("gauges");
        assertNotNull(gauges);
        assertEquals(3.0, gauges.get("activeSagas"));
        assertEquals(1.0, gauges.get("compensatingSagas"));
    }

    @Test
    @DisplayName("should return zeros when no metrics registered")
    void shouldReturnZerosWhenNoMetrics() {
        when(sagaStateStore.count()).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.STARTED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.IN_PROGRESS)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPLETED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPENSATING)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.COMPENSATED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.FAILED)).thenReturn(0L);
        when(sagaStateStore.countByStatus(SagaStatus.TIMED_OUT)).thenReturn(0L);

        ResponseEntity<Map<String, Object>> response = metricsController.getMetricsSummary();

        Map<String, Object> body = response.getBody();
        assertNotNull(body);

        @SuppressWarnings("unchecked")
        Map<String, Object> events = (Map<String, Object>) body.get("events");
        assertEquals(0.0, events.get("eventsSubmitted"));

        @SuppressWarnings("unchecked")
        Map<String, Object> gauges = (Map<String, Object>) body.get("gauges");
        assertEquals(0.0, gauges.get("activeSagas"));
    }
}
