package com.theyawns.ecommerce.common.domain;

import com.hazelcast.nio.serialization.genericrecord.GenericRecord;
import com.hazelcast.nio.serialization.genericrecord.GenericRecordBuilder;
import com.theyawns.framework.domain.DomainObject;
import com.theyawns.ecommerce.common.dto.OrderDTO;
import com.theyawns.ecommerce.common.dto.OrderLineItemDTO;

import java.math.BigDecimal;
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

/**
 * Order domain object representing a customer order.
 *
 * <p>State is derived from applying order events:
 * <ul>
 *   <li>OrderCreatedEvent - creates a new order</li>
 *   <li>OrderConfirmedEvent - confirms the order (stock reserved)</li>
 *   <li>OrderShippedEvent - marks the order as shipped</li>
 *   <li>OrderDeliveredEvent - marks the order as delivered</li>
 *   <li>OrderCancelledEvent - cancels the order</li>
 * </ul>
 *
 * @author Generated by Claude Code
 * @since 1.0
 */
public class Order implements DomainObject<String> {

    private static final long serialVersionUID = 1L;
    public static final String SCHEMA_NAME = "Order";

    /**
     * Order status enumeration.
     */
    public enum Status {
        PENDING,        // Order created, awaiting confirmation
        CONFIRMED,      // Stock reserved, payment verified
        PROCESSING,     // Being prepared for shipment
        SHIPPED,        // Shipped to customer
        DELIVERED,      // Delivered to customer
        CANCELLED       // Order cancelled
    }

    private String orderId;
    private String customerId;
    private String customerName;
    private String customerEmail;
    private List<OrderLineItem> lineItems = new ArrayList<>();
    private BigDecimal subtotal;
    private BigDecimal tax;
    private BigDecimal total;
    private String shippingAddress;
    private Status status;
    private Instant createdAt;
    private Instant updatedAt;

    /**
     * Default constructor.
     */
    public Order() {
    }

    /**
     * Constructor for new order creation.
     *
     * @param orderId the unique order ID
     * @param customerId the customer ID
     * @param lineItems the order line items
     */
    public Order(String orderId, String customerId, List<OrderLineItem> lineItems) {
        this.orderId = orderId;
        this.customerId = customerId;
        this.lineItems = lineItems != null ? lineItems : new ArrayList<>();
        this.status = Status.PENDING;
        this.createdAt = Instant.now();
        this.updatedAt = this.createdAt;
        calculateTotals();
    }

    /**
     * Creates an Order from a GenericRecord.
     *
     * @param record the GenericRecord to hydrate from
     * @return the hydrated Order
     */
    public static Order fromGenericRecord(GenericRecord record) {
        if (record == null) {
            return null;
        }
        Order order = new Order();
        order.orderId = record.getString("orderId");
        order.customerId = record.getString("customerId");
        order.customerName = record.getString("customerName");
        order.customerEmail = record.getString("customerEmail");
        order.shippingAddress = record.getString("shippingAddress");

        String subtotalStr = record.getString("subtotal");
        order.subtotal = subtotalStr != null ? new BigDecimal(subtotalStr) : null;

        String taxStr = record.getString("tax");
        order.tax = taxStr != null ? new BigDecimal(taxStr) : null;

        String totalStr = record.getString("total");
        order.total = totalStr != null ? new BigDecimal(totalStr) : null;

        String statusStr = record.getString("status");
        order.status = statusStr != null ? Status.valueOf(statusStr) : Status.PENDING;

        Long createdAtMs = record.getInt64("createdAt");
        order.createdAt = createdAtMs != null && createdAtMs != 0 ? Instant.ofEpochMilli(createdAtMs) : null;

        Long updatedAtMs = record.getInt64("updatedAt");
        order.updatedAt = updatedAtMs != null && updatedAtMs != 0 ? Instant.ofEpochMilli(updatedAtMs) : null;

        // Line items are stored as an array of GenericRecords
        GenericRecord[] itemRecords = record.getArrayOfGenericRecord("lineItems");
        if (itemRecords != null) {
            order.lineItems = new ArrayList<>();
            for (GenericRecord itemRecord : itemRecords) {
                order.lineItems.add(OrderLineItem.fromGenericRecord(itemRecord));
            }
        }

        return order;
    }

    @Override
    public String getKey() {
        return orderId;
    }

    @Override
    public GenericRecord toGenericRecord() {
        GenericRecord[] itemRecords = lineItems.stream()
                .map(OrderLineItem::toGenericRecord)
                .toArray(GenericRecord[]::new);

        return GenericRecordBuilder.compact(SCHEMA_NAME)
                .setString("orderId", orderId)
                .setString("customerId", customerId)
                .setString("customerName", customerName)
                .setString("customerEmail", customerEmail)
                .setArrayOfGenericRecord("lineItems", itemRecords)
                .setString("subtotal", subtotal != null ? subtotal.toString() : null)
                .setString("tax", tax != null ? tax.toString() : null)
                .setString("total", total != null ? total.toString() : null)
                .setString("shippingAddress", shippingAddress)
                .setString("status", status != null ? status.name() : null)
                .setInt64("createdAt", createdAt != null ? createdAt.toEpochMilli() : 0)
                .setInt64("updatedAt", updatedAt != null ? updatedAt.toEpochMilli() : 0)
                .build();
    }

    @Override
    public String getSchemaName() {
        return SCHEMA_NAME;
    }

    /**
     * Calculates subtotal, tax (10%), and total from line items.
     */
    public void calculateTotals() {
        this.subtotal = lineItems.stream()
                .map(OrderLineItem::getLineTotal)
                .filter(Objects::nonNull)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        this.tax = subtotal.multiply(new BigDecimal("0.10"));
        this.total = subtotal.add(tax);
    }

    /**
     * Adds a line item to the order.
     *
     * @param lineItem the line item to add
     */
    public void addLineItem(OrderLineItem lineItem) {
        if (lineItems == null) {
            lineItems = new ArrayList<>();
        }
        lineItems.add(lineItem);
        calculateTotals();
    }

    /**
     * Converts this Order to a DTO.
     *
     * @return the OrderDTO
     */
    public OrderDTO toDTO() {
        OrderDTO dto = new OrderDTO();
        dto.setOrderId(orderId);
        dto.setCustomerId(customerId);
        dto.setCustomerName(customerName);
        dto.setCustomerEmail(customerEmail);
        dto.setLineItems(lineItems.stream()
                .map(OrderLineItem::toDTO)
                .collect(Collectors.toList()));
        dto.setSubtotal(subtotal);
        dto.setTax(tax);
        dto.setTotal(total);
        dto.setShippingAddress(shippingAddress);
        dto.setStatus(status != null ? status.name() : null);
        dto.setCreatedAt(createdAt);
        dto.setUpdatedAt(updatedAt);
        return dto;
    }

    // Getters and Setters

    public String getOrderId() {
        return orderId;
    }

    public void setOrderId(String orderId) {
        this.orderId = orderId;
    }

    public String getCustomerId() {
        return customerId;
    }

    public void setCustomerId(String customerId) {
        this.customerId = customerId;
    }

    public String getCustomerName() {
        return customerName;
    }

    public void setCustomerName(String customerName) {
        this.customerName = customerName;
    }

    public String getCustomerEmail() {
        return customerEmail;
    }

    public void setCustomerEmail(String customerEmail) {
        this.customerEmail = customerEmail;
    }

    public List<OrderLineItem> getLineItems() {
        return lineItems;
    }

    public void setLineItems(List<OrderLineItem> lineItems) {
        this.lineItems = lineItems != null ? lineItems : new ArrayList<>();
        calculateTotals();
    }

    public BigDecimal getSubtotal() {
        return subtotal;
    }

    public void setSubtotal(BigDecimal subtotal) {
        this.subtotal = subtotal;
    }

    public BigDecimal getTax() {
        return tax;
    }

    public void setTax(BigDecimal tax) {
        this.tax = tax;
    }

    public BigDecimal getTotal() {
        return total;
    }

    public void setTotal(BigDecimal total) {
        this.total = total;
    }

    public String getShippingAddress() {
        return shippingAddress;
    }

    public void setShippingAddress(String shippingAddress) {
        this.shippingAddress = shippingAddress;
    }

    public Status getStatus() {
        return status;
    }

    public void setStatus(Status status) {
        this.status = status;
    }

    public Instant getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(Instant createdAt) {
        this.createdAt = createdAt;
    }

    public Instant getUpdatedAt() {
        return updatedAt;
    }

    public void setUpdatedAt(Instant updatedAt) {
        this.updatedAt = updatedAt;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Order order = (Order) o;
        return Objects.equals(orderId, order.orderId);
    }

    @Override
    public int hashCode() {
        return Objects.hash(orderId);
    }

    @Override
    public String toString() {
        return "Order{" +
                "orderId='" + orderId + '\'' +
                ", customerId='" + customerId + '\'' +
                ", itemCount=" + (lineItems != null ? lineItems.size() : 0) +
                ", total=" + total +
                ", status=" + status +
                '}';
    }
}
