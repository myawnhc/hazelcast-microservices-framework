package com.theyawns.ecommerce.common.events;

import com.hazelcast.nio.serialization.genericrecord.GenericRecord;
import com.hazelcast.nio.serialization.genericrecord.GenericRecordBuilder;
import com.theyawns.framework.event.DomainEvent;
import com.theyawns.framework.saga.SagaCompensationConfig;
import com.theyawns.framework.saga.SagaEvent;
import com.theyawns.ecommerce.common.domain.Payment;

import java.math.BigDecimal;
import java.time.Instant;

/**
 * Event representing a successfully processed payment.
 *
 * <p>When payment is captured for an order, this event records:
 * <ul>
 *   <li>The payment amount and currency</li>
 *   <li>The external transaction ID from the payment processor</li>
 *   <li>The associated order and customer</li>
 * </ul>
 *
 * <p>In the Order Fulfillment saga, this is Step 2. If the saga fails
 * after this point, this event is compensated by {@link PaymentRefundedEvent}.
 *
 * @author Generated by Claude Code
 * @since 2.0
 * @see PaymentRefundedEvent
 * @see SagaEvent
 */
public class PaymentProcessedEvent extends DomainEvent<Payment, String>
        implements SagaEvent<Payment, String> {

    private static final long serialVersionUID = 1L;
    public static final String SCHEMA_NAME = "PaymentProcessedEvent";
    public static final String EVENT_TYPE = "PaymentProcessed";

    private String orderId;
    private String customerId;
    private String amount;
    private String currency;
    private String transactionId;
    private String method;

    /**
     * Default constructor for serialization.
     */
    public PaymentProcessedEvent() {
        super();
        this.eventType = EVENT_TYPE;
    }

    /**
     * Creates a new PaymentProcessedEvent.
     *
     * @param paymentId the payment ID
     * @param orderId the order ID
     * @param customerId the customer ID
     * @param amount the payment amount
     * @param currency the currency code
     * @param transactionId the external transaction ID
     * @param method the payment method
     */
    public PaymentProcessedEvent(String paymentId, String orderId, String customerId,
                                  BigDecimal amount, String currency,
                                  String transactionId, String method) {
        super(paymentId);
        this.eventType = EVENT_TYPE;
        this.orderId = orderId;
        this.customerId = customerId;
        this.amount = amount != null ? amount.toString() : null;
        this.currency = currency;
        this.transactionId = transactionId;
        this.method = method;
    }

    /**
     * Creates a PaymentProcessedEvent from a GenericRecord.
     *
     * @param record the GenericRecord to hydrate from
     * @return the hydrated event
     */
    public static PaymentProcessedEvent fromGenericRecord(GenericRecord record) {
        if (record == null) {
            return null;
        }
        PaymentProcessedEvent event = new PaymentProcessedEvent();
        event.eventId = record.getString("eventId");
        event.eventType = record.getString("eventType");
        event.eventVersion = record.getString("eventVersion");
        event.source = record.getString("source");
        event.key = record.getString("key");
        event.correlationId = record.getString("correlationId");

        Long timestampMs = record.getInt64("timestamp");
        event.timestamp = timestampMs != null && timestampMs != 0 ? Instant.ofEpochMilli(timestampMs) : null;

        event.orderId = record.getString("orderId");
        event.customerId = record.getString("customerId");
        event.amount = record.getString("amount");
        event.currency = record.getString("currency");
        event.transactionId = record.getString("transactionId");
        event.method = record.getString("method");

        // Saga fields
        event.sagaId = record.getString("sagaId");
        event.sagaType = record.getString("sagaType");
        event.stepNumber = record.getInt32("stepNumber");
        event.isCompensating = record.getBoolean("isCompensating");

        return event;
    }

    @Override
    public GenericRecord toGenericRecord() {
        return GenericRecordBuilder.compact(SCHEMA_NAME)
                .setString("eventId", eventId)
                .setString("eventType", eventType)
                .setString("eventVersion", eventVersion)
                .setString("source", source)
                .setInt64("timestamp", timestamp != null ? timestamp.toEpochMilli() : 0)
                .setString("key", key)
                .setString("correlationId", correlationId)
                .setString("sagaId", sagaId)
                .setString("sagaType", sagaType)
                .setInt32("stepNumber", stepNumber != null ? stepNumber : 0)
                .setBoolean("isCompensating", isCompensating != null && isCompensating)
                .setString("orderId", orderId)
                .setString("customerId", customerId)
                .setString("amount", amount)
                .setString("currency", currency)
                .setString("transactionId", transactionId)
                .setString("method", method)
                .build();
    }

    @Override
    public GenericRecord apply(GenericRecord currentState) {
        // PaymentProcessed creates the payment view entry
        Instant now = Instant.now();
        return GenericRecordBuilder.compact(Payment.SCHEMA_NAME)
                .setString("paymentId", key)
                .setString("orderId", orderId)
                .setString("customerId", customerId)
                .setString("amount", amount)
                .setString("currency", currency)
                .setString("method", method)
                .setString("status", Payment.PaymentStatus.CAPTURED.name())
                .setString("transactionId", transactionId)
                .setInt64("processedAt", now.toEpochMilli())
                .setString("failureReason", null)
                .setInt64("createdAt", now.toEpochMilli())
                .setInt64("updatedAt", now.toEpochMilli())
                .build();
    }

    @Override
    public String getSchemaName() {
        return SCHEMA_NAME;
    }

    // Getters and Setters

    public String getOrderId() {
        return orderId;
    }

    public void setOrderId(String orderId) {
        this.orderId = orderId;
    }

    public String getCustomerId() {
        return customerId;
    }

    public void setCustomerId(String customerId) {
        this.customerId = customerId;
    }

    public String getAmount() {
        return amount;
    }

    public void setAmount(String amount) {
        this.amount = amount;
    }

    public String getCurrency() {
        return currency;
    }

    public void setCurrency(String currency) {
        this.currency = currency;
    }

    public String getTransactionId() {
        return transactionId;
    }

    public void setTransactionId(String transactionId) {
        this.transactionId = transactionId;
    }

    public String getMethod() {
        return method;
    }

    public void setMethod(String method) {
        this.method = method;
    }

    @Override
    public String toString() {
        return "PaymentProcessedEvent{" +
                "eventId='" + eventId + '\'' +
                ", paymentId='" + key + '\'' +
                ", orderId='" + orderId + '\'' +
                ", amount='" + amount + '\'' +
                ", transactionId='" + transactionId + '\'' +
                '}';
    }

    // SagaEvent interface implementation

    /**
     * Returns step 2 - PaymentProcessed is the third step in the Order Fulfillment saga.
     *
     * @return 2 (third step)
     */
    @Override
    public int getSagaStepNumber() {
        return SagaCompensationConfig.STEP_PAYMENT_PROCESSED;
    }

    /**
     * Returns "PaymentRefunded" as the compensating event type.
     *
     * @return the compensating event type
     */
    @Override
    public String getCompensatingEventType() {
        return SagaCompensationConfig.PAYMENT_REFUNDED;
    }

    /**
     * PaymentProcessedEvent is a forward event, not a compensation event.
     *
     * @return false
     */
    @Override
    public boolean isCompensatingEvent() {
        return false;
    }

    /**
     * Returns the saga type name for Order Fulfillment.
     *
     * @return "OrderFulfillment"
     */
    @Override
    public String getSagaTypeName() {
        return SagaCompensationConfig.ORDER_FULFILLMENT_SAGA;
    }
}
