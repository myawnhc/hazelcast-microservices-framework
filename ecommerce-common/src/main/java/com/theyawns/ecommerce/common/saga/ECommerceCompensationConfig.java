package com.theyawns.ecommerce.common.saga;

import com.theyawns.framework.saga.CompensationRegistry;
import com.theyawns.framework.saga.SagaCompensationConfig;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;

import jakarta.annotation.PostConstruct;

/**
 * Configures compensation mappings for eCommerce domain events.
 * Registers the event pairs for the Order Fulfillment saga.
 *
 * <p>The Order Fulfillment saga has the following steps:
 * <ol>
 *   <li>OrderCreated (order-service) - Step 0</li>
 *   <li>StockReserved (inventory-service) - Step 1</li>
 *   <li>PaymentProcessed (payment-service) - Step 2</li>
 *   <li>OrderConfirmed (order-service) - Step 3</li>
 * </ol>
 *
 * <p>Compensation events (executed in reverse order on failure):
 * <ul>
 *   <li>PaymentProcessed -&gt; PaymentRefunded</li>
 *   <li>StockReserved -&gt; StockReleased</li>
 *   <li>OrderCreated -&gt; OrderCancelled</li>
 * </ul>
 *
 * @author Generated by Claude Code
 * @since 2.0
 * @see CompensationRegistry
 * @see SagaCompensationConfig
 */
@Configuration
public class ECommerceCompensationConfig {

    private static final Logger logger = LoggerFactory.getLogger(ECommerceCompensationConfig.class);

    private final CompensationRegistry compensationRegistry;

    /**
     * Creates the eCommerce compensation configuration.
     *
     * @param compensationRegistry the registry to configure
     */
    @Autowired
    public ECommerceCompensationConfig(CompensationRegistry compensationRegistry) {
        this.compensationRegistry = compensationRegistry;
    }

    /**
     * Registers all eCommerce compensation mappings on startup.
     */
    @PostConstruct
    public void registerCompensations() {
        logger.info("Registering eCommerce compensation mappings");

        // Order Fulfillment Saga compensations
        registerOrderFulfillmentCompensations();

        logger.info("Registered {} compensation mappings", compensationRegistry.size());
    }

    /**
     * Registers compensation mappings for the Order Fulfillment saga.
     *
     * <p>Saga flow:
     * <pre>
     * Step 0: OrderCreated (order-service)
     *    |
     *    v
     * Step 1: StockReserved (inventory-service)
     *    |
     *    v
     * Step 2: PaymentProcessed (payment-service)
     *    |
     *    v
     * Step 3: OrderConfirmed (order-service) - Final step, no compensation
     * </pre>
     *
     * <p>On failure at any step, compensate in reverse:
     * <pre>
     * PaymentProcessed -> PaymentRefunded
     * StockReserved -> StockReleased
     * OrderCreated -> OrderCancelled
     * </pre>
     */
    private void registerOrderFulfillmentCompensations() {
        // Step 0: OrderCreated -> OrderCancelled
        compensationRegistry.register(
                SagaCompensationConfig.ORDER_CREATED,
                SagaCompensationConfig.ORDER_CANCELLED,
                SagaCompensationConfig.ORDER_SERVICE,
                SagaCompensationConfig.STEP_ORDER_CREATED
        );

        // Step 1: StockReserved -> StockReleased
        compensationRegistry.register(
                SagaCompensationConfig.STOCK_RESERVED,
                SagaCompensationConfig.STOCK_RELEASED,
                SagaCompensationConfig.INVENTORY_SERVICE,
                SagaCompensationConfig.STEP_STOCK_RESERVED
        );

        // Step 2: PaymentProcessed -> PaymentRefunded
        compensationRegistry.register(
                SagaCompensationConfig.PAYMENT_PROCESSED,
                SagaCompensationConfig.PAYMENT_REFUNDED,
                SagaCompensationConfig.PAYMENT_SERVICE,
                SagaCompensationConfig.STEP_PAYMENT_PROCESSED
        );

        // Step 3: OrderConfirmed - no compensation (final success state)
        // The OrderConfirmed step doesn't need compensation as it's the terminal success state

        logger.debug("Registered Order Fulfillment saga compensations: " +
                "OrderCreated->OrderCancelled, StockReserved->StockReleased, " +
                "PaymentProcessed->PaymentRefunded");
    }
}
