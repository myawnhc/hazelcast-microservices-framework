package com.theyawns.ecommerce.common.domain;

import com.hazelcast.nio.serialization.genericrecord.GenericRecord;
import com.hazelcast.nio.serialization.genericrecord.GenericRecordBuilder;
import com.theyawns.framework.domain.DomainObject;
import com.theyawns.ecommerce.common.dto.PaymentDTO;

import java.math.BigDecimal;
import java.time.Instant;
import java.util.Objects;

/**
 * Payment domain object representing a payment transaction.
 *
 * <p>State is derived from applying payment events:
 * <ul>
 *   <li>PaymentProcessedEvent - creates a captured payment</li>
 *   <li>PaymentFailedEvent - records a failed payment attempt</li>
 *   <li>PaymentRefundedEvent - refunds a previously captured payment</li>
 * </ul>
 *
 * @author Generated by Claude Code
 * @since 2.0
 */
public class Payment implements DomainObject<String> {

    public static final String SCHEMA_NAME = "Payment";

    /**
     * Payment method enumeration.
     */
    public enum PaymentMethod {
        CREDIT_CARD,
        DEBIT_CARD,
        BANK_TRANSFER,
        DIGITAL_WALLET
    }

    /**
     * Payment status enumeration.
     */
    public enum PaymentStatus {
        PENDING,
        AUTHORIZED,
        CAPTURED,
        FAILED,
        REFUNDED
    }

    private String paymentId;
    private String orderId;
    private String customerId;
    private BigDecimal amount;
    private String currency;
    private PaymentMethod method;
    private PaymentStatus status;
    private String transactionId;
    private Instant processedAt;
    private String failureReason;
    private Instant createdAt;
    private Instant updatedAt;

    /**
     * Default constructor.
     */
    public Payment() {
    }

    /**
     * Constructor for new payment creation.
     *
     * @param paymentId the unique payment ID
     * @param orderId the associated order ID
     * @param customerId the customer ID
     * @param amount the payment amount
     * @param currency the currency code (e.g., "USD")
     * @param method the payment method
     */
    public Payment(String paymentId, String orderId, String customerId,
                   BigDecimal amount, String currency, PaymentMethod method) {
        this.paymentId = paymentId;
        this.orderId = orderId;
        this.customerId = customerId;
        this.amount = amount;
        this.currency = currency;
        this.method = method;
        this.status = PaymentStatus.PENDING;
        this.createdAt = Instant.now();
        this.updatedAt = this.createdAt;
    }

    /**
     * Creates a Payment from a GenericRecord.
     *
     * @param record the GenericRecord to hydrate from
     * @return the hydrated Payment
     */
    public static Payment fromGenericRecord(GenericRecord record) {
        if (record == null) {
            return null;
        }
        Payment payment = new Payment();
        payment.paymentId = record.getString("paymentId");
        payment.orderId = record.getString("orderId");
        payment.customerId = record.getString("customerId");

        String amountStr = record.getString("amount");
        payment.amount = amountStr != null ? new BigDecimal(amountStr) : null;

        payment.currency = record.getString("currency");

        String methodStr = record.getString("method");
        payment.method = methodStr != null ? PaymentMethod.valueOf(methodStr) : null;

        String statusStr = record.getString("status");
        payment.status = statusStr != null ? PaymentStatus.valueOf(statusStr) : PaymentStatus.PENDING;

        payment.transactionId = record.getString("transactionId");

        Long processedAtMs = record.getInt64("processedAt");
        payment.processedAt = processedAtMs != null && processedAtMs != 0
                ? Instant.ofEpochMilli(processedAtMs) : null;

        payment.failureReason = record.getString("failureReason");

        Long createdAtMs = record.getInt64("createdAt");
        payment.createdAt = createdAtMs != null && createdAtMs != 0
                ? Instant.ofEpochMilli(createdAtMs) : null;

        Long updatedAtMs = record.getInt64("updatedAt");
        payment.updatedAt = updatedAtMs != null && updatedAtMs != 0
                ? Instant.ofEpochMilli(updatedAtMs) : null;

        return payment;
    }

    @Override
    public String getKey() {
        return paymentId;
    }

    @Override
    public GenericRecord toGenericRecord() {
        return GenericRecordBuilder.compact(SCHEMA_NAME)
                .setString("paymentId", paymentId)
                .setString("orderId", orderId)
                .setString("customerId", customerId)
                .setString("amount", amount != null ? amount.toString() : null)
                .setString("currency", currency)
                .setString("method", method != null ? method.name() : null)
                .setString("status", status != null ? status.name() : null)
                .setString("transactionId", transactionId)
                .setInt64("processedAt", processedAt != null ? processedAt.toEpochMilli() : 0)
                .setString("failureReason", failureReason)
                .setInt64("createdAt", createdAt != null ? createdAt.toEpochMilli() : 0)
                .setInt64("updatedAt", updatedAt != null ? updatedAt.toEpochMilli() : 0)
                .build();
    }

    @Override
    public String getSchemaName() {
        return SCHEMA_NAME;
    }

    /**
     * Checks if this payment can be refunded.
     *
     * @return true if the payment is in CAPTURED status
     */
    public boolean canRefund() {
        return status == PaymentStatus.CAPTURED;
    }

    /**
     * Converts this Payment to a DTO.
     *
     * @return the PaymentDTO
     */
    public PaymentDTO toDTO() {
        return new PaymentDTO(
                paymentId,
                orderId,
                customerId,
                amount,
                currency,
                method != null ? method.name() : null,
                status != null ? status.name() : null,
                transactionId,
                failureReason
        );
    }

    // Getters and Setters

    public String getPaymentId() {
        return paymentId;
    }

    public void setPaymentId(String paymentId) {
        this.paymentId = paymentId;
    }

    public String getOrderId() {
        return orderId;
    }

    public void setOrderId(String orderId) {
        this.orderId = orderId;
    }

    public String getCustomerId() {
        return customerId;
    }

    public void setCustomerId(String customerId) {
        this.customerId = customerId;
    }

    public BigDecimal getAmount() {
        return amount;
    }

    public void setAmount(BigDecimal amount) {
        this.amount = amount;
    }

    public String getCurrency() {
        return currency;
    }

    public void setCurrency(String currency) {
        this.currency = currency;
    }

    public PaymentMethod getMethod() {
        return method;
    }

    public void setMethod(PaymentMethod method) {
        this.method = method;
    }

    public PaymentStatus getStatus() {
        return status;
    }

    public void setStatus(PaymentStatus status) {
        this.status = status;
    }

    public String getTransactionId() {
        return transactionId;
    }

    public void setTransactionId(String transactionId) {
        this.transactionId = transactionId;
    }

    public Instant getProcessedAt() {
        return processedAt;
    }

    public void setProcessedAt(Instant processedAt) {
        this.processedAt = processedAt;
    }

    public String getFailureReason() {
        return failureReason;
    }

    public void setFailureReason(String failureReason) {
        this.failureReason = failureReason;
    }

    public Instant getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(Instant createdAt) {
        this.createdAt = createdAt;
    }

    public Instant getUpdatedAt() {
        return updatedAt;
    }

    public void setUpdatedAt(Instant updatedAt) {
        this.updatedAt = updatedAt;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Payment payment = (Payment) o;
        return Objects.equals(paymentId, payment.paymentId);
    }

    @Override
    public int hashCode() {
        return Objects.hash(paymentId);
    }

    @Override
    public String toString() {
        return "Payment{" +
                "paymentId='" + paymentId + '\'' +
                ", orderId='" + orderId + '\'' +
                ", amount=" + amount +
                ", currency='" + currency + '\'' +
                ", status=" + status +
                '}';
    }
}
