package com.theyawns.ecommerce.common.util;

import com.hazelcast.nio.serialization.genericrecord.GenericRecord;
import com.hazelcast.nio.serialization.genericrecord.GenericRecordBuilder;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.util.List;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertNull;
import static org.junit.jupiter.api.Assertions.assertTrue;

/**
 * Tests for {@link GenericRecordConverter}.
 *
 * @author Generated by Claude Code
 * @since 2.0
 */
@DisplayName("GenericRecordConverter")
class GenericRecordConverterTest {

    @Test
    @DisplayName("should convert null record to empty map")
    void shouldConvertNullToEmptyMap() {
        Map<String, Object> result = GenericRecordConverter.toMap(null);
        assertNotNull(result);
        assertTrue(result.isEmpty());
    }

    @Test
    @DisplayName("should convert record with string fields")
    void shouldConvertStringFields() {
        GenericRecord record = GenericRecordBuilder.compact("TestRecord")
                .setString("name", "Alice")
                .setString("email", "alice@example.com")
                .build();

        Map<String, Object> result = GenericRecordConverter.toMap(record);

        assertEquals("Alice", result.get("name"));
        assertEquals("alice@example.com", result.get("email"));
    }

    @Test
    @DisplayName("should convert record with numeric fields")
    void shouldConvertNumericFields() {
        GenericRecord record = GenericRecordBuilder.compact("TestRecord")
                .setInt32("quantity", 42)
                .setInt64("timestamp", 1234567890L)
                .setFloat32("score", 3.14f)
                .setFloat64("amount", 99.99)
                .build();

        Map<String, Object> result = GenericRecordConverter.toMap(record);

        assertEquals(42, result.get("quantity"));
        assertEquals(1234567890L, result.get("timestamp"));
        assertEquals(3.14f, result.get("score"));
        assertEquals(99.99, result.get("amount"));
    }

    @Test
    @DisplayName("should convert record with boolean field")
    void shouldConvertBooleanField() {
        GenericRecord record = GenericRecordBuilder.compact("TestRecord")
                .setBoolean("active", true)
                .build();

        Map<String, Object> result = GenericRecordConverter.toMap(record);

        assertEquals(true, result.get("active"));
    }

    @Test
    @DisplayName("should convert nested GenericRecord")
    void shouldConvertNestedRecord() {
        GenericRecord nested = GenericRecordBuilder.compact("Address")
                .setString("city", "New York")
                .setString("state", "NY")
                .build();

        GenericRecord record = GenericRecordBuilder.compact("Customer")
                .setString("name", "Bob")
                .setGenericRecord("address", nested)
                .build();

        Map<String, Object> result = GenericRecordConverter.toMap(record);

        assertEquals("Bob", result.get("name"));
        @SuppressWarnings("unchecked")
        Map<String, Object> addressMap = (Map<String, Object>) result.get("address");
        assertNotNull(addressMap);
        assertEquals("New York", addressMap.get("city"));
        assertEquals("NY", addressMap.get("state"));
    }

    @Test
    @DisplayName("should convert array of GenericRecords")
    void shouldConvertArrayOfRecords() {
        GenericRecord item1 = GenericRecordBuilder.compact("LineItem")
                .setString("productId", "p1")
                .setInt32("quantity", 2)
                .build();
        GenericRecord item2 = GenericRecordBuilder.compact("LineItem")
                .setString("productId", "p2")
                .setInt32("quantity", 1)
                .build();

        GenericRecord record = GenericRecordBuilder.compact("Order")
                .setString("orderId", "o1")
                .setArrayOfGenericRecord("lineItems", new GenericRecord[]{item1, item2})
                .build();

        Map<String, Object> result = GenericRecordConverter.toMap(record);

        assertEquals("o1", result.get("orderId"));
        @SuppressWarnings("unchecked")
        List<Map<String, Object>> items = (List<Map<String, Object>>) result.get("lineItems");
        assertNotNull(items);
        assertEquals(2, items.size());
        assertEquals("p1", items.get(0).get("productId"));
        assertEquals(2, items.get(0).get("quantity"));
        assertEquals("p2", items.get(1).get("productId"));
    }

    @Test
    @DisplayName("should handle null string value")
    void shouldHandleNullStringValue() {
        GenericRecord record = GenericRecordBuilder.compact("TestRecord")
                .setString("name", null)
                .build();

        Map<String, Object> result = GenericRecordConverter.toMap(record);

        assertNull(result.get("name"));
    }

    @Test
    @DisplayName("should convert mixed field types")
    void shouldConvertMixedFieldTypes() {
        GenericRecord record = GenericRecordBuilder.compact("Event")
                .setString("eventType", "CustomerCreated")
                .setString("eventId", "evt-1")
                .setInt64("timestamp", 1700000000000L)
                .setBoolean("compensating", false)
                .setInt32("stepNumber", 0)
                .build();

        Map<String, Object> result = GenericRecordConverter.toMap(record);

        assertEquals(5, result.size());
        assertEquals("CustomerCreated", result.get("eventType"));
        assertEquals("evt-1", result.get("eventId"));
        assertEquals(1700000000000L, result.get("timestamp"));
        assertEquals(false, result.get("compensating"));
        assertEquals(0, result.get("stepNumber"));
    }
}
