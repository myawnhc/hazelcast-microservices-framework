# Docker Compose Override: Multi-Replica Order Service with Embedded Clustering
#
# Adds 2 additional order-service replicas (3 total) that form a per-service
# embedded Hazelcast cluster via TCP-IP discovery. An nginx load balancer
# distributes HTTP requests across all 3 replicas.
#
# The API gateway is overridden to route order traffic through the LB.
# Inventory and payment services remain single-replica (they are saga
# participants, not the bottleneck).
#
# Memory: Adds ~4.3GB (2 extra order-service @ 1536M each + nginx @ 64M + LB overhead)
# Total with base stack: ~11.6GB — requires 16GB host.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.clustered.yml \
#     -f docker-compose.multi-replica.yml up -d
#
# IMPORTANT: Must be combined with docker-compose.clustered.yml to enable
# clustering env vars on all services.

services:
  # ============================================
  # Override primary order-service with TCP-IP discovery
  # ============================================

  order-service:
    environment:
      - HAZELCAST_EMBEDDED_CLUSTERING_ENABLED=true
      - HAZELCAST_EMBEDDED_DISCOVERY_MODE=tcp-ip
      - HAZELCAST_EMBEDDED_SERVICE_DNS=order-service:5801,order-service-2:5801,order-service-3:5801
      - HAZELCAST_EMBEDDED_PORT=5801

  # ============================================
  # Additional order-service replicas
  # ============================================

  order-service-2:
    build:
      context: ../order-service
      dockerfile: Dockerfile
    container_name: order-service-2
    hostname: order-service-2
    networks:
      - ecommerce-network
    # No host port mapping — traffic routed via order-lb
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_OPTS=-Xms256m -Xmx1280m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
      - HAZELCAST_CLUSTER_NAME=ecommerce-cluster
      - HAZELCAST_CLUSTER_MEMBERS=hazelcast-1:5701,hazelcast-2:5701,hazelcast-3:5701
      - HAZELCAST_EMBEDDED_CLUSTERING_ENABLED=true
      - HAZELCAST_EMBEDDED_DISCOVERY_MODE=tcp-ip
      - HAZELCAST_EMBEDDED_SERVICE_DNS=order-service:5801,order-service-2:5801,order-service-3:5801
      - HAZELCAST_EMBEDDED_PORT=5801
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=order-service-2
      - HZ_LICENSEKEY=${HZ_LICENSEKEY:-}
      - FRAMEWORK_PERSISTENCE_ENABLED=true
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/ecommerce
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
    depends_on:
      hazelcast-1:
        condition: service_healthy
      hazelcast-2:
        condition: service_healthy
      hazelcast-3:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1536M

  order-service-3:
    build:
      context: ../order-service
      dockerfile: Dockerfile
    container_name: order-service-3
    hostname: order-service-3
    networks:
      - ecommerce-network
    # No host port mapping — traffic routed via order-lb
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_OPTS=-Xms256m -Xmx1280m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
      - HAZELCAST_CLUSTER_NAME=ecommerce-cluster
      - HAZELCAST_CLUSTER_MEMBERS=hazelcast-1:5701,hazelcast-2:5701,hazelcast-3:5701
      - HAZELCAST_EMBEDDED_CLUSTERING_ENABLED=true
      - HAZELCAST_EMBEDDED_DISCOVERY_MODE=tcp-ip
      - HAZELCAST_EMBEDDED_SERVICE_DNS=order-service:5801,order-service-2:5801,order-service-3:5801
      - HAZELCAST_EMBEDDED_PORT=5801
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=order-service-3
      - HZ_LICENSEKEY=${HZ_LICENSEKEY:-}
      - FRAMEWORK_PERSISTENCE_ENABLED=true
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/ecommerce
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
    depends_on:
      hazelcast-1:
        condition: service_healthy
      hazelcast-2:
        condition: service_healthy
      hazelcast-3:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1536M

  # ============================================
  # Nginx Load Balancer for order-service replicas
  # ============================================

  order-lb:
    image: nginx:1.25-alpine
    container_name: order-lb
    hostname: order-lb
    networks:
      - ecommerce-network
    volumes:
      - ./nginx/order-lb.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      order-service:
        condition: service_healthy
      order-service-2:
        condition: service_healthy
      order-service-3:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8083/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 64M

  # ============================================
  # Override API Gateway to route through load balancer
  # ============================================

  api-gateway:
    environment:
      - ORDER_SERVICE_URL=http://order-lb:8083
