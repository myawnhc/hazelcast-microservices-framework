spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        # Account Service
        - id: account-service
          uri: ${ACCOUNT_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/customers/**
          filters:
            - name: CircuitBreaker
              args:
                name: account-service
                fallbackUri: forward:/fallback/account-service

        # Inventory Service
        - id: inventory-service
          uri: ${INVENTORY_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/products/**
          filters:
            - name: CircuitBreaker
              args:
                name: inventory-service
                fallbackUri: forward:/fallback/inventory-service

        - id: inventory-saga
          uri: ${INVENTORY_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/saga/inventory/**
          filters:
            - name: CircuitBreaker
              args:
                name: inventory-service
                fallbackUri: forward:/fallback/inventory-service

        # Order Service
        - id: order-service
          uri: ${ORDER_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/orders/**
          filters:
            - name: CircuitBreaker
              args:
                name: order-service
                fallbackUri: forward:/fallback/order-service

        - id: order-sagas
          uri: ${ORDER_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/sagas/**
          filters:
            - name: CircuitBreaker
              args:
                name: order-service
                fallbackUri: forward:/fallback/order-service

        - id: order-metrics
          uri: ${ORDER_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/metrics/**
          filters:
            - name: CircuitBreaker
              args:
                name: order-service
                fallbackUri: forward:/fallback/order-service

        # Payment Service
        - id: payment-service
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/payments/**
          filters:
            - name: CircuitBreaker
              args:
                name: payment-service
                fallbackUri: forward:/fallback/payment-service

        - id: payment-saga
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/saga/payment/**
          filters:
            - name: CircuitBreaker
              args:
                name: payment-service
                fallbackUri: forward:/fallback/payment-service

      # CORS configuration for browser-based clients
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins:
              - "http://localhost:3000"
              - "http://localhost:5173"
              - "http://localhost:8080"
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowed-headers: "*"
            exposed-headers:
              - X-Correlation-ID
              - X-Response-Time
              - X-RateLimit-Limit
              - X-RateLimit-Remaining
            allow-credentials: true
            max-age: 3600

# Security (disabled by default â€” set to true to enable JWT validation)
framework:
  security:
    enabled: false

# Rate limiting
gateway:
  rate-limit:
    enabled: true
    read-limit: 100     # GET/HEAD requests per second per client IP
    write-limit: 20     # POST/PUT/DELETE/PATCH requests per second per client IP
  health:
    timeout: 3s

server:
  port: 8080

# Resilience4j circuit breaker configuration
resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
    instances:
      account-service:
        base-config: default
      inventory-service:
        base-config: default
      order-service:
        base-config: default
      payment-service:
        base-config: default
  timelimiter:
    configs:
      default:
        timeout-duration: 5s
    instances:
      account-service:
        base-config: default
      inventory-service:
        base-config: default
      order-service:
        base-config: default
      payment-service:
        base-config: default

# Actuator and metrics configuration
management:
  endpoints:
    web:
      exposure:
        include: health,prometheus,metrics,info
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

# Logging configuration
logging:
  level:
    root: INFO
    com.theyawns: DEBUG
    org.springframework.cloud.gateway: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
