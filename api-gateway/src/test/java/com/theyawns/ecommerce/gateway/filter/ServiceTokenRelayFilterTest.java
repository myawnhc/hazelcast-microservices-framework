package com.theyawns.ecommerce.gateway.filter;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.http.HttpHeaders;
import org.springframework.mock.http.server.reactive.MockServerHttpRequest;
import org.springframework.mock.web.server.MockServerWebExchange;
import reactor.core.publisher.Mono;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

/**
 * Unit tests for {@link ServiceTokenRelayFilter}.
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
@DisplayName("ServiceTokenRelayFilter - JWT token relay to downstream services")
class ServiceTokenRelayFilterTest {

    private ServiceTokenRelayFilter filter;
    private GatewayFilterChain chain;

    @BeforeEach
    void setUp() {
        filter = new ServiceTokenRelayFilter();
        chain = mock(GatewayFilterChain.class);
        when(chain.filter(any())).thenReturn(Mono.empty());
    }

    @Test
    @DisplayName("should propagate Bearer token to downstream service")
    void shouldPropagateBearerToken() {
        final String token = "Bearer eyJhbGciOiJSUzI1NiJ9.test-jwt-token";
        final MockServerWebExchange exchange = MockServerWebExchange.from(
                MockServerHttpRequest.get("/api/orders")
                        .header(HttpHeaders.AUTHORIZATION, token)
                        .build());

        filter.filter(exchange, chain).block();

        verify(chain).filter(any());
    }

    @Test
    @DisplayName("should pass through when no Authorization header present")
    void shouldPassThroughWhenNoAuthHeader() {
        final MockServerWebExchange exchange = MockServerWebExchange.from(
                MockServerHttpRequest.get("/api/orders").build());

        filter.filter(exchange, chain).block();

        verify(chain).filter(any());
    }

    @Test
    @DisplayName("should pass through when Authorization is not Bearer")
    void shouldPassThroughWhenNotBearer() {
        final MockServerWebExchange exchange = MockServerWebExchange.from(
                MockServerHttpRequest.get("/api/orders")
                        .header(HttpHeaders.AUTHORIZATION, "Basic dXNlcjpwYXNz")
                        .build());

        filter.filter(exchange, chain).block();

        verify(chain).filter(any());
    }

    @Test
    @DisplayName("should have order -3 (after CorrelationIdFilter)")
    void shouldHaveCorrectOrder() {
        assertThat(filter.getOrder()).isEqualTo(-3);
    }

    @Test
    @DisplayName("should run after CorrelationIdFilter")
    void shouldRunAfterCorrelationIdFilter() {
        final CorrelationIdFilter correlationFilter = new CorrelationIdFilter();
        assertThat(filter.getOrder()).isGreaterThan(correlationFilter.getOrder());
    }
}
