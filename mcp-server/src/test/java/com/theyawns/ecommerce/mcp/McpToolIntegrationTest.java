package com.theyawns.ecommerce.mcp;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.theyawns.ecommerce.mcp.client.ServiceClientOperations;
import com.theyawns.ecommerce.mcp.config.McpServerProperties;
import com.theyawns.ecommerce.mcp.config.McpToolConfig;
import com.theyawns.ecommerce.mcp.tools.GetEventHistoryTool;
import com.theyawns.ecommerce.mcp.tools.GetMetricsTool;
import com.theyawns.ecommerce.mcp.tools.InspectSagaTool;
import com.theyawns.ecommerce.mcp.tools.ListSagasTool;
import com.theyawns.ecommerce.mcp.tools.QueryViewTool;
import com.theyawns.ecommerce.mcp.tools.RunDemoTool;
import com.theyawns.ecommerce.mcp.tools.SubmitEventTool;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.ai.tool.ToolCallbackProvider;
import org.springframework.boot.autoconfigure.AutoConfigurations;
import org.springframework.boot.test.context.runner.ApplicationContextRunner;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

/**
 * Integration tests for MCP tool wiring and end-to-end execution.
 *
 * <p>Verifies that all MCP tool beans are created correctly by Spring,
 * the {@link McpToolConfig} registers all 7 tools with the
 * {@link ToolCallbackProvider}, and tools produce correct output when
 * invoked through the full bean dependency chain.
 *
 * <p>Uses {@link ApplicationContextRunner} to avoid starting the stdio
 * MCP transport, which would block in a test environment.
 *
 * @author Generated by Claude Code
 * @since 2.0
 */
@DisplayName("MCP Tool Integration")
class McpToolIntegrationTest {

    private final ObjectMapper objectMapper = new ObjectMapper();

    private final ApplicationContextRunner contextRunner = new ApplicationContextRunner()
            .withConfiguration(AutoConfigurations.of(McpToolConfig.class))
            .withUserConfiguration(TestServiceClientConfig.class)
            .withBean(McpServerProperties.class);

    @Test
    @DisplayName("should create all 7 tool beans")
    void shouldCreateAllToolBeans() {
        contextRunner.run(context -> {
            assertThat(context).hasSingleBean(QueryViewTool.class);
            assertThat(context).hasSingleBean(SubmitEventTool.class);
            assertThat(context).hasSingleBean(GetEventHistoryTool.class);
            assertThat(context).hasSingleBean(InspectSagaTool.class);
            assertThat(context).hasSingleBean(ListSagasTool.class);
            assertThat(context).hasSingleBean(GetMetricsTool.class);
            assertThat(context).hasSingleBean(RunDemoTool.class);
        });
    }

    @Test
    @DisplayName("should register ToolCallbackProvider with all tools")
    void shouldRegisterToolCallbackProvider() {
        contextRunner.run(context -> {
            assertThat(context).hasSingleBean(ToolCallbackProvider.class);
            ToolCallbackProvider provider = context.getBean(ToolCallbackProvider.class);
            assertThat(provider.getToolCallbacks()).hasSize(7);
        });
    }

    @Test
    @DisplayName("should wire ServiceClientOperations into all tools")
    void shouldWireServiceClient() {
        contextRunner.run(context -> {
            assertThat(context).hasSingleBean(ServiceClientOperations.class);

            // Each tool should be created (proves ServiceClientOperations was injected)
            assertThat(context.getBean(QueryViewTool.class)).isNotNull();
            assertThat(context.getBean(SubmitEventTool.class)).isNotNull();
            assertThat(context.getBean(GetEventHistoryTool.class)).isNotNull();
            assertThat(context.getBean(InspectSagaTool.class)).isNotNull();
            assertThat(context.getBean(ListSagasTool.class)).isNotNull();
            assertThat(context.getBean(GetMetricsTool.class)).isNotNull();
            assertThat(context.getBean(RunDemoTool.class)).isNotNull();
        });
    }

    @Test
    @DisplayName("should execute queryView end-to-end returning formatted JSON")
    void shouldExecuteQueryViewEndToEnd() {
        contextRunner.run(context -> {
            QueryViewTool tool = context.getBean(QueryViewTool.class);
            String result = tool.queryView("customer", "c1", null);

            Map<String, Object> parsed = parseJson(result);
            assertThat(parsed).containsKey("customerId");
            assertThat(parsed.get("name")).isEqualTo("Test Customer");
        });
    }

    @Test
    @DisplayName("should execute listSagas end-to-end returning formatted JSON")
    void shouldExecuteListSagasEndToEnd() {
        contextRunner.run(context -> {
            ListSagasTool tool = context.getBean(ListSagasTool.class);
            String result = tool.listSagas("COMPLETED", 5);

            Map<String, Object> parsed = parseJson(result);
            assertThat(parsed.get("status")).isEqualTo("COMPLETED");
            assertThat(parsed).containsKey("count");
            assertThat(parsed).containsKey("sagas");
        });
    }

    @Test
    @DisplayName("should execute getMetrics end-to-end returning formatted JSON")
    void shouldExecuteGetMetricsEndToEnd() {
        contextRunner.run(context -> {
            GetMetricsTool tool = context.getBean(GetMetricsTool.class);
            String result = tool.getMetrics();

            Map<String, Object> parsed = parseJson(result);
            assertThat(parsed).containsKey("totalSagas");
            assertThat(parsed).containsKey("activeSagas");
        });
    }

    @Test
    @DisplayName("should execute inspectSaga end-to-end returning formatted JSON")
    void shouldExecuteInspectSagaEndToEnd() {
        contextRunner.run(context -> {
            InspectSagaTool tool = context.getBean(InspectSagaTool.class);
            String result = tool.inspectSaga("saga-123");

            Map<String, Object> parsed = parseJson(result);
            assertThat(parsed.get("sagaId")).isEqualTo("saga-123");
            assertThat(parsed.get("status")).isEqualTo("COMPLETED");
        });
    }

    @Test
    @DisplayName("should execute getEventHistory end-to-end returning formatted JSON")
    void shouldExecuteGetEventHistoryEndToEnd() {
        contextRunner.run(context -> {
            GetEventHistoryTool tool = context.getBean(GetEventHistoryTool.class);
            String result = tool.getEventHistory("o1", "Order", 10);

            Map<String, Object> parsed = parseJson(result);
            assertThat(parsed.get("aggregateType")).isEqualTo("Order");
            assertThat(parsed.get("aggregateId")).isEqualTo("o1");
            assertThat(parsed).containsKey("events");
        });
    }

    @Test
    @DisplayName("should execute submitEvent end-to-end returning formatted JSON")
    void shouldExecuteSubmitEventEndToEnd() {
        contextRunner.run(context -> {
            SubmitEventTool tool = context.getBean(SubmitEventTool.class);
            String payload = "{\"name\":\"Test\",\"email\":\"test@example.com\",\"address\":\"123 St\"}";
            String result = tool.submitEvent("CreateCustomer", payload);

            Map<String, Object> parsed = parseJson(result);
            assertThat(parsed.get("eventType")).isEqualTo("CreateCustomer");
            assertThat(parsed).containsKey("result");
        });
    }

    @Test
    @DisplayName("should execute runDemo end-to-end returning scenario results")
    void shouldExecuteRunDemoEndToEnd() {
        contextRunner.run(context -> {
            RunDemoTool tool = context.getBean(RunDemoTool.class);
            String result = tool.runDemo("happy_path");

            Map<String, Object> parsed = parseJson(result);
            assertThat(parsed.get("scenario")).isEqualTo("happy_path");
            assertThat(parsed).containsKey("steps");
        });
    }

    private Map<String, Object> parseJson(String json) throws JsonProcessingException {
        return objectMapper.readValue(json, new TypeReference<>() {});
    }

    /**
     * Test configuration providing a mock {@link ServiceClientOperations}
     * with pre-configured responses for integration testing.
     */
    @Configuration
    static class TestServiceClientConfig {

        @Bean
        ServiceClientOperations serviceClient() {
            ServiceClientOperations mock = mock(ServiceClientOperations.class);

            // queryView responses
            when(mock.getEntity("customer", "c1")).thenReturn(Map.of(
                    "customerId", "c1",
                    "name", "Test Customer",
                    "email", "test@example.com"
            ));
            when(mock.listEntities(eq("customer"), eq(10))).thenReturn(List.of(
                    Map.of("customerId", "c1", "name", "Test Customer")
            ));

            // saga responses
            when(mock.getSaga("saga-123")).thenReturn(Map.of(
                    "sagaId", "saga-123",
                    "status", "COMPLETED",
                    "steps", List.of("StockReserved", "PaymentProcessed")
            ));
            when(mock.listSagas(eq("COMPLETED"), eq(5))).thenReturn(List.of(
                    Map.of("sagaId", "saga-123", "status", "COMPLETED")
            ));

            // metrics response
            when(mock.getMetricsSummary()).thenReturn(Map.of(
                    "totalSagas", 42,
                    "activeSagas", 3,
                    "eventsProcessed", 1250
            ));

            // event history response
            when(mock.getEventHistory("order", "o1", 10)).thenReturn(List.of(
                    Map.of("eventType", "OrderCreated", "timestamp", "2026-01-01T00:00:00Z"),
                    Map.of("eventType", "StockReserved", "timestamp", "2026-01-01T00:00:01Z")
            ));

            // create entity responses (for submitEvent and runDemo)
            when(mock.createEntity(eq("customer"), any())).thenReturn(Map.of(
                    "customerId", "c-new",
                    "name", "Test"
            ));
            when(mock.createEntity(eq("product"), any())).thenReturn(Map.of(
                    "productId", "p-new",
                    "name", "Widget"
            ));
            when(mock.createEntity(eq("order"), any())).thenReturn(Map.of(
                    "orderId", "o-new",
                    "status", "PENDING"
            ));

            return mock;
        }

        @Bean
        QueryViewTool queryViewTool(ServiceClientOperations client) {
            return new QueryViewTool(client);
        }

        @Bean
        SubmitEventTool submitEventTool(ServiceClientOperations client) {
            return new SubmitEventTool(client);
        }

        @Bean
        GetEventHistoryTool getEventHistoryTool(ServiceClientOperations client) {
            return new GetEventHistoryTool(client);
        }

        @Bean
        InspectSagaTool inspectSagaTool(ServiceClientOperations client) {
            return new InspectSagaTool(client);
        }

        @Bean
        ListSagasTool listSagasTool(ServiceClientOperations client) {
            return new ListSagasTool(client);
        }

        @Bean
        GetMetricsTool getMetricsTool(ServiceClientOperations client) {
            return new GetMetricsTool(client);
        }

        @Bean
        RunDemoTool runDemoTool(ServiceClientOperations client) {
            return new RunDemoTool(client);
        }
    }
}
