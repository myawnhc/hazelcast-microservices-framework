package com.theyawns.ecommerce.mcp.security;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * Tests for {@link McpSecurityProperties}.
 *
 * @author Generated by Claude Code
 * @since 3.0
 */
@DisplayName("McpSecurityProperties")
class McpSecurityPropertiesTest {

    private McpSecurityProperties properties;

    @BeforeEach
    void setUp() {
        properties = new McpSecurityProperties();
    }

    @Test
    @DisplayName("should default to disabled")
    void shouldDefaultToDisabled() {
        assertThat(properties.isEnabled()).isFalse();
    }

    @Test
    @DisplayName("should default api key env var to MCP_API_KEY")
    void shouldDefaultApiKeyEnvVar() {
        assertThat(properties.getApiKeyEnvVar()).isEqualTo("MCP_API_KEY");
    }

    @Test
    @DisplayName("should default to empty api keys map")
    void shouldDefaultToEmptyApiKeys() {
        assertThat(properties.getApiKeys()).isEmpty();
    }

    @Test
    @DisplayName("should resolve VIEWER role from api key")
    void shouldResolveViewerRole() {
        properties.setApiKeys(Map.of("my-viewer-key", "VIEWER"));

        assertThat(properties.resolveRole("my-viewer-key")).isEqualTo(McpRole.VIEWER);
    }

    @Test
    @DisplayName("should resolve OPERATOR role from api key")
    void shouldResolveOperatorRole() {
        properties.setApiKeys(Map.of("my-operator-key", "OPERATOR"));

        assertThat(properties.resolveRole("my-operator-key")).isEqualTo(McpRole.OPERATOR);
    }

    @Test
    @DisplayName("should resolve ADMIN role from api key")
    void shouldResolveAdminRole() {
        properties.setApiKeys(Map.of("my-admin-key", "ADMIN"));

        assertThat(properties.resolveRole("my-admin-key")).isEqualTo(McpRole.ADMIN);
    }

    @Test
    @DisplayName("should resolve role case-insensitively")
    void shouldResolveRoleCaseInsensitively() {
        properties.setApiKeys(Map.of("key1", "viewer", "key2", "Operator"));

        assertThat(properties.resolveRole("key1")).isEqualTo(McpRole.VIEWER);
        assertThat(properties.resolveRole("key2")).isEqualTo(McpRole.OPERATOR);
    }

    @Test
    @DisplayName("should return null for unknown api key")
    void shouldReturnNullForUnknownKey() {
        properties.setApiKeys(Map.of("known-key", "ADMIN"));

        assertThat(properties.resolveRole("unknown-key")).isNull();
    }

    @Test
    @DisplayName("should return null for null api key")
    void shouldReturnNullForNullKey() {
        assertThat(properties.resolveRole(null)).isNull();
    }

    @Test
    @DisplayName("should return null for blank api key")
    void shouldReturnNullForBlankKey() {
        assertThat(properties.resolveRole("  ")).isNull();
    }

    @Test
    @DisplayName("should return null for invalid role name in config")
    void shouldReturnNullForInvalidRoleName() {
        properties.setApiKeys(Map.of("bad-key", "SUPERUSER"));

        assertThat(properties.resolveRole("bad-key")).isNull();
    }

    @Test
    @DisplayName("toString should not expose api key values")
    void toStringShouldNotExposeKeys() {
        properties.setApiKeys(Map.of("secret-key-123", "ADMIN"));

        String result = properties.toString();

        assertThat(result).doesNotContain("secret-key-123");
        assertThat(result).contains("1 configured");
    }
}
