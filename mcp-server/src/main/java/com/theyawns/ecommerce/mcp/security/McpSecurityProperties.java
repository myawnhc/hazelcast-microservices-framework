package com.theyawns.ecommerce.mcp.security;

import org.springframework.boot.context.properties.ConfigurationProperties;

import java.util.HashMap;
import java.util.Map;

/**
 * Configuration properties for MCP server security.
 *
 * <p>Controls API key authentication and role-based tool access. Security is
 * <strong>disabled by default</strong> to preserve backward compatibility.
 *
 * <p>Example configuration:
 * <pre>{@code
 * mcp:
 *   security:
 *     enabled: true
 *     api-keys:
 *       viewer-key-12345: VIEWER
 *       operator-key-67890: OPERATOR
 *       admin-key-99999: ADMIN
 * }</pre>
 *
 * <p>For stdio mode, the API key is read from the {@code MCP_API_KEY} environment
 * variable. For HTTP/SSE mode, it is read from the {@code X-API-Key} request header.
 *
 * @author Generated by Claude Code
 * @since 3.0
 * @see McpRole
 * @see ToolAuthorizer
 */
@ConfigurationProperties(prefix = "mcp.security")
public class McpSecurityProperties {

    /**
     * Whether MCP security (API key authentication) is enabled.
     * Default: false (all tools accessible without authentication).
     */
    private boolean enabled = false;

    /**
     * Map of API key to role name. Each key string maps to a {@link McpRole} value.
     * Example: {@code {"my-viewer-key": "VIEWER", "my-operator-key": "OPERATOR"}}
     */
    private Map<String, String> apiKeys = new HashMap<>();

    /**
     * Environment variable name for the API key in stdio mode.
     * Default: {@code MCP_API_KEY}.
     */
    private String apiKeyEnvVar = "MCP_API_KEY";

    /**
     * Creates a new McpSecurityProperties with default values.
     */
    public McpSecurityProperties() {
        // Default constructor
    }

    /**
     * Returns whether MCP security is enabled.
     *
     * @return true if API key authentication is enabled
     */
    public boolean isEnabled() {
        return enabled;
    }

    /**
     * Sets whether MCP security is enabled.
     *
     * @param enabled true to enable API key authentication
     */
    public void setEnabled(final boolean enabled) {
        this.enabled = enabled;
    }

    /**
     * Returns the API key to role mapping.
     *
     * @return map of API key strings to role name strings
     */
    public Map<String, String> getApiKeys() {
        return apiKeys;
    }

    /**
     * Sets the API key to role mapping.
     *
     * @param apiKeys map of API key strings to role name strings
     */
    public void setApiKeys(final Map<String, String> apiKeys) {
        this.apiKeys = apiKeys;
    }

    /**
     * Returns the environment variable name for the API key in stdio mode.
     *
     * @return the environment variable name
     */
    public String getApiKeyEnvVar() {
        return apiKeyEnvVar;
    }

    /**
     * Sets the environment variable name for the API key in stdio mode.
     *
     * @param apiKeyEnvVar the environment variable name
     */
    public void setApiKeyEnvVar(final String apiKeyEnvVar) {
        this.apiKeyEnvVar = apiKeyEnvVar;
    }

    /**
     * Resolves a role from an API key.
     *
     * @param apiKey the API key to look up
     * @return the resolved {@link McpRole}, or null if the key is not found
     */
    public McpRole resolveRole(final String apiKey) {
        if (apiKey == null || apiKey.isBlank()) {
            return null;
        }
        String roleName = apiKeys.get(apiKey);
        if (roleName == null) {
            return null;
        }
        try {
            return McpRole.valueOf(roleName.toUpperCase());
        } catch (IllegalArgumentException e) {
            return null;
        }
    }

    @Override
    public String toString() {
        return "McpSecurityProperties{" +
                "enabled=" + enabled +
                ", apiKeys=[" + apiKeys.size() + " configured]" +
                ", apiKeyEnvVar='" + apiKeyEnvVar + '\'' +
                '}';
    }
}
