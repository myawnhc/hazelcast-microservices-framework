openapi: 3.0.3
info:
  title: Order Service API
  description: |
    Order management service for the Hazelcast Event Sourcing Framework.

    This service manages the order lifecycle using event sourcing patterns:
    - Order creation triggers an `OrderCreatedEvent`
    - Confirmation triggers `OrderConfirmedEvent`
    - Cancellation triggers `OrderCancelledEvent`
    - Shipping triggers `OrderShippedEvent`

    **Key Features:**
    - Orders are enriched with customer and product data from materialized views
    - No synchronous service calls required for data enrichment
    - Customer order summaries maintained via cross-service views

    **Order Status Flow:**
    ```
    PENDING -> CONFIRMED -> SHIPPED -> DELIVERED
                  |
                  v
              CANCELLED
    ```
  version: 1.0.0
  contact:
    name: API Support
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:8083
    description: Local development server
  - url: http://order-service:8083
    description: Docker Compose internal

tags:
  - name: Order Management
    description: APIs for managing customer orders
  - name: Saga Management
    description: APIs for inspecting saga state
  - name: Metrics
    description: APIs for system metrics

paths:
  /api/orders:
    post:
      tags:
        - Order Management
      summary: Create a new order
      description: |
        Places a new order for a customer.
        Creates an `OrderCreatedEvent` which:
        1. Stores the order in the event store
        2. Creates an enriched order view with customer and product names
        3. Updates customer order summary

        **Note:** Stock reservation should be done separately via Inventory Service.
      operationId: createOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderRequest'
            example:
              customerId: cust-12345-uuid
              lineItems:
                - productId: prod-12345-uuid
                  quantity: 2
                  unitPrice: 1299.99
              shippingAddress: 123 Main Street, Anytown, USA
      responses:
        '201':
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
              example:
                orderId: order-12345-uuid
                customerId: cust-12345-uuid
                customerName: Alice Smith
                customerEmail: alice@example.com
                lineItems:
                  - productId: prod-12345-uuid
                    productName: Gaming Laptop
                    sku: LAPTOP-001
                    quantity: 2
                    unitPrice: 1299.99
                    lineTotal: 2599.98
                subtotal: 2599.98
                tax: 259.998
                total: 2859.978
                shippingAddress: 123 Main Street, Anytown, USA
                status: PENDING
        '400':
          description: Invalid order data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Order Management
      summary: List orders
      description: |
        Lists all orders from the materialized view.
        Returns the most recent orders up to the specified limit.
      operationId: listOrders
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of orders to return
          schema:
            type: integer
            default: 10
            minimum: 1
          example: 10
      responses:
        '200':
          description: Orders retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Order'

  /api/orders/{orderId}:
    get:
      tags:
        - Order Management
      summary: Get order by ID
      description: |
        Retrieves order details including enriched customer and product data.
        Returns data from the enriched order materialized view.
      operationId: getOrder
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
          example: order-12345-uuid
      responses:
        '200':
          description: Order found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '404':
          description: Order not found

  /api/orders/customer/{customerId}:
    get:
      tags:
        - Order Management
      summary: Get orders by customer
      description: |
        Retrieves all orders for a specific customer.
        Uses the customer order summary materialized view for efficient lookup.
      operationId: getOrdersByCustomer
      parameters:
        - name: customerId
          in: path
          required: true
          description: Customer identifier
          schema:
            type: string
          example: cust-12345-uuid
      responses:
        '200':
          description: Orders retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Order'

  /api/orders/{orderId}/confirm:
    patch:
      tags:
        - Order Management
      summary: Confirm order
      description: |
        Confirms an order for fulfillment.
        Creates an `OrderConfirmedEvent` which:
        - Updates order status to CONFIRMED
        - Generates a confirmation number

        **Prerequisites:**
        - Order must be in PENDING status
        - Stock should already be reserved
      operationId: confirmOrder
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
      responses:
        '200':
          description: Order confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '400':
          description: Order cannot be confirmed (wrong status)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: 'Order cannot be confirmed: current status is CANCELLED'
                code: INVALID_STATE_TRANSITION
        '404':
          description: Order not found

  /api/orders/{orderId}/cancel:
    patch:
      tags:
        - Order Management
      summary: Cancel order
      description: |
        Cancels an order and releases reserved stock.
        Creates an `OrderCancelledEvent` which:
        - Updates order status to CANCELLED
        - Records cancellation reason and actor

        **Note:** Stock release should be done separately via Inventory Service.

        **Allowed from statuses:** PENDING, CONFIRMED
      operationId: cancelOrder
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelOrderRequest'
            example:
              reason: Customer changed their mind
              cancelledBy: customer
      responses:
        '200':
          description: Order cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '400':
          description: Order cannot be cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Order not found

  /api/orders/{orderId}/events:
    get:
      tags:
        - Order Management
      summary: Get order event history
      description: |
        Retrieves the event history for an order from the event store.
        Returns events in chronological order, useful for auditing and debugging.
      operationId: getOrderEventHistory
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
          example: order-12345-uuid
        - name: limit
          in: query
          required: false
          description: Maximum number of events to return
          schema:
            type: integer
            default: 20
            minimum: 1
          example: 20
      responses:
        '200':
          description: Event history retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Event'

  /api/sagas/{sagaId}:
    get:
      tags:
        - Saga Management
      summary: Get saga by ID
      description: |
        Retrieves the current state of a saga instance, including all step records.
        Useful for monitoring saga progress and debugging failures.
      operationId: getSaga
      parameters:
        - name: sagaId
          in: path
          required: true
          description: Unique saga identifier
          schema:
            type: string
          example: saga-12345-uuid
      responses:
        '200':
          description: Saga found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SagaState'
        '404':
          description: Saga not found

  /api/sagas:
    get:
      tags:
        - Saga Management
      summary: List sagas
      description: |
        Lists sagas, optionally filtered by status and/or type.
        Without filters, returns all sagas across all statuses.
      operationId: listSagas
      parameters:
        - name: status
          in: query
          required: false
          description: Filter by saga status
          schema:
            type: string
            enum: [STARTED, IN_PROGRESS, COMPLETED, COMPENSATING, COMPENSATED, FAILED, TIMED_OUT]
        - name: type
          in: query
          required: false
          description: Filter by saga type
          schema:
            type: string
          example: OrderFulfillment
        - name: limit
          in: query
          required: false
          description: Maximum number of results
          schema:
            type: integer
            default: 10
            minimum: 1
          example: 10
      responses:
        '200':
          description: Sagas retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SagaState'
        '400':
          description: Invalid status value

  /api/metrics/summary:
    get:
      tags:
        - Metrics
      summary: Get metrics summary
      description: |
        Returns aggregated saga and event metrics for the system.
        Combines data from the SagaStateStore and Micrometer registry.

        Includes:
        - Saga counts by status (started, in-progress, completed, failed, etc.)
        - Event counters (submitted, processed, failed)
        - Active saga gauges
      operationId: getMetricsSummary
      responses:
        '200':
          description: Metrics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsSummary'
              example:
                sagas:
                  total: 42
                  started: 2
                  inProgress: 5
                  completed: 30
                  compensating: 1
                  compensated: 2
                  failed: 1
                  timedOut: 1
                events:
                  eventsSubmitted: 150.0
                  eventsProcessed: 148.0
                  eventsFailed: 2.0
                gauges:
                  activeSagas: 7.0
                  compensatingSagas: 1.0

components:
  schemas:
    OrderRequest:
      type: object
      required:
        - customerId
        - lineItems
      properties:
        customerId:
          type: string
          description: Customer placing the order
          example: cust-12345-uuid
        lineItems:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/OrderLineItemRequest'
        shippingAddress:
          type: string
          description: Shipping address for the order
          example: 123 Main Street, Anytown, USA

    OrderLineItemRequest:
      type: object
      required:
        - productId
        - quantity
        - unitPrice
      properties:
        productId:
          type: string
          description: Product identifier
          example: prod-12345-uuid
        quantity:
          type: integer
          minimum: 1
          description: Quantity ordered
          example: 2
        unitPrice:
          type: number
          format: decimal
          minimum: 0.01
          description: Price per unit at time of order
          example: 1299.99

    Order:
      type: object
      properties:
        orderId:
          type: string
          description: Unique order identifier
          example: order-12345-uuid
        customerId:
          type: string
          description: Customer identifier
          example: cust-12345-uuid
        customerName:
          type: string
          description: Customer name (enriched from customer view)
          example: Alice Smith
        customerEmail:
          type: string
          description: Customer email (enriched from customer view)
          example: alice@example.com
        lineItems:
          type: array
          items:
            $ref: '#/components/schemas/OrderLineItem'
        subtotal:
          type: number
          format: decimal
          description: Sum of line item totals
          example: 2599.98
        tax:
          type: number
          format: decimal
          description: Tax amount (10% of subtotal)
          example: 259.998
        total:
          type: number
          format: decimal
          description: Total order amount (subtotal + tax)
          example: 2859.978
        shippingAddress:
          type: string
          description: Shipping address
          example: 123 Main Street, Anytown, USA
        status:
          type: string
          enum: [PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED]
          description: Order status
          example: PENDING
        createdAt:
          type: string
          format: date-time
          description: Order creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp

    OrderLineItem:
      type: object
      properties:
        productId:
          type: string
          description: Product identifier
          example: prod-12345-uuid
        productName:
          type: string
          description: Product name (enriched from product view)
          example: Gaming Laptop
        sku:
          type: string
          description: Product SKU (enriched from product view)
          example: LAPTOP-001
        quantity:
          type: integer
          description: Quantity ordered
          example: 2
        unitPrice:
          type: number
          format: decimal
          description: Price per unit
          example: 1299.99
        lineTotal:
          type: number
          format: decimal
          description: Line total (quantity * unitPrice)
          example: 2599.98

    CancelOrderRequest:
      type: object
      required:
        - reason
        - cancelledBy
      properties:
        reason:
          type: string
          description: Reason for cancellation
          example: Customer changed their mind
        cancelledBy:
          type: string
          description: Who cancelled (customer, system, admin)
          example: customer

    Event:
      type: object
      description: A domain event from the event store
      additionalProperties: true
      properties:
        eventType:
          type: string
          description: Type of event
          example: OrderCreatedEvent
        entityId:
          type: string
          description: Entity this event belongs to
          example: order-12345-uuid
        timestamp:
          type: string
          format: date-time
          description: When the event occurred

    SagaState:
      type: object
      properties:
        sagaId:
          type: string
          description: Unique saga identifier
          example: saga-12345-uuid
        sagaType:
          type: string
          description: Type of saga
          example: OrderFulfillment
        correlationId:
          type: string
          description: Correlation ID linking the saga to the originating event
          example: order-12345-uuid
        status:
          type: string
          enum: [STARTED, IN_PROGRESS, COMPLETED, COMPENSATING, COMPENSATED, FAILED, TIMED_OUT]
          description: Current saga status
          example: COMPLETED
        currentStep:
          type: integer
          description: Current step number (0-based)
          example: 3
        totalSteps:
          type: integer
          description: Total number of steps in the saga
          example: 3
        progressPercentage:
          type: integer
          description: Progress as a percentage (0-100)
          example: 100
        startedAt:
          type: string
          format: date-time
          description: When the saga started
        completedAt:
          type: string
          format: date-time
          nullable: true
          description: When the saga completed (null if still running)
        durationMs:
          type: integer
          description: Duration in milliseconds
          example: 245
        deadline:
          type: string
          format: date-time
          nullable: true
          description: Saga timeout deadline
        failureReason:
          type: string
          nullable: true
          description: Reason for failure (null if successful)
        failedAtStep:
          type: string
          nullable: true
          description: Step name where the saga failed
        steps:
          type: array
          items:
            $ref: '#/components/schemas/SagaStep'

    SagaStep:
      type: object
      properties:
        stepNumber:
          type: integer
          description: Step number in the saga (0-based)
          example: 0
        stepName:
          type: string
          description: Human-readable step name
          example: ReserveStock
        service:
          type: string
          description: Service responsible for this step
          example: inventory-service
        eventType:
          type: string
          description: Event type that triggers or completes this step
          example: StockReservedEvent
        status:
          type: string
          enum: [PENDING, IN_PROGRESS, COMPLETED, FAILED, COMPENSATED]
          description: Step status
          example: COMPLETED
        timestamp:
          type: string
          format: date-time
          nullable: true
          description: When the step completed
        eventId:
          type: string
          nullable: true
          description: ID of the event that completed this step
        failureReason:
          type: string
          nullable: true
          description: Reason for step failure

    MetricsSummary:
      type: object
      properties:
        sagas:
          type: object
          properties:
            total:
              type: integer
              description: Total number of sagas
            started:
              type: integer
              description: Sagas in STARTED status
            inProgress:
              type: integer
              description: Sagas in IN_PROGRESS status
            completed:
              type: integer
              description: Sagas in COMPLETED status
            compensating:
              type: integer
              description: Sagas in COMPENSATING status
            compensated:
              type: integer
              description: Sagas in COMPENSATED status
            failed:
              type: integer
              description: Sagas in FAILED status
            timedOut:
              type: integer
              description: Sagas in TIMED_OUT status
        events:
          type: object
          properties:
            eventsSubmitted:
              type: number
              description: Total events submitted
            eventsProcessed:
              type: number
              description: Total events processed
            eventsFailed:
              type: number
              description: Total events that failed processing
        gauges:
          type: object
          properties:
            activeSagas:
              type: number
              description: Current count of active sagas
            compensatingSagas:
              type: number
              description: Current count of compensating sagas

    Error:
      type: object
      properties:
        message:
          type: string
          description: Error message
        code:
          type: string
          description: Error code
          enum: [INVALID_STATE_TRANSITION, ORDER_NOT_FOUND, INVALID_REQUEST]
