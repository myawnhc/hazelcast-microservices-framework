openapi: 3.0.3
info:
  title: Inventory Service API
  description: |
    Product inventory management service for the Hazelcast Event Sourcing Framework.

    This service manages products and stock levels using event sourcing patterns:
    - Product creation triggers a `ProductCreatedEvent`
    - Stock reservations trigger `StockReservedEvent`
    - Stock releases trigger `StockReleasedEvent`

    Stock levels are tracked as:
    - `quantityOnHand`: Total physical inventory
    - `quantityReserved`: Stock reserved for pending orders
    - `availableQuantity`: `quantityOnHand - quantityReserved`
  version: 1.0.0
  contact:
    name: API Support
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:8082
    description: Local development server
  - url: http://inventory-service:8082
    description: Docker Compose internal

tags:
  - name: Product Inventory
    description: APIs for managing products and stock levels
  - name: Vector Similarity Search
    description: Find similar products using vector embeddings (Enterprise Edition)
  - name: Orchestrated Inventory Operations
    description: Saga orchestrator endpoints for distributed transactions

paths:
  /api/products:
    post:
      tags:
        - Product Inventory
      summary: Create a new product
      description: |
        Adds a new product to the catalog.
        Creates a `ProductCreatedEvent` which flows through the event pipeline.
      operationId: createProduct
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductRequest'
            example:
              sku: LAPTOP-001
              name: Gaming Laptop
              description: High-performance gaming laptop
              price: 1299.99
              quantityOnHand: 50
              category: Electronics
      responses:
        '201':
          description: Product created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
              example:
                productId: prod-12345-uuid
                sku: LAPTOP-001
                name: Gaming Laptop
                description: High-performance gaming laptop
                price: 1299.99
                quantityOnHand: 50
                quantityReserved: 0
                category: Electronics
                status: ACTIVE
        '400':
          description: Invalid product data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Product Inventory
      summary: List products
      description: |
        Lists all products from the materialized view.
        Returns the most recent products up to the specified limit.
      operationId: listProducts
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of products to return
          schema:
            type: integer
            default: 10
            minimum: 1
          example: 10
      responses:
        '200':
          description: Products retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Product'

  /api/products/{productId}:
    get:
      tags:
        - Product Inventory
      summary: Get product by ID
      description: |
        Retrieves product details including current stock levels.
        Returns data from the materialized view.
      operationId: getProduct
      parameters:
        - name: productId
          in: path
          required: true
          description: Unique product identifier
          schema:
            type: string
          example: prod-12345-uuid
      responses:
        '200':
          description: Product found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '404':
          description: Product not found

  /api/products/{productId}/stock/reserve:
    post:
      tags:
        - Product Inventory
      summary: Reserve stock
      description: |
        Reserves product stock for an order.
        Creates a `StockReservedEvent` which increments `quantityReserved`.

        **Validation:**
        - Product must exist
        - Available quantity (`quantityOnHand - quantityReserved`) must be >= requested quantity
      operationId: reserveStock
      parameters:
        - name: productId
          in: path
          required: true
          description: Unique product identifier
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StockReservationRequest'
            example:
              quantity: 2
              orderId: order-12345-uuid
      responses:
        '200':
          description: Stock reserved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '400':
          description: Insufficient stock or invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: 'Insufficient stock: requested 100, available 50'
                code: INSUFFICIENT_STOCK
        '404':
          description: Product not found

  /api/products/{productId}/stock/release:
    post:
      tags:
        - Product Inventory
      summary: Release stock
      description: |
        Releases previously reserved stock back to available inventory.
        Creates a `StockReleasedEvent` which decrements `quantityReserved`.

        Common reasons:
        - Order cancelled
        - Order timeout
        - Payment failed
      operationId: releaseStock
      parameters:
        - name: productId
          in: path
          required: true
          description: Unique product identifier
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StockReleaseRequest'
            example:
              quantity: 2
              orderId: order-12345-uuid
              reason: Order cancelled by customer
      responses:
        '200':
          description: Stock released successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '400':
          description: Invalid request
        '404':
          description: Product not found

  /api/products/{productId}/events:
    get:
      tags:
        - Product Inventory
      summary: Get product event history
      description: |
        Retrieves the event history for a product from the event store.
        Returns events in chronological order, useful for auditing and debugging.
      operationId: getProductEventHistory
      parameters:
        - name: productId
          in: path
          required: true
          description: Unique product identifier
          schema:
            type: string
          example: prod-12345-uuid
        - name: limit
          in: query
          required: false
          description: Maximum number of events to return
          schema:
            type: integer
            default: 20
            minimum: 1
          example: 20
      responses:
        '200':
          description: Event history retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Event'

  /api/products/{productId}/similar:
    get:
      tags:
        - Vector Similarity Search
      summary: Find similar products
      description: |
        Returns products similar to the given product using vector similarity search.

        **Requires Enterprise Edition** with Vector Store enabled. On Community Edition,
        returns an empty list with an informational message indicating the feature
        is unavailable.

        Uses Hazelcast VectorCollection with HNSW indexing for efficient
        nearest-neighbor search on product embedding vectors.
      operationId: findSimilarProducts
      parameters:
        - name: productId
          in: path
          required: true
          description: Product ID to find similar products for
          schema:
            type: string
          example: prod-12345-uuid
        - name: limit
          in: query
          required: false
          description: Maximum number of similar products to return
          schema:
            type: integer
            default: 5
            minimum: 1
          example: 5
      responses:
        '200':
          description: Similar products (may be empty on Community Edition)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimilarProductsResponse'
              examples:
                enterprise:
                  summary: Enterprise Edition (vector store available)
                  value:
                    productId: prod-12345-uuid
                    vectorStoreAvailable: true
                    implementation: HazelcastVectorStoreService
                    message: Found 3 similar products
                    similarProducts:
                      - productId: prod-67890-uuid
                        sku: LAPTOP-002
                        name: Business Laptop
                        price: 999.99
                community:
                  summary: Community Edition (vector store unavailable)
                  value:
                    productId: prod-12345-uuid
                    vectorStoreAvailable: false
                    implementation: NoOpVectorStoreService
                    message: Vector similarity search requires Enterprise Edition. Running on Community Edition â€” no similar products available.
                    similarProducts: []
        '404':
          description: Product not found

  /api/saga/inventory/reserve-stock:
    post:
      tags:
        - Orchestrated Inventory Operations
      summary: Reserve stock (orchestrated saga)
      description: |
        Reserves stock for an order as part of an orchestrated saga.
        Called by the saga orchestrator in order-service via HTTP.
        Returns a standardized step response indicating success or failure.
      operationId: reserveStockOrchestrated
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrchestratedReserveRequest'
            example:
              productId: prod-12345-uuid
              quantity: 2
              orderId: order-12345-uuid
      responses:
        '200':
          description: Step completed (check success field for outcome)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestratedStepResponse'
              example:
                success: true
                data:
                  productId: prod-12345-uuid
                  availableQuantity: 48
                errorMessage: null

  /api/saga/inventory/release-stock:
    post:
      tags:
        - Orchestrated Inventory Operations
      summary: Release stock (saga compensation)
      description: |
        Releases previously reserved stock as a compensation step in an orchestrated saga.
        Called when a downstream saga step fails and the stock reservation must be reversed.
      operationId: releaseStockOrchestrated
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrchestratedReleaseRequest'
            example:
              orderId: order-12345-uuid
              reason: Saga compensation - payment processing failed
      responses:
        '200':
          description: Step completed (check success field for outcome)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestratedStepResponse'

components:
  schemas:
    ProductRequest:
      type: object
      required:
        - sku
        - name
        - price
        - quantityOnHand
      properties:
        sku:
          type: string
          maxLength: 50
          description: Stock Keeping Unit (unique product identifier)
          example: LAPTOP-001
        name:
          type: string
          minLength: 2
          maxLength: 200
          description: Product name
          example: Gaming Laptop
        description:
          type: string
          maxLength: 1000
          description: Product description
          example: High-performance gaming laptop
        price:
          type: number
          format: decimal
          minimum: 0.01
          description: Product price
          example: 1299.99
        quantityOnHand:
          type: integer
          minimum: 0
          description: Initial stock quantity
          example: 50
        category:
          type: string
          description: Product category
          example: Electronics

    Product:
      type: object
      properties:
        productId:
          type: string
          description: Unique product identifier
          example: prod-12345-uuid
        sku:
          type: string
          description: Stock Keeping Unit
          example: LAPTOP-001
        name:
          type: string
          description: Product name
          example: Gaming Laptop
        description:
          type: string
          description: Product description
          example: High-performance gaming laptop
        price:
          type: number
          format: decimal
          description: Product price
          example: 1299.99
        quantityOnHand:
          type: integer
          description: Total physical inventory
          example: 50
        quantityReserved:
          type: integer
          description: Stock reserved for pending orders
          example: 5
        availableQuantity:
          type: integer
          description: Available for new orders (quantityOnHand - quantityReserved)
          example: 45
        category:
          type: string
          description: Product category
          example: Electronics
        status:
          type: string
          enum: [ACTIVE, DISCONTINUED, OUT_OF_STOCK]
          description: Product status
          example: ACTIVE

    StockReservationRequest:
      type: object
      required:
        - quantity
        - orderId
      properties:
        quantity:
          type: integer
          minimum: 1
          description: Quantity to reserve
          example: 2
        orderId:
          type: string
          description: Order ID requesting the reservation
          example: order-12345-uuid

    StockReleaseRequest:
      type: object
      required:
        - quantity
        - orderId
        - reason
      properties:
        quantity:
          type: integer
          minimum: 1
          description: Quantity to release
          example: 2
        orderId:
          type: string
          description: Order ID releasing the stock
          example: order-12345-uuid
        reason:
          type: string
          description: Reason for releasing stock
          example: Order cancelled by customer

    SimilarProductsResponse:
      type: object
      properties:
        productId:
          type: string
          description: The product ID that was queried
          example: prod-12345-uuid
        vectorStoreAvailable:
          type: boolean
          description: Whether the vector store is available (Enterprise feature)
          example: true
        implementation:
          type: string
          description: The vector store implementation type
          example: HazelcastVectorStoreService
        message:
          type: string
          description: Informational message about the result
          example: Found 3 similar products
        similarProducts:
          type: array
          description: List of similar products ordered by similarity score
          items:
            $ref: '#/components/schemas/Product'

    OrchestratedReserveRequest:
      type: object
      properties:
        productId:
          type: string
          description: Product identifier
          example: prod-12345-uuid
        quantity:
          type: integer
          description: Quantity to reserve
          example: 2
        orderId:
          type: string
          description: Order requesting the reservation
          example: order-12345-uuid

    OrchestratedReleaseRequest:
      type: object
      properties:
        orderId:
          type: string
          description: Order whose stock reservation to release
          example: order-12345-uuid
        reason:
          type: string
          description: Reason for releasing stock
          example: Saga compensation - payment processing failed

    OrchestratedStepResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether the step succeeded
          example: true
        data:
          type: object
          additionalProperties: true
          description: Additional data from the step
          example:
            productId: prod-12345-uuid
            availableQuantity: 48
        errorMessage:
          type: string
          nullable: true
          description: Error message if the step failed
          example: null

    Event:
      type: object
      description: A domain event from the event store
      additionalProperties: true
      properties:
        eventType:
          type: string
          description: Type of event
          example: ProductCreatedEvent
        entityId:
          type: string
          description: Entity this event belongs to
          example: prod-12345-uuid
        timestamp:
          type: string
          format: date-time
          description: When the event occurred

    Error:
      type: object
      properties:
        message:
          type: string
          description: Error message
        code:
          type: string
          description: Error code
          enum: [INSUFFICIENT_STOCK, PRODUCT_NOT_FOUND, INVALID_REQUEST]
